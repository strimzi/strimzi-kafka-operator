<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Deploying and Upgrading Strimzi</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body id="deploying-book_str" class="book toc2 toc-left">
<div id="header">
<h1>Deploying and Upgrading Strimzi</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#deploy-intro_str">1. Deployment overview</a>
<ul class="sectlevel2">
<li><a href="#key-features-product_str">1.1. How Strimzi supports Kafka</a></li>
<li><a href="#overview-components_str">1.2. Strimzi Operators</a>
<ul class="sectlevel3">
<li><a href="#overview-components-cluster-operator-str">1.2.1. Cluster Operator</a></li>
<li><a href="#overview-concepts-topic-operator-str">1.2.2. Topic Operator</a></li>
<li><a href="#overview-concepts-user-operator-str">1.2.3. User Operator</a></li>
<li><a href="#con-feature-gates-overview-str">1.2.4. Feature gates in Strimzi Operators</a></li>
</ul>
</li>
<li><a href="#assembly-custom-resources-str">1.3. Strimzi custom resources</a>
<ul class="sectlevel3">
<li><a href="#con-custom-resources-example-str">1.3.1. Strimzi custom resource example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#deploy-options_str">2. What is deployed with Strimzi</a>
<ul class="sectlevel2">
<li><a href="#deploy-options-order-str">2.1. Order of deployment</a></li>
<li><a href="#deploy-options-scope-str">2.2. Additional deployment configuration options</a>
<ul class="sectlevel3">
<li><a href="#securing_kafka">2.2.1. Securing Kafka</a></li>
<li><a href="#monitoring_your_deployment">2.2.2. Monitoring your deployment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#deploy-tasks-prereqs_str">3. Preparing for your Strimzi deployment</a>
<ul class="sectlevel2">
<li><a href="#deploy-prereqs-str">3.1. Deployment prerequisites</a></li>
<li><a href="#downloads-str">3.2. Downloading Strimzi release artifacts</a></li>
<li><a href="#deploy-examples-str">3.3. Example configuration and deployment files</a>
<ul class="sectlevel3">
<li><a href="#example_files_location">3.3.1. Example files location</a></li>
<li><a href="#example_files_provided_with_strimzi">3.3.2. Example files provided with Strimzi</a></li>
</ul>
</li>
<li><a href="#container-images-str">3.4. Pushing container images to your own registry</a></li>
<li><a href="#adding-users-the-strimzi-admin-role-str">3.5. Designating Strimzi administrators</a></li>
<li><a href="#deploy-kubernetes-str">3.6. Installing a local Kubernetes cluster with Minikube</a></li>
</ul>
</li>
<li><a href="#deploy-tasks_str">4. Deploying Strimzi</a>
<ul class="sectlevel2">
<li><a href="#deploy-create-cluster_str">4.1. Create the Kafka cluster</a>
<ul class="sectlevel3">
<li><a href="#cluster-operator-str">4.1.1. Deploying the Cluster Operator</a></li>
<li><a href="#kafka-cluster-str">4.1.2. Deploying Kafka</a></li>
<li><a href="#deploy-standalone-operators_str">4.1.3. Alternative standalone deployment options for Strimzi Operators</a></li>
</ul>
</li>
<li><a href="#kafka-connect-str">4.2. Deploy Kafka Connect</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-connect-str">4.2.1. Deploying Kafka Connect to your Kubernetes cluster</a></li>
<li><a href="#con-kafka-connect-multiple-instances-str">4.2.2. Kafka Connect configuration for multiple instances</a></li>
<li><a href="#using-kafka-connect-with-plug-ins-str">4.2.3. Extending Kafka Connect with connector plug-ins</a></li>
<li><a href="#con-creating-managing-connectors-str">4.2.4. Creating and managing connectors</a></li>
<li><a href="#proc-deploying-kafkaconnector-str">4.2.5. Deploying the example KafkaConnector resources</a></li>
<li><a href="#proc-manual-restart-connector-str">4.2.6. Performing a restart of a Kafka connector</a></li>
<li><a href="#proc-manual-restart-connector-task-str">4.2.7. Performing a restart of a Kafka connector task</a></li>
</ul>
</li>
<li><a href="#kafka-mirror-maker-str">4.3. Deploy Kafka MirrorMaker</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-mirror-maker-str">4.3.1. Deploying Kafka MirrorMaker to your Kubernetes cluster</a></li>
</ul>
</li>
<li><a href="#kafka-bridge-str">4.4. Deploy Kafka Bridge</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-bridge-str">4.4.1. Deploying Kafka Bridge to your Kubernetes cluster</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#deploy-verify_str">5. Setting up client access to the Kafka cluster</a>
<ul class="sectlevel2">
<li><a href="#deploying-example-clients-str">5.1. Deploying example clients</a></li>
<li><a href="#setup-external-clients-str">5.2. Setting up access for clients outside of Kubernetes</a></li>
</ul>
</li>
<li><a href="#assembly-metrics-str">6. Introducing Metrics to Kafka</a>
<ul class="sectlevel2">
<li><a href="#ref-metrics-config-files-str">6.1. Example metrics files</a>
<ul class="sectlevel3">
<li><a href="#example_grafana_dashboards">6.1.1. Example Grafana dashboards</a></li>
<li><a href="#ref-metrics-yaml-files-str">6.1.2. Example Prometheus metrics configuration</a></li>
</ul>
</li>
<li><a href="#assembly-metrics-setup-str">6.2. Add Prometheus and Grafana</a>
<ul class="sectlevel3">
<li><a href="#proc-metrics-kafka-deploy-options-str">6.2.1. Deploying Prometheus metrics configuration</a></li>
<li><a href="#assembly-metrics-prometheus-str">6.2.2. Setting up Prometheus</a></li>
<li><a href="#assembly-metrics-prometheus-alertmanager-str">6.2.3. Setting up Prometheus Alertmanager</a></li>
<li><a href="#assembly-metrics-grafana-str">6.2.4. Setting up Grafana</a></li>
<li><a href="#con-metrics-kafka-mini-kube-str">6.2.5. Using metrics with Minikube</a></li>
</ul>
</li>
<li><a href="#assembly-kafka-exporter-str">6.3. Add Kafka Exporter</a>
<ul class="sectlevel3">
<li><a href="#con-metrics-kafka-exporter-lag-str">6.3.1. Monitoring Consumer lag</a></li>
<li><a href="#con-metrics-kafka-exporter-alerts-str">6.3.2. Example Kafka Exporter alerting rules</a></li>
<li><a href="#ref-metrics-kafka-exporter-str">6.3.3. Exposing Kafka Exporter metrics</a></li>
<li><a href="#proc-kafka-exporter-configuring-str">6.3.4. Configuring Kafka Exporter</a></li>
<li><a href="#proc-kafka-exporter-enabling-str">6.3.5. Enabling the Kafka Exporter Grafana dashboard</a></li>
</ul>
</li>
<li><a href="#assembly-kafka-bridge-str">6.4. Monitor Kafka Bridge</a>
<ul class="sectlevel3">
<li><a href="#configuring_kafka_bridge">6.4.1. Configuring Kafka Bridge</a></li>
<li><a href="#enabling_the_kafka_bridge_grafana_dashboard">6.4.2. Enabling the Kafka Bridge Grafana dashboard</a></li>
</ul>
</li>
<li><a href="#assembly-cruise-control-str">6.5. Monitor Cruise Control</a>
<ul class="sectlevel3">
<li><a href="#configuring_cruise_control">6.5.1. Configuring Cruise Control</a></li>
<li><a href="#enabling_the_cruise_control_grafana_dashboard">6.5.2. Enabling the Cruise Control Grafana dashboard</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-upgrade-str">7. Upgrading Strimzi</a>
<ul class="sectlevel2">
<li><a href="#assembly-upgrade-kafka-str">7.1. Required upgrade sequence</a></li>
<li><a href="#con-upgrade-cluster-str">7.2. Upgrading Kubernetes</a>
<ul class="sectlevel3">
<li><a href="#configuring_pod_disruption_budgets">7.2.1. Configuring pod disruption budgets</a></li>
<li><a href="#rolling_pods_while_keeping_topics_available">7.2.2. Rolling pods while keeping topics available</a></li>
</ul>
</li>
<li><a href="#assembly-upgrade-resources-str">7.3. Strimzi custom resource upgrades</a></li>
<li><a href="#proc-upgrading-the-co-str">7.4. Upgrading the Cluster Operator</a></li>
<li><a href="#assembly-upgrading-kafka-versions-str">7.5. Upgrading Kafka</a>
<ul class="sectlevel3">
<li><a href="#ref-kafka-versions-str">7.5.1. Kafka versions</a></li>
<li><a href="#con-strategies-for-upgrading-clients-str">7.5.2. Strategies for upgrading clients</a></li>
<li><a href="#con-versions-and-images-str">7.5.3. Kafka version and image mappings</a></li>
<li><a href="#proc-upgrading-brokers-newer-kafka-str">7.5.4. Upgrading Kafka brokers and client applications</a></li>
</ul>
</li>
<li><a href="#proc-upgrading-consumers-streams-cooperative-rebalancing_str">7.6. Upgrading consumers to cooperative rebalancing</a></li>
</ul>
</li>
<li><a href="#assembly-downgrade-str">8. Downgrading Strimzi</a>
<ul class="sectlevel2">
<li><a href="#proc-downgrade-cluster-operator-str">8.1. Downgrading the Cluster Operator to a previous version</a></li>
<li><a href="#assembly-downgrade-kafka-versions-str">8.2. Downgrading Kafka</a>
<ul class="sectlevel3">
<li><a href="#con-target-downgrade-version-str">8.2.1. Kafka version compatibility for downgrades</a></li>
<li><a href="#proc-downgrading-brokers-older-kafka-str">8.2.2. Downgrading Kafka brokers and client applications</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="deploy-intro_str"><a class="link" href="#deploy-intro_str">1. Deployment overview</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Strimzi simplifies the process of running Apache Kafka in a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>This guide provides instructions on all the options available for deploying and upgrading Strimzi,
describing what is deployed, and the order of deployment required to run Apache Kafka in a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>As well as describing the deployment steps, the guide also provides pre- and post-deployment instructions to prepare for and verify a deployment.
Additional deployment options described include the steps to introduce metrics.
Upgrade instructions are provided for Strimzi and Kafka upgrades.</p>
</div>
<div class="paragraph">
<p>Strimzi is designed to work on all types of Kubernetes cluster regardless of distribution,
from public and private clouds to local deployments intended for development.</p>
</div>
<div class="sect2">
<h3 id="key-features-product_str"><a class="link" href="#key-features-product_str">1.1. How Strimzi supports Kafka</a></h3>
<div class="paragraph">
<p>Strimzi provides container images and Operators for running Kafka on Kubernetes.
Strimzi Operators are fundamental to the running of Strimzi.
The Operators provided with Strimzi are purpose-built with specialist operational knowledge to effectively manage Kafka.</p>
</div>
<div class="paragraph">
<p>Operators simplify the process of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploying and running Kafka clusters</p>
</li>
<li>
<p>Deploying and running Kafka components</p>
</li>
<li>
<p>Configuring access to Kafka</p>
</li>
<li>
<p>Securing access to Kafka</p>
</li>
<li>
<p>Upgrading Kafka</p>
</li>
<li>
<p>Managing brokers</p>
</li>
<li>
<p>Creating and managing topics</p>
</li>
<li>
<p>Creating and managing users</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="overview-components_str"><a class="link" href="#overview-components_str">1.2. Strimzi Operators</a></h3>
<div class="paragraph">
<p>Strimzi supports Kafka using <em>Operators</em> to deploy and manage the components and dependencies of Kafka to Kubernetes.</p>
</div>
<div class="paragraph">
<p>Operators are a method of packaging, deploying, and managing a Kubernetes application.
Strimzi Operators extend Kubernetes functionality, automating common and complex tasks related to a Kafka deployment.
By implementing knowledge of Kafka operations in code, Kafka administration tasks are simplified and require less manual intervention.</p>
</div>
<h4 id="key-features-operators_str" class="discrete">Operators</h4>
<div class="paragraph">
<p>Strimzi provides Operators for managing a Kafka cluster running within a Kubernetes cluster.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cluster Operator</dt>
<dd>
<p>Deploys and manages Apache Kafka clusters, Kafka Connect, Kafka MirrorMaker, Kafka Bridge, Kafka Exporter, and the Entity Operator</p>
</dd>
<dt class="hdlist1">Entity Operator</dt>
<dd>
<p>Comprises the Topic Operator and User Operator</p>
</dd>
<dt class="hdlist1">Topic Operator</dt>
<dd>
<p>Manages Kafka topics</p>
</dd>
<dt class="hdlist1">User Operator</dt>
<dd>
<p>Manages Kafka users</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The Cluster Operator can deploy the Topic Operator and User Operator as part of an <strong>Entity Operator</strong> configuration at the same time as a Kafka cluster.</p>
</div>
<div class="paragraph">
<div class="title">Operators within the Strimzi architecture</div>
<p><span class="image"><img src="images/operators.png" alt="Operators within the Strimzi architecture"></span></p>
</div>
<div class="sect3">
<h4 id="overview-components-cluster-operator-str"><a class="link" href="#overview-components-cluster-operator-str">1.2.1. Cluster Operator</a></h4>
<div class="paragraph">
<p>Strimzi uses the Cluster Operator to deploy and manage clusters for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka (including ZooKeeper, Entity Operator, Kafka Exporter, and Cruise Control)</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>Kafka Bridge</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Custom resources are used to deploy the clusters.</p>
</div>
<div class="paragraph">
<p>For example, to deploy a Kafka cluster:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>Kafka</code> resource with the cluster configuration is created within the Kubernetes cluster.</p>
</li>
<li>
<p>The Cluster Operator deploys a corresponding Kafka cluster, based on what is declared in the <code>Kafka</code> resource.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Cluster Operator can also deploy (through configuration of the <code>Kafka</code> resource):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Topic Operator to provide operator-style topic management through <code>KafkaTopic</code> custom resources</p>
</li>
<li>
<p>A User Operator to provide operator-style user management through <code>KafkaUser</code> custom resources</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Topic Operator and User Operator function within the Entity Operator on deployment.</p>
</div>
<div class="paragraph">
<div class="title">Example architecture for the Cluster Operator</div>
<p><span class="image"><img src="images/cluster-operator.png" alt="The Cluster Operator creates and deploys Kafka and ZooKeeper clusters"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="overview-concepts-topic-operator-str"><a class="link" href="#overview-concepts-topic-operator-str">1.2.2. Topic Operator</a></h4>
<div class="paragraph">
<p>The Topic Operator provides a way of managing topics in a Kafka cluster through Kubernetes resources.</p>
</div>
<div class="paragraph">
<div class="title">Example architecture for the Topic Operator</div>
<p><span class="image"><img src="images/topic-operator.png" alt="The Topic Operator manages topics for a Kafka cluster via KafkaTopic resources"></span></p>
</div>
<div class="paragraph">
<p>The role of the Topic Operator is to keep a set of <code>KafkaTopic</code> Kubernetes resources describing Kafka topics in-sync with corresponding Kafka topics.</p>
</div>
<div class="paragraph">
<p>Specifically, if a <code>KafkaTopic</code> is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Created, the Topic Operator creates the topic</p>
</li>
<li>
<p>Deleted, the Topic Operator deletes the topic</p>
</li>
<li>
<p>Changed, the Topic Operator updates the topic</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Working in the other direction, if a topic is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Created within the Kafka cluster, the Operator creates a <code>KafkaTopic</code></p>
</li>
<li>
<p>Deleted from the Kafka cluster, the Operator deletes the <code>KafkaTopic</code></p>
</li>
<li>
<p>Changed in the Kafka cluster, the Operator updates the <code>KafkaTopic</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This allows you to declare a <code>KafkaTopic</code> as part of your application&#8217;s deployment and the Topic Operator will take care of creating the topic for you.
Your application just needs to deal with producing or consuming from the necessary topics.</p>
</div>
<div class="paragraph">
<p>The Topic Operator maintains information about each topic in a <em>topic store</em>, which is continually synchronized with updates from Kafka topics or Kubernetes <code>KafkaTopic</code> custom resources.
Updates from operations applied to a local in-memory topic store are persisted to a backup topic store on disk.
If a topic is reconfigured or reassigned to other brokers, the <code>KafkaTopic</code> will always be up to date.</p>
</div>
</div>
<div class="sect3">
<h4 id="overview-concepts-user-operator-str"><a class="link" href="#overview-concepts-user-operator-str">1.2.3. User Operator</a></h4>
<div class="paragraph">
<p>The User Operator manages Kafka users for a Kafka cluster by watching for <code>KafkaUser</code> resources that describe Kafka users,
and ensuring that they are configured properly in the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>For example, if a <code>KafkaUser</code> is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Created, the User Operator creates the user it describes</p>
</li>
<li>
<p>Deleted, the User Operator deletes the user it describes</p>
</li>
<li>
<p>Changed, the User Operator updates the user it describes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unlike the Topic Operator, the User Operator does not sync any changes from the Kafka cluster with the Kubernetes resources.
Kafka topics can be created by applications directly in Kafka, but it is not expected that the users will be managed directly in the Kafka cluster in parallel with the User Operator.</p>
</div>
<div class="paragraph">
<p>The User Operator allows you to declare a <code>KafkaUser</code> resource as part of your application&#8217;s deployment.
You can specify the authentication and authorization mechanism for the user.
You can also configure <em>user quotas</em> that control usage of Kafka resources to ensure, for example, that a user does not monopolize access to a broker.</p>
</div>
<div class="paragraph">
<p>When the user is created, the user credentials are created in a <code>Secret</code>.
Your application needs to use the user and its credentials for authentication and to produce or consume messages.</p>
</div>
<div class="paragraph">
<p>In addition to managing credentials for authentication, the User Operator also manages authorization rules by including a description of the user&#8217;s access rights in the <code>KafkaUser</code> declaration.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-feature-gates-overview-str"><a class="link" href="#con-feature-gates-overview-str">1.2.4. Feature gates in Strimzi Operators</a></h4>
<div class="paragraph">
<p>You can enable and disable some features of operators using <em>feature gates</em>.</p>
</div>
<div class="paragraph">
<p>Feature gates are set in the operator configuration and have three stages of maturity: alpha, beta, or General Availability (GA).</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="./using.html#ref-operator-cluster-feature-gates-str">Feature gates</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-custom-resources-str"><a class="link" href="#assembly-custom-resources-str">1.3. Strimzi custom resources</a></h3>
<div class="paragraph _abstract">
<p>A deployment of Kafka components to a Kubernetes cluster using Strimzi is highly configurable through the application of custom resources.
Custom resources are created as instances of APIs added by Custom resource definitions (CRDs) to extend Kubernetes resources.</p>
</div>
<div class="paragraph">
<p>CRDs act as configuration instructions to describe the custom resources in a Kubernetes cluster,
and are provided with Strimzi for each Kafka component used in a deployment, as well as users and topics.
CRDs and custom resources are defined as YAML files.
Example YAML files are provided with the Strimzi distribution.</p>
</div>
<div class="paragraph">
<p>CRDs also allow Strimzi resources to benefit from native Kubernetes features like CLI accessibility and configuration validation.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/" target="_blank" rel="noopener">Extend the Kubernetes API with CustomResourceDefinitions</a></p>
</li>
<li>
<p><a href="./deploying.html#deploy-examples-str" target="_blank" rel="noopener">Example configuration files provided with Strimzi</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="con-custom-resources-example-str"><a class="link" href="#con-custom-resources-example-str">1.3.1. Strimzi custom resource example</a></h4>
<div class="paragraph">
<p>CRDs require a one-time installation in a cluster to define the schemas used to instantiate and manage Strimzi-specific resources.</p>
</div>
<div class="paragraph">
<p>After a new custom resource type is added to your cluster by installing a CRD, you can create instances of the resource based on its specification.</p>
</div>
<div class="paragraph">
<p>Depending on the cluster setup, installation typically requires cluster admin privileges.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Access to manage custom resources is limited to Strimzi administrators.
For more information, see <a href="./deploying.html#adding-users-the-strimzi-admin-role-str" target="_blank" rel="noopener">Designating Strimzi administrators</a> in the <em>Deploying and Upgrading Strimzi</em> guide.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A CRD defines a new <code>kind</code> of resource, such as <code>kind:Kafka</code>, within a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>The Kubernetes API server allows custom resources to be created based on the <code>kind</code> and understands from the CRD how to validate and store the custom resource when it is added to the Kubernetes cluster.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
When CRDs are deleted, custom resources of that type are also deleted. Additionally, the resources created by the custom resource, such as pods and statefulsets are also deleted.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each Strimzi-specific custom resource conforms to the schema defined by the CRD for the resource&#8217;s <code>kind</code>.
The custom resources for Strimzi components have common configuration properties, which are defined under <code>spec</code>.</p>
</div>
<div class="paragraph">
<p>To understand the relationship between a CRD and a custom resource, let&#8217;s look at a sample of the CRD for a Kafka topic.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic CRD</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: CustomResourceDefinition
metadata: <b class="conum">(1)</b>
  name: kafkatopics.kafka.strimzi.io
  labels:
    app: strimzi
spec: <b class="conum">(2)</b>
  group: kafka.strimzi.io
  versions:
    v1beta2
  scope: Namespaced
  names:
    # ...
    singular: kafkatopic
    plural: kafkatopics
    shortNames:
    - kt <b class="conum">(3)</b>
  additionalPrinterColumns: <b class="conum">(4)</b>
      # ...
  subresources:
    status: {} <b class="conum">(5)</b>
  validation: <b class="conum">(6)</b>
    openAPIV3Schema:
      properties:
        spec:
          type: object
          properties:
            partitions:
              type: integer
              minimum: 1
            replicas:
              type: integer
              minimum: 1
              maximum: 32767
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The metadata for the topic CRD, its name and a label to identify the CRD.</p>
</li>
<li>
<p>The specification for this CRD, including the group (domain) name, the plural name and the supported schema version, which are used in the URL to access the API of the topic. The other names are used to identify instance resources in the CLI. For example, <code>kubectl get kafkatopic my-topic</code> or <code>kubectl get kafkatopics</code>.</p>
</li>
<li>
<p>The shortname can be used in CLI commands. For example, <code>kubectl get kt</code> can be used as an abbreviation instead of <code>kubectl get kafkatopic</code>.</p>
</li>
<li>
<p>The information presented when using a <code>get</code> command on the custom resource.</p>
</li>
<li>
<p>The current status of the CRD as described in the <a href="./using.html#type-Kafka-reference" target="_blank" rel="noopener">schema reference</a> for the resource.</p>
</li>
<li>
<p>openAPIV3Schema validation provides validation for the creation of topic custom resources. For example, a topic requires at least one partition and one replica.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can identify the CRD YAML files supplied with the Strimzi installation files, because the file names contain an index number followed by Crd.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a corresponding example of a <code>KafkaTopic</code> custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic custom resource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic <b class="conum">(1)</b>
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster <b class="conum">(2)</b>
spec: <b class="conum">(3)</b>
  partitions: 1
  replicas: 1
  config:
    retention.ms: 7200000
    segment.bytes: 1073741824
status:
  conditions: <b class="conum">(4)</b>
    lastTransitionTime: "2019-08-20T11:37:00.706Z"
    status: "True"
    type: Ready
  observedGeneration: 1
  / ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>kind</code> and <code>apiVersion</code> identify the CRD of which the custom resource is an instance.</p>
</li>
<li>
<p>A label, applicable only to <code>KafkaTopic</code> and <code>KafkaUser</code> resources, that defines the name of the Kafka cluster (which is same as the name of the <code>Kafka</code> resource) to which a topic or user belongs.</p>
</li>
<li>
<p>The spec shows the number of partitions and replicas for the topic as well as the configuration parameters for the topic itself. In this example, the retention period for a message to remain in the topic and the segment file size for the log are specified.</p>
</li>
<li>
<p>Status conditions for the <code>KafkaTopic</code> resource. The <code>type</code> condition changed to <code>Ready</code> at the <code>lastTransitionTime</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Custom resources can be applied to a cluster through the platform CLI.
When the custom resource is created, it uses the same validation as the built-in resources of the Kubernetes API.</p>
</div>
<div class="paragraph">
<p>After a <code>KafkaTopic</code> custom resource is created, the Topic Operator is notified and corresponding Kafka topics are created in Strimzi.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-options_str"><a class="link" href="#deploy-options_str">2. What is deployed with Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache Kafka components are provided for deployment to Kubernetes with the Strimzi distribution.
The Kafka components are generally run as clusters for availability.</p>
</div>
<div class="paragraph">
<p>A typical deployment incorporating Kafka components might include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Kafka</strong> cluster of broker nodes</p>
</li>
<li>
<p><strong>ZooKeeper</strong> cluster of replicated ZooKeeper instances</p>
</li>
<li>
<p><strong>Kafka Connect</strong> cluster for external data connections</p>
</li>
<li>
<p><strong>Kafka MirrorMaker</strong> cluster to mirror the Kafka cluster in a secondary cluster</p>
</li>
<li>
<p><strong>Kafka Exporter</strong> to extract additional Kafka metrics data for monitoring</p>
</li>
<li>
<p><strong>Kafka Bridge</strong> to make HTTP-based requests to the Kafka cluster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Not all of these components are mandatory, though you need Kafka and ZooKeeper as a minimum.
Some components can be deployed without Kafka, such as MirrorMaker or Kafka Connect.</p>
</div>
<div class="sect2">
<h3 id="deploy-options-order-str"><a class="link" href="#deploy-options-order-str">2.1. Order of deployment</a></h3>
<div class="paragraph">
<p>The required order of deployment to a Kubernetes cluster is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy the Cluster Operator to manage your Kafka cluster</p>
</li>
<li>
<p>Deploy the Kafka cluster with the ZooKeeper cluster, and include the Topic Operator and User Operator in the deployment</p>
</li>
<li>
<p>Optionally deploy:</p>
<div class="ulist">
<ul>
<li>
<p>The Topic Operator and User Operator standalone if you did not deploy them with the Kafka cluster</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>Kafka Bridge</p>
</li>
<li>
<p>Components for the monitoring of metrics</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="deploy-options-scope-str"><a class="link" href="#deploy-options-scope-str">2.2. Additional deployment configuration options</a></h3>
<div class="paragraph">
<p>The deployment procedures in this guide describe a deployment using the example installation YAML files provided with Strimzi.
The procedures highlight any important configuration considerations, but they do not describe all the configuration options available.</p>
</div>
<div class="paragraph">
<p>You can use custom resources to refine your deployment.</p>
</div>
<div class="paragraph">
<p>You may wish to review the configuration options available for Kafka components before you deploy Strimzi.
For more information on the configuration through custom resources, see <a href="./using.html#assembly-deployment-configuration-str" target="_blank" rel="noopener">Deployment configuration</a> in the <em>Using Strimzi</em> guide.</p>
</div>
<div class="sect3">
<h4 id="securing_kafka"><a class="link" href="#securing_kafka">2.2.1. Securing Kafka</a></h4>
<div class="paragraph">
<p>On deployment, the Cluster Operator automatically sets up TLS certificates for data encryption and authentication within your cluster.</p>
</div>
<div class="paragraph">
<p>Strimzi provides additional configuration options for <em>encryption</em>, <em>authentication</em> and <em>authorization</em>, which are described in the <em>Using Strimzi</em> guide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Secure data exchange between the Kafka cluster and clients by <a href="./using.html#assembly-securing-access-str" target="_blank" rel="noopener">Managing secure access to Kafka</a>.</p>
</li>
<li>
<p>Configure your deployment to use an authorization server to provide <a href="./using.html#assembly-oauth-authentication_str" target="_blank" rel="noopener">OAuth 2.0 authentication</a> and <a href="./using.html#assembly-oauth-authorization_str" target="_blank" rel="noopener">OAuth 2.0 authorization</a>.</p>
</li>
<li>
<p><a href="./using.html#security-str" target="_blank" rel="noopener">Secure Kafka using your own certificates</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="monitoring_your_deployment"><a class="link" href="#monitoring_your_deployment">2.2.2. Monitoring your deployment</a></h4>
<div class="paragraph">
<p>Strimzi supports additional deployment options to monitor your deployment.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extract metrics and monitor Kafka components by <a href="#assembly-metrics-setup-str">deploying Prometheus and Grafana with your Kafka cluster</a>.</p>
</li>
<li>
<p>Extract additional metrics, particularly related to monitoring consumer lag, by <a href="#assembly-kafka-exporter-str">deploying Kafka Exporter with your Kafka cluster</a>.</p>
</li>
<li>
<p>Track messages end-to-end by <a href="./using.html#assembly-distributed-tracing-str" target="_blank" rel="noopener">setting up distributed tracing</a>, as described in the <em>Using Strimzi</em> guide.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-tasks-prereqs_str"><a class="link" href="#deploy-tasks-prereqs_str">3. Preparing for your Strimzi deployment</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section shows how you prepare for a Strimzi deployment, describing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploy-prereqs-str">The prerequisites you need before you can deploy Strimzi</a></p>
</li>
<li>
<p><a href="#downloads-str">How to download the Strimzi release artifacts to use in your deployment</a></p>
</li>
<li>
<p><a href="#container-images-str">How to push the Strimzi container images into you own registry (if required)</a></p>
</li>
<li>
<p><a href="#adding-users-the-strimzi-admin-role-str">How to set up <em>admin</em> roles for configuration of custom resources used in deployment</a></p>
</li>
<li>
<p><a href="#deploy-kubernetes-str"><em>Minikube</em> as an alternative deployment option to Kubernetes</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To run the commands in this guide, your cluster user must have the rights to manage role-based access control (RBAC) and CRDs.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="deploy-prereqs-str"><a class="link" href="#deploy-prereqs-str">3.1. Deployment prerequisites</a></h3>
<div class="paragraph">
<p>To deploy Strimzi, make sure that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Kubernetes 1.16 and later cluster is available.</p>
<div class="paragraph">
<p>If you do not have access to a Kubernetes cluster, you can install Strimzi with <a href="#deploy-kubernetes-str"><em>Minikube</em></a>.</p>
</div>
</li>
<li>
<p>The <code>kubectl</code> command-line tool is installed and configured to connect to the running cluster.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi supports some features that are specific to OpenShift,
where such integration benefits OpenShift users and there is no equivalent implementation using standard Kubernetes.
</td>
</tr>
</table>
</div>
<h4 id="code_oc_code_and_code_kubectl_code_commands" class="discrete"><code>oc</code> and <code>kubectl</code> commands</h4>
<div class="paragraph">
<p>The <code>oc</code> command functions as an alternative to <code>kubectl</code>.
In almost all cases the example <code>kubectl</code> commands used in this guide can be done using <code>oc</code> simply by replacing the command name (options and arguments remain the same).</p>
</div>
<div class="paragraph">
<p>In other words, instead of using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>your-file</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>when using OpenShift you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc apply -f <em>your-file</em></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As an exception to this general rule, <code>oc</code> uses <code>oc adm</code> subcommands for <em>cluster management</em> functionality,
whereas <code>kubectl</code> does not make this distinction.
For example, the <code>oc</code> equivalent of <code>kubectl taint</code> is <code>oc adm taint</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="downloads-str"><a class="link" href="#downloads-str">3.2. Downloading Strimzi release artifacts</a></h3>
<div class="paragraph">
<p>To install Strimzi, download the release artifacts from <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>Strimzi release artifacts include sample YAML files to help you deploy the components of Strimzi to Kubernetes, perform common operations,
and configure your Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Use <code>kubectl</code> to deploy the Cluster Operator from the <code>install/cluster-operator</code> folder of the downloaded ZIP file.
For more information about deploying and configuring the Cluster Operator, see <a href="#cluster-operator-str">Deploying the Cluster Operator</a>.</p>
</div>
<div class="paragraph">
<p>In addition, if you want to use standalone installations of the Topic and User Operators with a Kafka cluster that is not managed by the Strimzi Cluster Operator, you can deploy them from the <code>install/topic-operator</code> and <code>install/user-operator</code> folders.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Additionally, Strimzi container images are available through the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a>.
However, we recommend that you use the YAML files provided to deploy Strimzi.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="deploy-examples-str"><a class="link" href="#deploy-examples-str">3.3. Example configuration and deployment files</a></h3>
<div class="paragraph _abstract">
<p>Use the example configuration and deployment files provided with Strimzi to deploy Kafka components with different configurations and monitor your deployment.
Example configuration files for custom resources contain important properties and values, which you can extend with additional supported configuration properties for your own deployment.</p>
</div>
<div class="sect3">
<h4 id="example_files_location"><a class="link" href="#example_files_location">3.3.1. Example files location</a></h4>
<div class="paragraph">
<p>The example files are provided with the downloadable release artifacts from <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>You can also access the example files directly from the
<a href="https://github.com/strimzi/strimzi-kafka-operator/tree/main/examples/" target="_blank" rel="noopener"><code>examples</code> directory</a>.</p>
</div>
<div class="paragraph">
<p>You can download and apply the examples using the <code>kubectl</code> command-line tool.
The examples can serve as a starting point when building your own Kafka component configuration for deployment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you installed Strimzi using the Operator, you can still download the example files and use them to upload configuration.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="example_files_provided_with_strimzi"><a class="link" href="#example_files_provided_with_strimzi">3.3.2. Example files provided with Strimzi</a></h4>
<div class="paragraph">
<p>The release artifacts include an <code>examples</code> directory that contains the configuration examples.</p>
</div>
<div class="listingblock">
<div class="title">Examples directory</div>
<div class="content">
<pre class="highlightjs highlight"><code>examples
 user <b class="conum">(1)</b>
 topic <b class="conum">(2)</b>
 security <b class="conum">(3)</b>
    tls-auth
    scram-sha-512-auth
    keycloak-authorization
 mirror-maker <b class="conum">(4)</b>
 metrics <b class="conum">(5)</b>
 kafka <b class="conum">(6)</b>
 cruise-control <b class="conum">(7)</b>
 connect <b class="conum">(8)</b>
 bridge <b class="conum">(9)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>KafkaUser</code> custom resource configuration, which is managed by the User Operator.</p>
</li>
<li>
<p><code>KafkaTopic</code> custom resource configuration, which is managed by Topic Operator.</p>
</li>
<li>
<p>Authentication and authorization configuration for Kafka components. Includes example configuration for TLS and SCRAM-SHA-512 authentication. The Keycloak example includes <code>Kafka</code> custom resource configuration and a Keycloak realm specification. You can use the example to try Keycloak authorization services.</p>
</li>
<li>
<p><code>Kafka</code> custom resource configuration for a deployment of Mirror Maker. Includes example configuration for replication policy and synchronization frequency.</p>
</li>
<li>
<p><a href="#ref-metrics-config-files-str">Metrics configuration</a>, including Prometheus installation and Grafana dashboard files.</p>
</li>
<li>
<p><code>Kafka</code> custom resource configuration for a deployment of Kafka. Includes example configuration for an ephemeral or persistent single or multi-node deployment.</p>
</li>
<li>
<p><code>Kafka</code> custom resource with a deployment configuration for Cruise Control. Includes <code>KafkaRebalance</code> custom resources to generate optimizations proposals from Cruise Control, with example configurations to use the default or user optimization goals.</p>
</li>
<li>
<p><code>KafkaConnect</code> and <code>KafkaConnector</code> custom resource configuration for a deployment of Kafka Connect. Includes example configuration for a single or multi-node deployment.</p>
</li>
<li>
<p><code>KafkaBridge</code> custom resource configuration for a deployment of Kafka Bridge.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./using.html#assembly-deployment-configuration-str" target="_blank" rel="noopener">Configuring a Strimzi deployment</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="container-images-str"><a class="link" href="#container-images-str">3.4. Pushing container images to your own registry</a></h3>
<div class="paragraph">
<p>Container images for Strimzi are available in the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a>.
The installation YAML files provided by Strimzi will pull the images directly from the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a>.</p>
</div>
<div class="paragraph">
<p>If you do not have access to the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a> or want to use your own container repository:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pull <strong>all</strong> container images listed here</p>
</li>
<li>
<p>Push them into your own registry</p>
</li>
<li>
<p>Update the image names in the YAML files used in deployment</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Each Kafka version supported for the release has a separate image.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Container image</th>
<th class="tableblock halign-left valign-top">Namespace/Repository</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/kafka:0.26.0-kafka-2.7.0</p>
</li>
<li>
<p>quay.io/strimzi/kafka:0.26.0-kafka-2.7.1</p>
</li>
<li>
<p>quay.io/strimzi/kafka:0.26.0-kafka-2.8.0</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Strimzi image for running Kafka, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka Broker</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>ZooKeeper</p>
</li>
<li>
<p>TLS Sidecars</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/operator:0.26.0</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Strimzi image for running the operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster Operator</p>
</li>
<li>
<p>Topic Operator</p>
</li>
<li>
<p>User Operator</p>
</li>
<li>
<p>Kafka Initializer</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/kafka-bridge:{BridgeVersion}</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Strimzi image for running the Strimzi kafka Bridge</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JmxTrans</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/jmxtrans:0.26.0</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Strimzi image for running the Strimzi JmxTrans</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="adding-users-the-strimzi-admin-role-str"><a class="link" href="#adding-users-the-strimzi-admin-role-str">3.5. Designating Strimzi administrators</a></h3>
<div class="paragraph">
<p>Strimzi provides custom resources for configuration of your deployment.
By default, permission to view, create, edit, and delete these resources is limited to Kubernetes cluster administrators.
Strimzi provides two cluster roles that you can use to assign these rights to other users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>strimzi-view</code> allows users to view and list Strimzi resources.</p>
</li>
<li>
<p><code>strimzi-admin</code> allows users to also create, edit or delete Strimzi resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you install these roles, they will automatically aggregate (add) these rights to the default Kubernetes cluster roles.
<code>strimzi-view</code> aggregates to the <code>view</code> role, and <code>strimzi-admin</code> aggregates to the <code>edit</code> and <code>admin</code> roles.
Because of the aggregation, you might not need to assign these roles to users who already have similar rights.</p>
</div>
<div class="paragraph">
<p>The following procedure shows how to assign a <code>strimzi-admin</code> role that allows non-cluster administrators to manage Strimzi resources.</p>
</div>
<div class="paragraph">
<p>A system administrator can designate Strimzi administrators after the Cluster Operator is deployed.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Strimzi Custom Resource Definitions (CRDs) and role-based access control (RBAC) resources to manage the CRDs have been <a href="#cluster-operator-str">deployed with the Cluster Operator</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the <code>strimzi-view</code> and <code>strimzi-admin</code> cluster roles in Kubernetes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/strimzi-admin</code></pre>
</div>
</div>
</li>
<li>
<p>If needed, assign the roles that provide access rights to users that require them.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create clusterrolebinding strimzi-admin --clusterrole=strimzi-admin --user=<em>user1</em> --user=<em>user2</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="deploy-kubernetes-str"><a class="link" href="#deploy-kubernetes-str">3.6. Installing a local Kubernetes cluster with Minikube</a></h3>
<div class="paragraph">
<p>Minikube offers an easy way to get started with Kubernetes.
If a Kubernetes cluster is unavailable, you can use Minikube to create a local cluster.</p>
</div>
<div class="paragraph">
<p>You can download and install Minikube from the <a href="https://kubernetes.io/docs/home/">Kubernetes website</a>, which also provides documentation.
Depending on the number of brokers you want to deploy inside the cluster, and whether you want to run Kafka Connect as well,
try running Minikube with at least with 4 GB of RAM instead of the default 2 GB.</p>
</div>
<div class="paragraph">
<p>Once installed, start Minikube using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">minikube start --memory 4096</code></pre>
</div>
</div>
<div class="paragraph">
<p>To interact with the cluster, install the <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/"><code>kubectl</code></a> utility.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-tasks_str"><a class="link" href="#deploy-tasks_str">4. Deploying Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Having <a href="#deploy-tasks-prereqs_str">prepared your environment for a deployment of Strimzi</a>, this section shows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploy-create-cluster_str">How to create the Kafka cluster</a></p>
</li>
<li>
<p>Optional procedures to deploy other Kafka components according to your requirements:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#kafka-connect-str">Kafka Connect</a></p>
</li>
<li>
<p><a href="#kafka-mirror-maker-str">Kafka MirrorMaker</a></p>
</li>
<li>
<p><a href="#kafka-bridge-str">Kafka Bridge</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The procedures assume a Kubernetes cluster is available and running.</p>
</div>
<div class="paragraph">
<p>This section describes the procedures to deploy Strimzi on Kubernetes 1.16 and later.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To run the commands in this guide, your cluster user must have the rights to manage role-based access control (RBAC) and CRDs.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="deploy-create-cluster_str"><a class="link" href="#deploy-create-cluster_str">4.1. Create the Kafka cluster</a></h3>
<div class="paragraph _abstract">
<p>To be able to manage a Kafka cluster with the Cluster Operator, you must deploy it as a <code>Kafka</code> resource.
Strimzi provides example deployment files to do this.
You can use these files to deploy the Topic Operator and User Operator at the same time.</p>
</div>
<div class="paragraph">
<p>If you haven&#8217;t deployed a Kafka cluster as a <code>Kafka</code> resource, you can&#8217;t use the Cluster Operator to manage it.
This applies, for example, to a Kafka cluster running outside of Kubernetes.
But you can deploy and use the Topic Operator and User Operator as standalone components.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The Cluster Operator can watch one, multiple, or all namespaces in a Kubernetes cluster.
The Topic Operator and User Operator watch for <code>KafkaTopics</code> and <code>KafkaUsers</code> in the single namespace of the Kafka cluster deployment.
</td>
</tr>
</table>
</div>
<h4 id="deploying_a_kafka_cluster_with_the_topic_operator_and_user_operator" class="discrete">Deploying a Kafka cluster with the Topic Operator and User Operator</h4>
<div class="paragraph">
<p>Perform these deployment steps if you want to use the Topic Operator and User Operator with a Kafka cluster managed by Strimzi.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#cluster-operator-str">Deploy the Cluster Operator</a></p>
</li>
<li>
<p>Use the Cluster Operator to deploy the:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#kafka-cluster-str">Kafka cluster</a></p>
</li>
<li>
<p><a href="#deploying-the-topic-operator-using-the-cluster-operator-str">Topic Operator</a></p>
</li>
<li>
<p><a href="#deploying-the-user-operator-using-the-cluster-operator-str">User Operator</a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<h4 id="deploying_a_standalone_topic_operator_and_user_operator" class="discrete">Deploying a standalone Topic Operator and User Operator</h4>
<div class="paragraph">
<p>Perform these deployment steps if you want to use the Topic Operator and User Operator with a Kafka cluster that is <strong>not managed</strong> by Strimzi.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#deploying-the-topic-operator-standalone-str">Deploy the standalone Topic Operator</a></p>
</li>
<li>
<p><a href="#deploying-the-user-operator-standalone-str">Deploy the standalone User Operator</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="cluster-operator-str"><a class="link" href="#cluster-operator-str">4.1.1. Deploying the Cluster Operator</a></h4>
<div class="paragraph">
<p>The Cluster Operator is responsible for deploying and managing Apache Kafka clusters within a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>The procedures in this section show:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to deploy the Cluster Operator to <em>watch</em>:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">A single namespace</a></p>
</li>
<li>
<p><a href="#deploying-cluster-operator-to-watch-multiple-namespaces-str">Multiple namespaces</a></p>
</li>
<li>
<p><a href="#deploying-cluster-operator-to-watch-whole-cluster-str">All namespaces</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Alternative deployment options:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-cluster-operator-helm-chart-str">How to deploy the Cluster Operator using a Helm chart</a></p>
</li>
<li>
<p><a href="#deploying-cluster-operator-from-operator-hub-str">How to deploy the Cluster Operator from <em>OperatorHub.io</em></a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="con-cluster-operator-watch-options-str"><a class="link" href="#con-cluster-operator-watch-options-str">Watch options for a Cluster Operator deployment</a></h5>
<div class="paragraph">
<p>When the Cluster Operator is running, it starts to <em>watch</em> for updates of Kafka resources.</p>
</div>
<div class="paragraph">
<p>You can choose to deploy the Cluster Operator to watch Kafka resources from:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single namespace (the same namespace containing the Cluster Operator)</p>
</li>
<li>
<p>Multiple namespaces</p>
</li>
<li>
<p>All namespaces</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi provides example YAML files to make the deployment process easier.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Cluster Operator watches for changes to the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Kafka</code> for the Kafka cluster.</p>
</li>
<li>
<p><code>KafkaConnect</code> for the Kafka Connect cluster.</p>
</li>
<li>
<p><code>KafkaConnector</code> for creating and managing connectors in a Kafka Connect cluster.</p>
</li>
<li>
<p><code>KafkaMirrorMaker</code> for the Kafka MirrorMaker instance.</p>
</li>
<li>
<p><code>KafkaBridge</code> for the Kafka Bridge instance</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When one of these resources is created in the Kubernetes cluster, the operator gets the cluster description from the resource and starts creating a new cluster for the resource by creating the necessary Kubernetes resources, such as StatefulSets, Services and ConfigMaps.</p>
</div>
<div class="paragraph">
<p>Each time a Kafka resource is updated, the operator performs corresponding updates on the Kubernetes resources that make up the cluster for the resource.</p>
</div>
<div class="paragraph">
<p>Resources are either patched or deleted, and then recreated in order to make the cluster for the resource reflect the desired state of the cluster.
This operation might cause a rolling update that might lead to service disruption.</p>
</div>
<div class="paragraph">
<p>When a resource is deleted, the operator undeploys the cluster and deletes all related Kubernetes resources.</p>
</div>
</div>
<div class="sect4">
<h5 id="deploying-cluster-operator-str"><a class="link" href="#deploying-cluster-operator-str">Deploying the Cluster Operator to watch a single namespace</a></h5>
<div class="paragraph">
<p>This procedure shows how to deploy the Cluster Operator to watch Strimzi resources in a single namespace in your Kubernetes cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>This procedure requires use of a Kubernetes user account which is able to create <code>CustomResourceDefinitions</code>, <code>ClusterRoles</code> and <code>ClusterRoleBindings</code>.
Use of Role Base Access Control (RBAC) in the Kubernetes cluster usually means that permission to create, edit, and delete these resources is limited to Kubernetes cluster administrators, such as <code>system:admin</code>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the Strimzi installation files to use the namespace the Cluster Operator is going to be installed into.</p>
<div class="paragraph">
<p>For example, in this procedure the Cluster Operator is installed into the namespace <code><em>my-cluster-operator-namespace</em></code>.</p>
</div>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i '' 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n <em>my-cluster-operator-namespace</em></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Cluster Operator was successfully deployed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deploying-cluster-operator-to-watch-multiple-namespaces-str"><a class="link" href="#deploying-cluster-operator-to-watch-multiple-namespaces-str">Deploying the Cluster Operator to watch multiple namespaces</a></h5>
<div class="paragraph">
<p>This procedure shows how to deploy the Cluster Operator to watch Strimzi resources across multiple namespaces in your Kubernetes cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>This procedure requires use of a Kubernetes user account which is able to create <code>CustomResourceDefinitions</code>, <code>ClusterRoles</code> and <code>ClusterRoleBindings</code>.
Use of Role Base Access Control (RBAC) in the Kubernetes cluster usually means that permission to create, edit, and delete these resources is limited to Kubernetes cluster administrators, such as <code>system:admin</code>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the Strimzi installation files to use the namespace the Cluster Operator is going to be installed into.</p>
<div class="paragraph">
<p>For example, in this procedure the Cluster Operator is installed into the namespace <code><em>my-cluster-operator-namespace</em></code>.</p>
</div>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i '' 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file
to add a list of all the namespaces the Cluster Operator will watch to the <code>STRIMZI_NAMESPACE</code> environment variable.</p>
<div class="paragraph">
<p>For example, in this  procedure the Cluster Operator will watch the namespaces <code>watched-namespace-1</code>, <code>watched-namespace-2</code>, <code>watched-namespace-3</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
spec:
  # ...
  template:
    spec:
      serviceAccountName: strimzi-cluster-operator
      containers:
      - name: strimzi-cluster-operator
        image: quay.io/strimzi/operator:0.26.0
        imagePullPolicy: IfNotPresent
        env:
        - name: STRIMZI_NAMESPACE
          value: watched-namespace-1,watched-namespace-2,watched-namespace-3</code></pre>
</div>
</div>
</li>
<li>
<p>For each namespace listed, install the <code>RoleBindings</code>.</p>
<div class="paragraph">
<p>In this example, we replace <code><em>watched-namespace</em></code> in these commands with the namespaces listed in the previous step,
repeating them for <code>watched-namespace-1</code>, <code>watched-namespace-2</code>, <code>watched-namespace-3</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator/020-RoleBinding-strimzi-cluster-operator.yaml -n <em>watched-namespace</em>
kubectl create -f install/cluster-operator/031-RoleBinding-strimzi-cluster-operator-entity-operator-delegation.yaml -n <em>watched-namespace</em></code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n <em>my-cluster-operator-namespace</em></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Cluster Operator was successfully deployed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deploying-cluster-operator-to-watch-whole-cluster-str"><a class="link" href="#deploying-cluster-operator-to-watch-whole-cluster-str">Deploying the Cluster Operator to watch all namespaces</a></h5>
<div class="paragraph">
<p>This procedure shows how to deploy the Cluster Operator to watch Strimzi resources across all namespaces in your Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>When running in this mode, the Cluster Operator automatically manages clusters in any new namespaces that are created.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>This procedure requires use of a Kubernetes user account which is able to create <code>CustomResourceDefinitions</code>, <code>ClusterRoles</code> and <code>ClusterRoleBindings</code>.
Use of Role Base Access Control (RBAC) in the Kubernetes cluster usually means that permission to create, edit, and delete these resources is limited to Kubernetes cluster administrators, such as <code>system:admin</code>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the Strimzi installation files to use the namespace the Cluster Operator is going to be installed into.</p>
<div class="paragraph">
<p>For example, in this procedure the Cluster Operator is installed into the namespace <code><em>my-cluster-operator-namespace</em></code>.</p>
</div>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i '' 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to set the value of the <code>STRIMZI_NAMESPACE</code> environment variable to <code>*</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
spec:
  # ...
  template:
    spec:
      # ...
      serviceAccountName: strimzi-cluster-operator
      containers:
      - name: strimzi-cluster-operator
        image: quay.io/strimzi/operator:0.26.0
        imagePullPolicy: IfNotPresent
        env:
        - name: STRIMZI_NAMESPACE
          value: "*"
        # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create <code>ClusterRoleBindings</code> that grant cluster-wide access for all namespaces to the Cluster Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create clusterrolebinding strimzi-cluster-operator-namespaced --clusterrole=strimzi-cluster-operator-namespaced --serviceaccount <em>my-cluster-operator-namespace</em>:strimzi-cluster-operator
kubectl create clusterrolebinding strimzi-cluster-operator-entity-operator-delegation --clusterrole=strimzi-entity-operator --serviceaccount <em>my-cluster-operator-namespace</em>:strimzi-cluster-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code><em>my-cluster-operator-namespace</em></code> with the namespace you want to install the Cluster Operator into.</p>
</div>
</li>
<li>
<p>Deploy the Cluster Operator to your Kubernetes cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n <em>my-cluster-operator-namespace</em></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Cluster Operator was successfully deployed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deploying-cluster-operator-helm-chart-str"><a class="link" href="#deploying-cluster-operator-helm-chart-str">Deploying the Cluster Operator using a Helm Chart</a></h5>
<div class="paragraph">
<p>As an alternative to using the YAML deployment files,
this procedure shows how to deploy the Cluster Operator using a Helm chart provided with Strimzi.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Helm client must be installed on a local machine.</p>
</li>
<li>
<p>Helm must be installed to the Kubernetes cluster.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about Helm, see the <a href="https://helm.sh/" target="_blank" rel="noopener">Helm website</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the Strimzi Helm Chart repository:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm repo add strimzi https://strimzi.io/charts/</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator using the Helm command line tool:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm install strimzi/strimzi-kafka-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Cluster Operator has been deployed successfully using the Helm command line tool:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm ls</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="upgrading_the_cluster_operator_using_helm_chart"><a class="link" href="#upgrading_the_cluster_operator_using_helm_chart">Upgrading the Cluster Operator using Helm Chart</a></h6>
<div class="paragraph">
<p>To upgrade the Strimzi operator, you can use the <code>helm upgrade</code> command.
The <code>helm upgrade</code> command does not upgrade the <a href="https://helm.sh/docs/chart_best_practices/custom_resource_definitions/" target="_blank" rel="noopener">Custom Resource Definitions for Helm</a>.
Install the new CRDs manually after upgrading the Cluster Operator.
You can access the CRDs from <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub</a> or find them in the <code>crd</code> subdirectory inside the Helm Chart.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="deploying-cluster-operator-from-operator-hub-str"><a class="link" href="#deploying-cluster-operator-from-operator-hub-str">Deploying the Cluster Operator from OperatorHub.io</a></h5>
<div class="paragraph _abstract">
<p><a href="https://operatorhub.io/" target="_blank" rel="noopener">OperatorHub.io</a> is a catalog of Kubernetes Operators sourced from multiple providers.
It offers you an alternative way to install stable versions of Strimzi using the Strimzi Kafka Operator.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/operator-framework/operator-lifecycle-manager" target="_blank" rel="noopener">Operator Lifecycle Manager</a> is used for the installation and management of all Operators published on <a href="https://operatorhub.io/" target="_blank" rel="noopener">OperatorHub.io</a>.</p>
</div>
<div class="paragraph">
<p>To install Strimzi from <a href="https://operatorhub.io/" target="_blank" rel="noopener">OperatorHub.io</a>, locate the <em>Strimzi Kafka Operator</em> and follow the instructions provided.</p>
</div>
<div class="paragraph">
<p>Upgrades between versions might include manual steps.
Always read the release notes before upgrading.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Make sure you use the appropriate update channel.
Installing Strimzi from the default <em>stable</em> channel is generally safe.
However, we do not recommend enabling <em>automatic</em> OLM updates on the stable channel.
An automatic upgrade will skip any necessary steps prior to upgrade.
For example, to upgrade from 0.22 or earlier
you must first <a href="#assembly-upgrade-resources-str">update custom resources to support the <code>v1beta2</code> API version</a>.
Use automatic upgrades only on version-specific channels.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="kafka-cluster-str"><a class="link" href="#kafka-cluster-str">4.1.2. Deploying Kafka</a></h4>
<div class="paragraph">
<p>Apache Kafka is an open-source distributed publish-subscribe messaging system for fault-tolerant real-time data feeds.</p>
</div>
<div class="paragraph">
<p>The procedures in this section show:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to use the Cluster Operator to deploy:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-kafka-cluster-str">An <em>ephemeral</em> or <em>persistent</em> Kafka cluster</a></p>
</li>
<li>
<p>The Topic Operator and User Operator by configuring the <code>Kafka</code> custom resource:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-the-topic-operator-using-the-cluster-operator-str">Topic Operator</a></p>
</li>
<li>
<p><a href="#deploying-the-user-operator-using-the-cluster-operator-str">User Operator</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Alternative standalone deployment procedures for the Topic Operator and User Operator:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-the-topic-operator-standalone-str">Deploy the standalone Topic Operator</a></p>
</li>
<li>
<p><a href="#deploying-the-user-operator-standalone-str">Deploy the standalone User Operator</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When installing Kafka, Strimzi also installs a ZooKeeper cluster and adds the necessary configuration to connect Kafka with ZooKeeper.</p>
</div>
<div class="sect4">
<h5 id="deploying-kafka-cluster-str"><a class="link" href="#deploying-kafka-cluster-str">Deploying the Kafka cluster</a></h5>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka cluster to your Kubernetes using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>Kafka</code> resource.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>.
For a Kafka deployment, the following examples are provided:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>kafka-persistent.yaml</code></dt>
<dd>
<p>Deploys a persistent cluster with three ZooKeeper and three Kafka nodes.</p>
</dd>
<dt class="hdlist1"><code>kafka-jbod.yaml</code></dt>
<dd>
<p>Deploys a persistent cluster with three ZooKeeper and three Kafka nodes (each using multiple persistent volumes).</p>
</dd>
<dt class="hdlist1"><code>kafka-persistent-single.yaml</code></dt>
<dd>
<p>Deploys a persistent cluster with a single ZooKeeper node and a single Kafka node.</p>
</dd>
<dt class="hdlist1"><code>kafka-ephemeral.yaml</code></dt>
<dd>
<p>Deploys an ephemeral cluster with three ZooKeeper and three Kafka nodes.</p>
</dd>
<dt class="hdlist1"><code>kafka-ephemeral-single.yaml</code></dt>
<dd>
<p>Deploys an ephemeral cluster with three ZooKeeper nodes and a single Kafka node.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In this procedure, we use the examples for an <em>ephemeral</em> and <em>persistent</em> Kafka cluster deployment.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Ephemeral cluster</dt>
<dd>
<p>In general, an ephemeral (or temporary) Kafka cluster is suitable for development and testing purposes, not for production. This deployment uses <code>emptyDir</code> volumes for storing broker information (for ZooKeeper) and topics or partitions (for Kafka). Using an <code>emptyDir</code> volume means that its content is strictly related to the pod life cycle and is deleted when the pod goes down.</p>
</dd>
<dt class="hdlist1">Persistent cluster</dt>
<dd>
<p>A persistent Kafka cluster uses <code>PersistentVolumes</code> to store ZooKeeper and Kafka data. The <code>PersistentVolume</code> is
acquired using a <code>PersistentVolumeClaim</code> to make it independent of the actual type of the <code>PersistentVolume</code>. For example, it can use
Amazon EBS volumes in Amazon AWS deployments without any changes in the YAML files. The <code>PersistentVolumeClaim</code> can use a <code>StorageClass</code> to trigger automatic volume provisioning.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The example YAML files specify the latest supported Kafka version, and configuration for its supported log message format version and inter-broker protocol version.
Updates to these properties are required when <a href="#assembly-upgrading-kafka-versions-str">upgrading Kafka</a>.</p>
</div>
<div class="paragraph">
<p>The example clusters are named <code>my-cluster</code> by default.
The cluster name is defined by the name of the resource and cannot be changed after the cluster has been deployed.
To change the cluster name before you deploy the cluster, edit the <code>Kafka.metadata.name</code> property of the <code>Kafka</code> resource in the relevant YAML file.</p>
</div>
<div class="listingblock">
<div class="title">Default cluster name and specified Kafka versions</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    version: 2.8.0
    #...
    config:
      #...
      log.message.format.version: 2.8
      inter.broker.protocol.version: 2.8
  # ...</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create and deploy an <em>ephemeral</em> or <em>persistent</em> cluster.</p>
<div class="paragraph">
<p>For development or testing, you might prefer to use an ephemeral cluster.
You can use a persistent cluster in any situation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To create and deploy an <em>ephemeral</em> cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/kafka-ephemeral.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>To create and deploy a <em>persistent</em> cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/kafka-persistent.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Verify that the Kafka cluster was successfully deployed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p><a href="./using.html#assembly-config-kafka-str" target="_blank" rel="noopener">Kafka cluster configuration</a></p>
</div>
</div>
<div class="sect4">
<h5 id="deploying-the-topic-operator-using-the-cluster-operator-str"><a class="link" href="#deploying-the-topic-operator-using-the-cluster-operator-str">Deploying the Topic Operator using the Cluster Operator</a></h5>
<div class="paragraph _abstract">
<p>This procedure describes how to deploy the Topic Operator using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>You configure the <code>entityOperator</code> property of the <code>Kafka</code> resource to include the <code>topicOperator</code>.
By default, the Topic Operator watches for <code>KafkaTopics</code> in the namespace of the Kafka cluster deployment.</p>
</div>
<div class="paragraph">
<p>If you want to use the Topic Operator with a Kafka cluster that is not managed by Strimzi,
you must <a href="#deploying-the-topic-operator-standalone-str">deploy the Topic Operator as a standalone component</a>.</p>
</div>
<div class="paragraph">
<p>For more information about configuring the <code>entityOperator</code> and <code>topicOperator</code> properties,
see <a href="./using.html#assembly-kafka-entity-operator-str" target="_blank" rel="noopener">Configuring the Entity Operator</a> in the <em>Using Strimzi</em> guide.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>entityOperator</code> properties of the <code>Kafka</code> resource to include <code>topicOperator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  #...
  entityOperator:
    <strong>topicOperator: {}</strong>
    userOperator: {}</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Topic Operator <code>spec</code> using the properties described in <a href="./using.html#type-EntityTopicOperatorSpec-reference" target="_blank" rel="noopener"><code>EntityTopicOperatorSpec</code> schema reference</a>.</p>
<div class="paragraph">
<p>Use an empty object (<code>{}</code>) if you want all properties to use their default values.</p>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="paragraph">
<p>Use <code>kubectl apply</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;your-file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deploying-the-user-operator-using-the-cluster-operator-str"><a class="link" href="#deploying-the-user-operator-using-the-cluster-operator-str">Deploying the User Operator using the Cluster Operator</a></h5>
<div class="paragraph _abstract">
<p>This procedure describes how to deploy the User Operator using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>You configure the <code>entityOperator</code> property of the <code>Kafka</code> resource to include the <code>userOperator</code>.
By default, the User Operator watches for <code>KafkaUsers</code> in the namespace of the Kafka cluster deployment.</p>
</div>
<div class="paragraph">
<p>If you want to use the User Operator with a Kafka cluster that is not managed by Strimzi,
you must <a href="#deploying-the-user-operator-standalone-str">deploy the User Operator as a standalone component</a>.</p>
</div>
<div class="paragraph">
<p>For more information about configuring the <code>entityOperator</code> and <code>userOperator</code> properties, see <a href="./using.html#assembly-kafka-entity-operator-str" target="_blank" rel="noopener">Configuring the Entity Operator</a> in the <em>Using Strimzi</em> guide.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>entityOperator</code> properties of the <code>Kafka</code> resource to include <code>userOperator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  #...
  entityOperator:
    topicOperator: {}
    <strong>userOperator: {}</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Configure the User Operator <code>spec</code> using the properties described in <a href="./using.html#type-EntityUserOperatorSpec-reference" target="_blank" rel="noopener"><code>EntityUserOperatorSpec</code> schema reference</a> in the <em>Using Strimzi</em> guide.</p>
<div class="paragraph">
<p>Use an empty object (<code>{}</code>) if you want all properties to use their default values.</p>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;your-file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deploy-standalone-operators_str"><a class="link" href="#deploy-standalone-operators_str">4.1.3. Alternative standalone deployment options for Strimzi Operators</a></h4>
<div class="paragraph _abstract">
<p>You can perform a standalone deployment of the Topic Operator and User Operator.
Consider a standalone deployment of these operators if you are using a Kafka cluster that is not managed by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>You deploy the operators to Kubernetes.
Kafka can be running outside of Kubernetes.
For example, you might be using a Kafka as a managed service.
You adjust the deployment configuration for the standalone operator to match the address of your Kafka cluster.</p>
</div>
<div class="sect4">
<h5 id="deploying-the-topic-operator-standalone-str"><a class="link" href="#deploying-the-topic-operator-standalone-str">Deploying the standalone Topic Operator</a></h5>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the Topic Operator as a standalone component for topic management.
You can use a standalone Topic Operator with a Kafka cluster that is not managed by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>A standalone deployment can operate with any Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Standalone deployment files are provided.
Configure the <code>05-Deployment-strimzi-topic-operator.yaml</code> deployment file to add the environment variables that enable the Topic Operator to connect to a Kafka cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You are running a Kafka cluster for the Topic Operator to connect to.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>env</code> properties in the <code>install/topic-operator/05-Deployment-strimzi-topic-operator.yaml</code> standalone deployment file.</p>
<div class="listingblock">
<div class="title">Example standalone Topic Operator deployment configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-topic-operator
  labels:
    app: strimzi
spec:
  # ...
  template:
    # ...
    spec:
      # ...
      containers:
        - name: strimzi-topic-operator
          # ...
          env:
            - name: STRIMZI_NAMESPACE <b class="conum">(1)</b>
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: STRIMZI_KAFKA_BOOTSTRAP_SERVERS <b class="conum">(2)</b>
              value: my-kafka-bootstrap-address:9092
            - name: STRIMZI_RESOURCE_LABELS <b class="conum">(3)</b>
              value: "strimzi.io/cluster=my-cluster"
            - name: STRIMZI_ZOOKEEPER_CONNECT <b class="conum">(4)</b>
              value: my-cluster-zookeeper-client:2181
            - name: STRIMZI_ZOOKEEPER_SESSION_TIMEOUT_MS <b class="conum">(5)</b>
              value: "18000"
            - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS <b class="conum">(6)</b>
              value: "120000"
            - name: STRIMZI_TOPIC_METADATA_MAX_ATTEMPTS <b class="conum">(7)</b>
              value: "6"
            - name: STRIMZI_LOG_LEVEL <b class="conum">(8)</b>
              value: INFO
            - name: STRIMZI_TLS_ENABLED <b class="conum">(9)</b>
              value: "false"
            - name: STRIMZI_JAVA_OPTS <b class="conum">(10)</b>
              value: "-Xmx=512M -Xms=256M"
            - name: STRIMZI_JAVA_SYSTEM_PROPERTIES <b class="conum">(11)</b>
              value: "-Djavax.net.debug=verbose -DpropertyName=value"
            - name: STRIMZI_PUBLIC_CA <b class="conum">(12)</b>
              value: "false"
            - name: STRIMZI_TLS_AUTH_ENABLED <b class="conum">(13)</b>
              value: "false"
            - name: STRIMZI_SASL_ENABLED <b class="conum">(14)</b>
              value: "false"
            - name: STRIMZI_SASL_USERNAME <b class="conum">(15)</b>
              value: "admin"
            - name: STRIMZI_SASL_PASSWORD <b class="conum">(16)</b>
              value: "password"
            - name: STRIMZI_SASL_MECHANISM <b class="conum">(17)</b>
              value: "scram-sha-512"
            - name: STRIMZI_SECURITY_PROTOCOL <b class="conum">(18)</b>
              value: "SSL"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kubernetes namespace for the Topic Operator to watch for <code>KafkaTopic</code> resources. Specify the namespace of the Kafka cluster.</p>
</li>
<li>
<p>The host and port pair of the bootstrap broker address to discover and connect to all brokers in the Kafka cluster.
Use a comma-separated list to specify two or three broker addresses in case a server is down.</p>
</li>
<li>
<p>The label selector to identify the <code>KafkaTopic</code> resources managed by the Topic Operator.</p>
</li>
<li>
<p>The host and port pair of the address to connect to the ZooKeeper cluster.
This must be the same ZooKeeper cluster that your Kafka cluster is using.</p>
</li>
<li>
<p>The ZooKeeper session timeout, in milliseconds.
The default is <code>18000</code> (18 seconds).</p>
</li>
<li>
<p>The interval between periodic reconciliations, in milliseconds.
The default is <code>120000</code> (2 minutes).</p>
</li>
<li>
<p>The number of attempts at getting topic metadata from Kafka.
The time between each attempt is defined as an exponential backoff.
Consider increasing this value when topic creation takes more time due to the number of partitions or replicas.
The default is <code>6</code> attempts.</p>
</li>
<li>
<p>The level for printing logging messages.
You can set the level to <code>ERROR</code>, <code>WARNING</code>, <code>INFO</code>, <code>DEBUG</code>, or <code>TRACE</code>.</p>
</li>
<li>
<p>Enables TLS support for encrypted communication with the Kafka brokers.</p>
</li>
<li>
<p>(Optional) The Java options used by the JVM running the Topic Operator.</p>
</li>
<li>
<p>(Optional) The debugging (<code>-D</code>) options set for the Topic Operator.</p>
</li>
<li>
<p>(Optional) Skips the generation of trust store certificates if TLS is enabled through <code>STRIMZI_TLS_ENABLED</code>. If this environment variable is enabled, the brokers must use a public trusted certificate authority for their TLS certificates.
The default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) Generates key store certificates for mutual TLS authentication. Setting this to <code>false</code> disables client authentication with TLS to the Kafka brokers.
The default is <code>true</code>.</p>
</li>
<li>
<p>(Optional) Enables SASL support for client authentication when connecting to Kafka brokers.
The default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) The SASL username for client authentication.
Mandatory only if SASL is enabled through <code>STRIMZI_SASL_ENABLED</code>.</p>
</li>
<li>
<p>(Optional) The SASL password for client authentication.
Mandatory only if SASL is enabled through <code>STRIMZI_SASL_ENABLED</code>.</p>
</li>
<li>
<p>(Optional) The SASL mechanism for client authentication.
Mandatory only if SASL is enabled through <code>STRIMZI_SASL_ENABLED</code>.
You can set the value to <code>plain</code>, <code>scram-sha-256</code>, or <code>scram-sha-512</code>.</p>
</li>
<li>
<p>(Optional) The security protocol used for communication with Kafka brokers.
The default value is "PLAINTEXT".
You can set the value to <code>PLAINTEXT</code>, <code>SSL</code>, <code>SASL_PLAINTEXT</code>, or <code>SASL_SSL</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you want to connect to Kafka brokers that are using certificates from a public certificate authority, set <code>STRIMZI_PUBLIC_CA</code> to <code>true</code>. Set this property to <code>true</code>, for example, if you are using Kafka on Amazon Web Services (AWS).</p>
</li>
<li>
<p>If you enabled TLS with the <code>STRIMZI_TLS_ENABLED</code> environment variable, specify the keystore and truststore used to authenticate connection to the Kafka cluster.</p>
<div class="listingblock">
<div class="title">Example TLS configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ....
env:
  - name: STRIMZI_TRUSTSTORE_LOCATION <b class="conum">(1)</b>
    value: "/path/to/truststore.p12"
  - name: STRIMZI_TRUSTSTORE_PASSWORD <b class="conum">(2)</b>
    value: "<em>TRUSTSTORE-PASSWORD</em>"
  - name: STRIMZI_KEYSTORE_LOCATION <b class="conum">(3)</b>
    value: "/path/to/keystore.p12"
  - name: STRIMZI_KEYSTORE_PASSWORD <b class="conum">(4)</b>
    value: "<em>KEYSTORE-PASSWORD</em>"
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The truststore contains the public key (<code>ca.crt</code>) value of the Certificate Authority used to sign new user certificates for TLS client authentication.</p>
</li>
<li>
<p>The password for accessing the truststore.</p>
</li>
<li>
<p>The keystore contains the private key (<code>ca.key</code>) of the Certificate Authority for signing new user certificates for TLS client authentication.</p>
</li>
<li>
<p>The password for accessing the keystore.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Deploy the Topic Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/topic-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Topic Operator has been deployed successfully.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe deployment strimzi-topic-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Topic Operator is deployed when the <code>Replicas</code> entry shows <code>1 available</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You may experience a delay with the deployment if you have a slow connection to the Kubernetes cluster and the Topic Operator images have not been downloaded before.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deploying-the-user-operator-standalone-str"><a class="link" href="#deploying-the-user-operator-standalone-str">Deploying the standalone User Operator</a></h5>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the User Operator as a standalone component for user management.
You can use a standalone User Operator with a Kafka cluster that is not managed by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>A standalone deployment can operate with any Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Standalone deployment files are provided.
Edit the <code>05-Deployment-strimzi-user-operator.yaml</code> deployment file to add the environment variables that enable the User Operator to connect to a Kafka cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You are running a Kafka cluster for the User Operator to connect to.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the following <code>env</code> properties in the <code>install/user-operator/05-Deployment-strimzi-user-operator.yaml</code> standalone deployment file.</p>
<div class="listingblock">
<div class="title">Example standalone User Operator deployment configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-user-operator
  labels:
    app: strimzi
spec:
  # ...
  template:
    # ...
    spec:
      # ...
      containers:
        - name: strimzi-user-operator
          # ...
          env:
            - name: STRIMZI_NAMESPACE <b class="conum">(1)</b>
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: STRIMZI_KAFKA_BOOTSTRAP_SERVERS <b class="conum">(2)</b>
              value: my-kafka-bootstrap-address:9092
            - name: STRIMZI_CA_CERT_NAME <b class="conum">(3)</b>
              value: my-cluster-clients-ca-cert
            - name: STRIMZI_CA_KEY_NAME <b class="conum">(4)</b>
              value: my-cluster-clients-ca
            - name: STRIMZI_LABELS <b class="conum">(5)</b>
              value: "strimzi.io/cluster=my-cluster"
            - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS <b class="conum">(6)</b>
              value: "120000"
            - name: STRIMZI_LOG_LEVEL <b class="conum">(7)</b>
              value: INFO
            - name: STRIMZI_GC_LOG_ENABLED <b class="conum">(8)</b>
              value: "true"
            - name: STRIMZI_CA_VALIDITY <b class="conum">(9)</b>
              value: "365"
            - name: STRIMZI_CA_RENEWAL <b class="conum">(10)</b>
              value: "30"
            - name: STRIMZI_JAVA_OPTS <b class="conum">(11)</b>
              value: "-Xmx=512M -Xms=256M"
            - name: STRIMZI_JAVA_SYSTEM_PROPERTIES <b class="conum">(12)</b>
              value: "-Djavax.net.debug=verbose -DpropertyName=value"
            - name: STRIMZI_SECRET_PREFIX <b class="conum">(13)</b>
              value: "kafka-"
            - name: STRIMZI_ACLS_ADMIN_API_SUPPORTED <b class="conum">(14)</b>
              value: "true"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kubernetes namespace for the User Operator to watch for <code>KafkaUser</code> resources. Only one namespace can be specified.</p>
</li>
<li>
<p>The host and port pair of the bootstrap broker address to discover and connect to all brokers in the Kafka cluster.
Use a comma-separated list to specify two or three broker addresses in case a server is down.</p>
</li>
<li>
<p>The Kubernetes <code>Secret</code> that contains the public key (<code>ca.crt</code>) value of the Certificate Authority that signs new user certificates for TLS client authentication.</p>
</li>
<li>
<p>The Kubernetes <code>Secret</code> that contains the private key (<code>ca.key</code>) value of the Certificate Authority that signs new user certificates for TLS client authentication.</p>
</li>
<li>
<p>The label selector used to identify the <code>KafkaUser</code> resources managed by the User Operator.</p>
</li>
<li>
<p>The interval between periodic reconciliations, in milliseconds.
The default is <code>120000</code> (2 minutes).
The default is <code>18000</code> (18 seconds).</p>
</li>
<li>
<p>The level for printing logging messages.
You can set the level to <code>ERROR</code>, <code>WARNING</code>, <code>INFO</code>, <code>DEBUG</code>, or <code>TRACE</code>.</p>
</li>
<li>
<p>Enables garbage collection (GC) logging.
The default is <code>true</code>.</p>
</li>
<li>
<p>The validity period for the Certificate Authority.
The default is <code>365</code> days.</p>
</li>
<li>
<p>The renewal period for the Certificate Authority. The renewal period is measured backwards from the expiry date of the current certificate.
The default is <code>30</code> days to initiate certificate renewal before the old certificates expire.</p>
</li>
<li>
<p>(Optional) The Java options used by the JVM running the User Operator</p>
</li>
<li>
<p>(Optional) The debugging (<code>-D</code>) options set for the User Operator</p>
</li>
<li>
<p>(Optional) Prefix for the names of Kubernetes secrets created by the User Operator.</p>
</li>
<li>
<p>(Optional) Indicates whether the Kafka cluster supports management of authorization ACL rules using the Kafka Admin API.
When set to <code>false</code>, the User Operator will reject all resources with <code>simple</code> authorization ACL rules.
This helps to avoid unnecessary exceptions in the Kafka cluster logs.
The default is <code>true</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you are using TLS to connect to the Kafka cluster, specify the secrets used to authenticate connection.
Otherwise, go to the next step.</p>
<div class="listingblock">
<div class="title">Example TLS configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ....
env:
  - name: STRIMZI_CLUSTER_CA_CERT_SECRET_NAME <b class="conum">(1)</b>
    value: my-cluster-cluster-cert
  - name: STRIMZI_EO_KEY_SECRET_NAME <b class="conum">(2)</b>
    value: my-cluster-cluster-ca
# ..."</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kubernetes <code>Secret</code> that contains the public key (<code>ca.crt</code>) value of the Certificate Authority that signs Kafka broker certificates for TLS client authentication.</p>
</li>
<li>
<p>The Kubernetes <code>Secret</code> that contains the keystore (<code>entity-operator_.p12</code>) with the private key and certificate for TLS authentication against the Kafka cluster.
The <code>Secret</code> must also contain the password (<code>entity-operator_.password</code>) for accessing the keystore.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Deploy the User Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/user-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the User Operator has been deployed successfully.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe deployment strimzi-user-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>The User Operator is deployed when the <code>Replicas</code> entry shows <code>1 available</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You might experience a delay with the deployment if you have a slow connection to the Kubernetes cluster and the User Operator images have not been downloaded before.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-connect-str"><a class="link" href="#kafka-connect-str">4.2. Deploy Kafka Connect</a></h3>
<div class="paragraph">
<p><a href="https://kafka.apache.org/documentation/#connect" target="_blank" rel="noopener">Kafka Connect</a> is a tool for streaming data between Apache Kafka and external systems.</p>
</div>
<div class="paragraph">
<p>In Strimzi, Kafka Connect is deployed in distributed mode.
Kafka Connect can also work in standalone mode, but this is not supported by Strimzi.</p>
</div>
<div class="paragraph">
<p>Using the concept of <em>connectors</em>, Kafka Connect provides a framework for moving large amounts of data into and out of your Kafka cluster while maintaining scalability and reliability.</p>
</div>
<div class="paragraph">
<p>Kafka Connect is typically used to integrate Kafka with external databases and storage and messaging systems.</p>
</div>
<div class="paragraph">
<p>The procedures in this section show how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-kafka-connect-str">Deploy a Kafka Connect cluster using a <code>KafkaConnect</code> resource</a></p>
</li>
<li>
<p><a href="#con-kafka-connect-multiple-instances-str">Run multiple Kafka Connect instances</a></p>
</li>
<li>
<p><a href="#using-kafka-connect-with-plug-ins-str">Create a Kafka Connect image containing the connectors you need to make your connection</a></p>
</li>
<li>
<p><a href="#con-creating-managing-connectors-str">Create and manage connectors using a KafkaConnector resource or the Kafka Connect REST API</a></p>
</li>
<li>
<p><a href="#proc-deploying-kafkaconnector-str">Deploy a KafkaConnector resource to Kafka Connect</a></p>
</li>
<li>
<p><a href="#proc-manual-restart-connector-str">Restart a Kafka connector by annotating a KafkaConnector resource</a></p>
</li>
<li>
<p><a href="#proc-manual-restart-connector-task-str">Restart a Kafka connector task by annotating a KafkaConnector resource</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The term <em>connector</em> is used interchangeably to mean a connector instance running within a Kafka Connect cluster, or a connector class.
In this guide, the term <em>connector</em> is used when the meaning is clear from the context.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="deploying-kafka-connect-str"><a class="link" href="#deploying-kafka-connect-str">4.2.1. Deploying Kafka Connect to your Kubernetes cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka Connect cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>A Kafka Connect cluster is implemented as a <code>Deployment</code> with a configurable number of nodes (also called <em>workers</em>) that distribute the workload of connectors as <em>tasks</em> so that the message flow is highly scalable and reliable.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaConnect</code> resource.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>.
In this procedure, we use the following example file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/connect/kafka-connect.yaml</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p><a href="#deploying-kafka-cluster-str">Running Kafka cluster.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Kafka Connect to your Kubernetes cluster.
Use the <code>examples/connect/kafka-connect.yaml</code> file to deploy Kafka Connect.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/connect/kafka-connect.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that Kafka Connect was successfully deployed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p><a href="./using.html#assembly-kafka-connect-str" target="_blank" rel="noopener">Kafka Connect cluster configuration</a></p>
</div>
</div>
<div class="sect3">
<h4 id="con-kafka-connect-multiple-instances-str"><a class="link" href="#con-kafka-connect-multiple-instances-str">4.2.2. Kafka Connect configuration for multiple instances</a></h4>
<div class="paragraph">
<p>If you are running multiple instances of Kafka Connect, you have to change the default configuration of the following <code>config</code> properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect
spec:
  # ...
  config:
    group.id: connect-cluster <b class="conum">(1)</b>
    offset.storage.topic: connect-cluster-offsets <b class="conum">(2)</b>
    config.storage.topic: connect-cluster-configs <b class="conum">(3)</b>
    status.storage.topic: connect-cluster-status  <b class="conum">(4)</b>
    # ...
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Kafka Connect cluster group that the instance belongs to.</p>
</li>
<li>
<p>Kafka topic that stores connector offsets.</p>
</li>
<li>
<p>Kafka topic that stores connector and task status configurations.</p>
</li>
<li>
<p>Kafka topic that stores connector and task status updates.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Values for the three topics must be the same for all Kafka Connect instances with the same <code>group.id</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unless you change the default settings, each Kafka Connect instance connecting to the same Kafka cluster is deployed with the same values.
What happens, in effect, is all instances are coupled to run in a cluster and use the same topics.</p>
</div>
<div class="paragraph">
<p>If multiple Kafka Connect clusters try to use the same topics, Kafka Connect will not work as expected and generate errors.</p>
</div>
<div class="paragraph">
<p>If you wish to run multiple Kafka Connect instances, change the values of these properties for each instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-kafka-connect-with-plug-ins-str"><a class="link" href="#using-kafka-connect-with-plug-ins-str">4.2.3. Extending Kafka Connect with connector plug-ins</a></h4>
<div class="paragraph">
<p>The Strimzi container images for Kafka Connect include two built-in file connectors for moving file-based data into and out of your Kafka cluster.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. File connectors</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File Connector</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FileStreamSourceConnector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transfers data to your Kafka cluster from a file (the source).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FileStreamSinkConnector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transfers data from your Kafka cluster to a file (the sink).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The procedures in this section show how to add your own connector classes to connector images by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-new-image-using-kafka-connect-build-str">Creating a new container image automatically using Strimzi</a></p>
</li>
<li>
<p><a href="#creating-new-image-from-base-str">Creating a container image from the Kafka Connect base image (manually or using continuous integration)</a></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You create the configuration for connectors directly <a href="#con-creating-managing-connectors-str">using the Kafka Connect REST API or KafkaConnector custom resources</a>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="creating-new-image-using-kafka-connect-build-str"><a class="link" href="#creating-new-image-using-kafka-connect-build-str">Creating a new container image automatically using Strimzi</a></h5>
<div class="paragraph">
<p>This procedure shows how to configure Kafka Connect so that Strimzi automatically builds a new container image with additional connectors.
You define the connector plugins using the <code>.spec.build.plugins</code> property of the <code>KafkaConnect</code> custom resource.
Strimzi will automatically download and add the connector plugins into a new container image.
The container is pushed into the container repository specified in <code>.spec.build.output</code> and automatically used in the Kafka Connect deployment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p>A container registry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You need to provide your own container registry where images can be pushed to, stored, and pulled from.
Strimzi supports private container registries as well as public registries such as <a href="https://quay.io/" target="_blank" rel="noopener">Quay</a> or <a href="https://hub.docker.com//" target="_blank" rel="noopener">Docker Hub</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaConnect</code> custom resource by specifying the container registry in <code>.spec.build.output</code>, and additional connectors in <code>.spec.build.plugins</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
spec: <b class="conum">(1)</b>
  #...
  build:
    output: <b class="conum">(2)</b>
      type: docker
      image: my-registry.io/my-org/my-connect-cluster:latest
      pushSecret: my-registry-credentials
    plugins: <b class="conum">(3)</b>
      - name: debezium-postgres-connector
        artifacts:
          - type: tgz
            url: https://repo1.maven.org/maven2/io/debezium/debezium-connector-postgres/1.3.1.Final/debezium-connector-postgres-1.3.1.Final-plugin.tar.gz
            sha512sum: 962a12151bdf9a5a30627eebac739955a4fd95a08d373b86bdcea2b4d0c27dd6e1edd5cb548045e115e33a9e69b1b2a352bee24df035a0447cb820077af00c03
      - name: camel-telegram
        artifacts:
          - type: tgz
            url: https://repo.maven.apache.org/maven2/org/apache/camel/kafkaconnector/camel-telegram-kafka-connector/0.7.0/camel-telegram-kafka-connector-0.7.0-package.tar.gz
            sha512sum: a9b1ac63e3284bea7836d7d24d84208c49cdf5600070e6bd1535de654f6920b74ad950d51733e8020bf4187870699819f54ef5859c7846ee4081507f48873479
  #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><a href="./using.html#type-KafkaConnectSpec-reference" target="_blank" rel="noopener">The specification for the Kafka Connect cluster</a>.</p>
</li>
<li>
<p>(Required) Configuration of the container registry where new images are pushed.</p>
</li>
<li>
<p>(Required) List of connector plugins and their artifacts to add to the new container image. Each plugin must be configured with at least one <code>artifact</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>$ kubectl apply -f <em>KAFKA-CONNECT-CONFIG-FILE</em></code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the new container image to build, and for the Kafka Connect cluster to be deployed.</p>
</li>
<li>
<p>Use the Kafka Connect REST API or the KafkaConnector custom resources to use the connector plugins you added.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Additional resources</div>
<p>See the <em>Using Strimzi</em> guide for more information on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./using.html#type-Build-reference" target="_blank" rel="noopener">Kafka Connect <code>Build</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="creating-new-image-from-base-str"><a class="link" href="#creating-new-image-from-base-str">Creating a Docker image from the Kafka Connect base image</a></h5>
<div class="paragraph">
<p>This procedure shows how to create a custom image and add it to the <code>/opt/kafka/plugins</code> directory.</p>
</div>
<div class="paragraph">
<p>You can use the Kafka container image on <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a> as a base image for creating your own custom image with additional connector plug-ins.</p>
</div>
<div class="paragraph">
<p>At startup, the Strimzi version of Kafka Connect loads any third-party connector plug-ins contained in the <code>/opt/kafka/plugins</code> directory.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new <code>Dockerfile</code> using <code>quay.io/strimzi/kafka:0.26.0-kafka-2.8.0</code> as the base image:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>FROM quay.io/strimzi/kafka:0.26.0-kafka-2.8.0
USER root:root
COPY ./<em>my-plugins</em>/ /opt/kafka/plugins/
USER 1001</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example plug-in file</div>
<div class="content">
<pre class="highlightjs highlight"><code>$ tree ./<em>my-plugins</em>/
./<em>my-plugins</em>/
 debezium-connector-mongodb
  bson-3.4.2.jar
  CHANGELOG.md
  CONTRIBUTE.md
  COPYRIGHT.txt
  debezium-connector-mongodb-0.7.1.jar
  debezium-core-0.7.1.jar
  LICENSE.txt
  mongodb-driver-3.4.2.jar
  mongodb-driver-core-3.4.2.jar
  README.md
 debezium-connector-mysql
  CHANGELOG.md
  CONTRIBUTE.md
  COPYRIGHT.txt
  debezium-connector-mysql-0.7.1.jar
  debezium-core-0.7.1.jar
  LICENSE.txt
  mysql-binlog-connector-java-0.13.0.jar
  mysql-connector-java-5.1.40.jar
  README.md
  wkb-1.0.2.jar
 debezium-connector-postgres
     CHANGELOG.md
     CONTRIBUTE.md
     COPYRIGHT.txt
     debezium-connector-postgres-0.7.1.jar
     debezium-core-0.7.1.jar
     LICENSE.txt
     postgresql-42.0.0.jar
     protobuf-java-2.6.1.jar
     README.md</code></pre>
</div>
</div>
</li>
<li>
<p>Build the container image.</p>
</li>
<li>
<p>Push your custom image to your container registry.</p>
</li>
<li>
<p>Point to the new container image.</p>
<div class="paragraph">
<p>You can either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Edit the <code>KafkaConnect.spec.image</code> property of the <code>KafkaConnect</code> custom resource.</p>
<div class="paragraph">
<p>If set, this property overrides the <code>STRIMZI_KAFKA_CONNECT_IMAGES</code> variable in the Cluster Operator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
spec: <b class="conum">(1)</b>
  #...
  image: my-new-container-image <b class="conum">(2)</b>
  config: <b class="conum">(3)</b>
    #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><a href="./using.html#type-KafkaConnectSpec-reference" target="_blank" rel="noopener">The specification for the Kafka Connect cluster</a>.</p>
</li>
<li>
<p>The docker image for the pods.</p>
</li>
<li>
<p>Configuration of the Kafka Connect <em>workers</em> (not connectors).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>or</p>
</div>
</li>
<li>
<p>In the <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file, edit the <code>STRIMZI_KAFKA_CONNECT_IMAGES</code> variable to point to the new container image, and then reinstall the Cluster Operator.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Additional resources</div>
<p>See the <em>Using Strimzi</em> guide for more information on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./using.html#con-common-configuration-images-reference" target="_blank" rel="noopener">Container image configuration and the <code>KafkaConnect.spec.image property</code></a></p>
</li>
<li>
<p><a href="./using.html#ref-operator-cluster-str" target="_blank" rel="noopener">Cluster Operator configuration and the <code>STRIMZI_KAFKA_CONNECT_IMAGES</code> variable</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3 _abstract">
<h4 id="con-creating-managing-connectors-str"><a class="link" href="#con-creating-managing-connectors-str">4.2.4. Creating and managing connectors</a></h4>
<div class="paragraph">
<p>When you have created a container image for your connector plug-in, you need to create a connector instance in your Kafka Connect cluster.
You can then configure, monitor, and manage a running connector instance.</p>
</div>
<div class="paragraph">
<p>A connector is an instance of a particular <em>connector class</em> that knows how to communicate with the relevant external system in terms of messages.
Connectors are available for many external systems, or you can create your own.</p>
</div>
<div class="paragraph">
<p>You can create <em>source</em> and <em>sink</em> types of connector.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Source connector</dt>
<dd>
<p>A source connector is a runtime entity that fetches data from an external system and feeds it to Kafka as messages.</p>
</dd>
<dt class="hdlist1">Sink connector</dt>
<dd>
<p>A sink connector is a runtime entity that fetches messages from Kafka topics and feeds them to an external system.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Strimzi provides two APIs for creating and managing connectors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>KafkaConnector resources (referred to as KafkaConnectors)</p>
</li>
<li>
<p>Kafka Connect REST API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the APIs, you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check the status of a connector instance</p>
</li>
<li>
<p>Reconfigure a running connector</p>
</li>
<li>
<p>Increase or decrease the number of connector tasks for a connector instance</p>
</li>
<li>
<p>Restart connectors</p>
</li>
<li>
<p>Restart connector tasks, including failed tasks</p>
</li>
<li>
<p>Pause a connector instance</p>
</li>
<li>
<p>Resume a previously paused connector instance</p>
</li>
<li>
<p>Delete a connector instance</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="kafkaconnector_resources"><a class="link" href="#kafkaconnector_resources">KafkaConnector resources</a></h5>
<div class="paragraph">
<p>KafkaConnectors allow you to create and manage connector instances for Kafka Connect in a Kubernetes-native way, so an HTTP client such as cURL is not required.
Like other Kafka resources, you declare a connectors desired state in a KafkaConnector YAML file that is deployed to your Kubernetes cluster to create the connector instance.
KafkaConnector resources must be deployed to the same namespace as the Kafka Connect cluster they link to.</p>
</div>
<div class="paragraph">
<p>You manage a running connector instance by updating its corresponding KafkaConnector resource, and then applying the updates.
Annotations are used to manually restart connector instances and connector tasks.
You remove a connector by deleting its corresponding KafkaConnector.</p>
</div>
<div class="paragraph">
<p>To ensure compatibility with earlier versions of Strimzi, KafkaConnectors are disabled by default. To enable them for a Kafka Connect cluster, you must use annotations on the <code>KafkaConnect</code> resource.
For instructions, see <a href="./using.html#proc-kafka-connect-config-str" target="_blank" rel="noopener">Configuring Kafka Connect</a> in the <em>Using Strimzi</em> guide.</p>
</div>
<div class="paragraph">
<p>When KafkaConnectors are enabled, the Cluster Operator begins to watch for them. It updates the configurations of running connector instances to match the configurations defined in their KafkaConnectors.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>, including the following example <code>KafkaConnector</code> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/connect/source-connector.yaml</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use this example to create and manage a <code>FileStreamSourceConnector</code> and a <code>FileStreamSinkConnector</code> as described in <a href="#proc-deploying-kafkaconnector-str">Deploying the example KafkaConnector resources</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="availability_of_the_kafka_connect_rest_api"><a class="link" href="#availability_of_the_kafka_connect_rest_api">Availability of the Kafka Connect REST API</a></h5>
<div class="paragraph">
<p>The Kafka Connect REST API is available on port 8083 as the <code>&lt;connect-cluster-name&gt;-connect-api</code> service.</p>
</div>
<div class="paragraph">
<p>If KafkaConnectors are enabled, manual changes made directly using the Kafka Connect REST API are reverted by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The operations supported by the REST API are described in the <a href="https://kafka.apache.org/documentation/#connect_rest" target="_blank" rel="noopener">Apache Kafka documentation</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-deploying-kafkaconnector-str"><a class="link" href="#proc-deploying-kafkaconnector-str">4.2.5. Deploying the example KafkaConnector resources</a></h4>
<div class="paragraph _abstract">
<p>Use KafkaConnectors with Kafka Connect to stream data to and from a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>.
In this procedure, we use the following example file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/connect/source-connector.yaml</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The file is used to create the following connector instances:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>FileStreamSourceConnector</code> instance that reads each line from the Kafka license file (the source) and writes the data as messages to a single Kafka topic.</p>
</li>
<li>
<p>A <code>FileStreamSinkConnector</code> instance that reads messages from the Kafka topic and writes the messages to a temporary file (the sink).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>In a production environment, you prepare container images containing your desired Kafka Connect connectors, as described in <a href="#using-kafka-connect-with-plug-ins-str">Extending Kafka Connect with connector plug-ins</a>.</p>
</div>
<div class="paragraph">
<p>The <code>FileStreamSourceConnector</code> and <code>FileStreamSinkConnector</code> are provided as examples. Running these connectors in containers as described here is unlikely to be suitable for production use cases.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kafka Connect deployment</p>
</li>
<li>
<p><a href="./using.html#proc-kafka-connect-config-str" target="_blank" rel="noopener">KafkaConnectors are enabled in the Kafka Connect deployment</a></p>
</li>
<li>
<p>The Cluster Operator is running</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>examples/connect/source-connector.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-source-connector <b class="conum">(1)</b>
  labels:
    strimzi.io/cluster: my-connect-cluster <b class="conum">(2)</b>
spec:
  class: org.apache.kafka.connect.file.FileStreamSourceConnector <b class="conum">(3)</b>
  tasksMax: 2 <b class="conum">(4)</b>
  config: <b class="conum">(5)</b>
    file: "/opt/kafka/LICENSE" <b class="conum">(6)</b>
    topic: my-topic <b class="conum">(7)</b>
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the KafkaConnector resource, which is used as the name of the connector. Use any name that is valid for a Kubernetes resource.</p>
</li>
<li>
<p>Name of the Kafka Connect cluster to create the connector instance in. Connectors must be deployed to the same namespace as the Kafka Connect cluster they link to.</p>
</li>
<li>
<p>Full name or alias of the connector class. This should be present in the image being used by the Kafka Connect cluster.</p>
</li>
<li>
<p>Maximum number of Kafka Connect <code>Tasks</code> that the connector can create.</p>
</li>
<li>
<p><a href="#kafkaconnector-configs">Connector configuration</a> as key-value pairs.</p>
</li>
<li>
<p>This example source connector configuration reads data from the <code>/opt/kafka/LICENSE</code> file.</p>
</li>
<li>
<p>Kafka topic to publish the source data to.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the source <code>KafkaConnector</code> in your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/connect/source-connector.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Create an <code>examples/connect/sink-connector.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">touch examples/connect/sink-connector.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Paste the following YAML into the <code>sink-connector.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-sink-connector
  labels:
    strimzi.io/cluster: my-connect
spec:
  class: org.apache.kafka.connect.file.FileStreamSinkConnector <b class="conum">(1)</b>
  tasksMax: 2
  config: <b class="conum">(2)</b>
    file: "/tmp/my-file" <b class="conum">(3)</b>
    topics: my-topic <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Full name or alias of the connector class. This should be present in the image being used by the Kafka Connect cluster.</p>
</li>
<li>
<p><a href="#kafkaconnector-configs">Connector configuration</a> as key-value pairs.</p>
</li>
<li>
<p>Temporary file to publish the source data to.</p>
</li>
<li>
<p>Kafka topic to read the source data from.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the sink <code>KafkaConnector</code> in your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/connect/sink-connector.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the connector resources were created:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kctr --selector strimzi.io/cluster=<em>MY-CONNECT-CLUSTER</em> -o name

my-source-connector
my-sink-connector</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>MY-CONNECT-CLUSTER</em> with your Kafka Connect cluster.</p>
</div>
</li>
<li>
<p>In the container, execute <code>kafka-console-consumer.sh</code> to read the messages that were written to the topic by the source connector:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec <em>MY-CLUSTER</em>-kafka-0 -i -t -- bin/kafka-console-consumer.sh --bootstrap-server <em>MY-CLUSTER</em>-kafka-bootstrap.<em>NAMESPACE</em>.svc:9092 --topic my-topic --from-beginning</code></pre>
</div>
</div>
</li>
</ol>
</div>
<h5 id="kafkaconnector-configs" class="discrete">Source and sink connector configuration options</h5>
<div class="paragraph">
<p>The connector configuration is defined in the <code>spec.config</code> property of the KafkaConnector resource.</p>
</div>
<div class="paragraph">
<p>The <code>FileStreamSourceConnector</code> and <code>FileStreamSinkConnector</code> classes support the same configuration options as the Kafka Connect REST API.
Other connectors support different configuration options.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Configuration options for the <code>FileStreamSource</code> connector class</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>file</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source file to write messages to. If not specified, the standard input is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Kafka topic to publish data to.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Configuration options for <code>FileStreamSinkConnector</code> class</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>file</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination file to write messages to. If not specified, the standard output is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more Kafka topics to read data from.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topics.regex</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A regular expression matching one or more Kafka topics to read data from.</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-creating-managing-connectors-str">Creating and managing connectors</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-manual-restart-connector-str"><a class="link" href="#proc-manual-restart-connector-str">4.2.6. Performing a restart of a Kafka connector</a></h4>
<div class="paragraph">
<p>This procedure describes how to manually trigger a restart of a Kafka connector by using a Kubernetes annotation.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaConnector</code> custom resource that controls the Kafka connector you want to restart:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaConnector</code></pre>
</div>
</div>
</li>
<li>
<p>To restart the connector, annotate the <code>KafkaConnector</code> resource in Kubernetes.
For example, using <code>kubectl annotate</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaConnector <em>KAFKACONNECTOR-NAME</em> strimzi.io/restart=true</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).</p>
<div class="paragraph">
<p>The Kafka connector is restarted, as long as the annotation was detected by the reconciliation process.
When Kafka Connect accepts the restart request, the annotation is removed from the <code>KafkaConnector</code> custom resource.</p>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./deploying.html#con-creating-managing-connectors-str" target="_blank" rel="noopener">Creating and managing connectors</a> in the <em>Deploying and Upgrading</em> guide.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-manual-restart-connector-task-str"><a class="link" href="#proc-manual-restart-connector-task-str">4.2.7. Performing a restart of a Kafka connector task</a></h4>
<div class="paragraph">
<p>This procedure describes how to manually trigger a restart of a Kafka connector task by using a Kubernetes annotation.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaConnector</code> custom resource that controls the Kafka connector task you want to restart:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaConnector</code></pre>
</div>
</div>
</li>
<li>
<p>Find the ID of the task to be restarted from the <code>KafkaConnector</code> custom resource.
Task IDs are non-negative integers, starting from 0.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe KafkaConnector <em>KAFKACONNECTOR-NAME</em></code></pre>
</div>
</div>
</li>
<li>
<p>To restart the connector task, annotate the <code>KafkaConnector</code> resource in Kubernetes.
For example, using <code>kubectl annotate</code> to restart task 0:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaConnector <em>KAFKACONNECTOR-NAME</em> strimzi.io/restart-task=0</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).</p>
<div class="paragraph">
<p>The Kafka connector task is restarted, as long as the annotation was detected by the reconciliation process.
When Kafka Connect accepts the restart request, the annotation is removed from the <code>KafkaConnector</code> custom resource.</p>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./deploying.html#con-creating-managing-connectors-str" target="_blank" rel="noopener">Creating and managing connectors</a> in the <em>Deploying and Upgrading</em> guide.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-mirror-maker-str"><a class="link" href="#kafka-mirror-maker-str">4.3. Deploy Kafka MirrorMaker</a></h3>
<div class="paragraph">
<p>The Cluster Operator deploys one or more Kafka MirrorMaker replicas to replicate data between Kafka clusters.
This process is called mirroring to avoid confusion with the Kafka partitions replication concept.
MirrorMaker consumes messages from the source cluster and republishes those messages to the target cluster.</p>
</div>
<div class="sect3">
<h4 id="deploying-kafka-mirror-maker-str"><a class="link" href="#deploying-kafka-mirror-maker-str">4.3.1. Deploying Kafka MirrorMaker to your Kubernetes cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka MirrorMaker cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaMirrorMaker</code> or <code>KafkaMirrorMaker2</code> resource depending on the version of MirrorMaker deployed.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>.
In this procedure, we use the following example files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/mirror-maker/kafka-mirror-maker.yaml</code></p>
</li>
<li>
<p><code>examples/mirror-maker/kafka-mirror-maker-2.yaml</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Kafka MirrorMaker to your Kubernetes cluster:</p>
<div class="paragraph">
<p>For MirrorMaker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/mirror-maker/kafka-mirror-maker.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>For MirrorMaker 2.0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/mirror-maker/kafka-mirror-maker-2.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that MirrorMaker was successfully deployed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./using.html#assembly-deployment-configuration-kafka-mirror-maker-str" target="_blank" rel="noopener">Kafka MirrorMaker cluster configuration</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-bridge-str"><a class="link" href="#kafka-bridge-str">4.4. Deploy Kafka Bridge</a></h3>
<div class="paragraph">
<p>The Cluster Operator deploys one or more Kafka bridge replicas to send data between Kafka clusters and clients via HTTP API.</p>
</div>
<div class="sect3">
<h4 id="deploying-kafka-bridge-str"><a class="link" href="#deploying-kafka-bridge-str">4.4.1. Deploying Kafka Bridge to your Kubernetes cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka Bridge cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaBridge</code> resource.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>.
In this procedure, we use the following example file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/bridge/kafka-bridge.yaml</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Kafka Bridge to your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/bridge/kafka-bridge.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that Kafka Bridge was successfully deployed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p><a href="./using.html#assembly-config-kafka-bridge-str" target="_blank" rel="noopener">Kafka Bridge cluster configuration</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-verify_str"><a class="link" href="#deploy-verify_str">5. Setting up client access to the Kafka cluster</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>After you have <a href="#deploy-tasks_str">deployed Strimzi</a>, the procedures in this section explain how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploy example producer and consumer clients, which you can use to verify your deployment</p>
</li>
<li>
<p>Set up external client access to the Kafka cluster</p>
<div class="paragraph">
<p>The steps to set up access to the Kafka cluster for a client outside Kubernetes are more complex,
and require familiarity with the <a href="./using.html#assembly-deployment-configuration-str" target="_blank" rel="noopener">Kafka component configuration procedures</a> described in the <em>Using Strimzi</em> guide.</p>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="deploying-example-clients-str"><a class="link" href="#deploying-example-clients-str">5.1. Deploying example clients</a></h3>
<div class="paragraph">
<p>This procedure shows how to deploy example producer and consumer clients that use the Kafka cluster you created to send and receive messages.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Kafka cluster is available for the clients.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy a Kafka producer.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-producer -ti --image=quay.io/strimzi/kafka:0.26.0-kafka-2.8.0 --rm=true --restart=Never -- bin/kafka-console-producer.sh --broker-list <em>cluster-name</em>-kafka-bootstrap:9092 --topic <em>my-topic</em></code></pre>
</div>
</div>
</li>
<li>
<p>Type a message into the console where the producer is running.</p>
</li>
<li>
<p>Press <em>Enter</em> to send the message.</p>
</li>
<li>
<p>Deploy a Kafka consumer.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-consumer -ti --image=quay.io/strimzi/kafka:0.26.0-kafka-2.8.0 --rm=true --restart=Never -- bin/kafka-console-consumer.sh --bootstrap-server <em>cluster-name</em>-kafka-bootstrap:9092 --topic <em>my-topic</em> --from-beginning</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that you see the incoming messages in the consumer console.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="setup-external-clients-str"><a class="link" href="#setup-external-clients-str">5.2. Setting up access for clients outside of Kubernetes</a></h3>
<div class="paragraph _abstract">
<p>This procedure shows how to configure client access to a Kafka cluster from outside Kubernetes.</p>
</div>
<div class="paragraph">
<p>Using the address of the Kafka cluster, you can provide external access to a client on a different Kubernetes namespace or outside Kubernetes entirely.</p>
</div>
<div class="paragraph">
<p>You configure an external Kafka listener to provide the access.</p>
</div>
<div class="paragraph">
<p>The following external listener types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>route</code> to use OpenShift <code>Route</code> and the default HAProxy router</p>
</li>
<li>
<p><code>loadbalancer</code> to use loadbalancer services</p>
</li>
<li>
<p><code>nodeport</code> to use ports on Kubernetes nodes</p>
</li>
<li>
<p><code>ingress</code> to use Kubernetes <em>Ingress</em> and the <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">NGINX Ingress Controller for Kubernetes</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The type chosen depends on your requirements, and your environment and infrastructure.
For example, loadbalancers might not be suitable for certain infrastructure, such as bare metal, where node ports provide a better option.</p>
</div>
<div class="paragraph">
<p>In this procedure:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An external listener is configured for the Kafka cluster, with TLS encryption and authentication, and Kafka <em>simple authorization</em> is enabled.</p>
</li>
<li>
<p>A <code>KafkaUser</code> is created for the client, with TLS authentication and Access Control Lists (ACLs) defined for <em>simple authorization</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can configure your listener to use TLS, SCRAM-SHA-512 or OAuth 2.0 authentication.
TLS always uses encryption, but it is recommended to also use encryption with SCRAM-SHA-512 and OAuth 2.0 authentication.</p>
</div>
<div class="paragraph">
<p>You can configure simple, OAuth 2.0, OPA or custom authorization for Kafka brokers.
When enabled, authorization is applied to all enabled listeners.</p>
</div>
<div class="paragraph">
<p>When you configure the <code>KafkaUser</code> authentication and authorization mechanisms, ensure they match the equivalent Kafka configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>KafkaUser.spec.authentication</code> matches <code>Kafka.spec.kafka.listeners[*].authentication</code></p>
</li>
<li>
<p><code>KafkaUser.spec.authorization</code> matches <code>Kafka.spec.kafka.authorization</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You should have at least one listener supporting the authentication you want to use for the <code>KafkaUser</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Authentication between Kafka users and Kafka brokers depends on the authentication settings for each.
For example, it is not possible to authenticate a user with TLS if it is not also enabled in the Kafka configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Strimzi operators automate the configuration process:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Cluster Operator creates the listeners and sets up the cluster and client certificate authority (CA) certificates to enable authentication within the Kafka cluster.</p>
</li>
<li>
<p>The User Operator creates the user representing the client and the security credentials used for client authentication, based on the chosen authentication type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, the certificates generated by the Cluster Operator are used, but you can replace them by <a href="./using.html#installing-your-own-ca-certificates-str" target="_blank" rel="noopener">installing your own certificates</a>.
You can also configure your listener to <a href="./using.html#kafka-listener-certificates-str" target="_blank" rel="noopener">use a Kafka listener certificate managed by an external Certificate Authority</a>.</p>
</div>
<div class="paragraph">
<p>Certificates are available in PKCS #12 (.p12) and PEM (.crt) formats.
This procedure shows PKCS #12 certificates.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Kafka cluster is available for the client</p>
</li>
<li>
<p>The Cluster Operator and User Operator are running in the cluster</p>
</li>
<li>
<p>A client outside the Kubernetes cluster to connect to the Kafka cluster</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the Kafka cluster with an <code>external</code> Kafka listener.</p>
<div class="ulist">
<ul>
<li>
<p>Define the authentication required to access the Kafka broker through the listener</p>
</li>
<li>
<p>Enable authorization on the Kafka broker</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners: <b class="conum">(1)</b>
    - name: external <b class="conum">(2)</b>
      port: 9094 <b class="conum">(3)</b>
      type: <em>LISTENER-TYPE</em> <b class="conum">(4)</b>
      tls: true <b class="conum">(5)</b>
      authentication:
        type: tls <b class="conum">(6)</b>
      configuration:
        preferredNodePortAddressType: InternalDNS <b class="conum">(7)</b>
        <em>bootstrap and broker service overrides</em> <b class="conum">(8)</b>
        #...
    authorization: <b class="conum">(9)</b>
      type: simple
      superUsers:
        - super-user-name <b class="conum">(10)</b>
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configuration options for enabling external listeners are described in the <a href="./using.html#type-GenericKafkaListener-reference" target="_blank" rel="noopener">Generic Kafka listener schema reference</a>.</p>
</li>
<li>
<p>Name to identify the listener. Must be unique within the Kafka cluster.</p>
</li>
<li>
<p>Port number used by the listener inside Kafka. The port number has to be unique within a given Kafka cluster. Allowed port numbers are 9092 and higher with the exception of ports 9404 and 9999, which are already used for Prometheus and JMX. Depending on the listener type, the port number might not be the same as the port number that connects Kafka clients.</p>
</li>
<li>
<p>External listener type specified as <code>route</code>, <code>loadbalancer</code>, <code>nodeport</code> or <code>ingress</code>. An internal listener is specified as <code>internal</code>.</p>
</li>
<li>
<p>Enables TLS encryption on the listener. Default is <code>false</code>. TLS encryption is not required for <code>route</code> listeners.</p>
</li>
<li>
<p>Authentication specified as <code>tls</code>.</p>
</li>
<li>
<p>(Optional, for <code>nodeport</code> listeners only) Configuration to <a href="./using.html#type-GenericKafkaListenerConfiguration-reference" target="_blank" rel="noopener">specify a preference for the first address type used by Strimzi as the node address</a>.</p>
</li>
<li>
<p>(Optional) Strimzi automatically determines the addresses to advertise to clients.
The addresses are automatically assigned by Kubernetes.
You can override <a href="./using.html#type-GenericKafkaListenerConfiguration-reference">bootstrap and broker service addresses</a> if the infrastructure on which you are running Strimzi does not provide the right address.
Validation is not performed on the overrides.
The override configuration differs according to the listener type.
For example, you can override hosts for <code>route</code>, DNS names or IP addresses for <code>loadbalancer</code>, and node ports for <code>nodeport</code>.</p>
</li>
<li>
<p>Authorization specified as <code>simple</code>, which uses the <code>AclAuthorizer</code> Kafka plugin.</p>
</li>
<li>
<p>(Optional) Super users can access all brokers regardless of any access restrictions defined in ACLs.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
An OpenShift Route address comprises the name of the Kafka cluster, the name of the listener, and the name of the namespace it is created in.
For example, <code>my-cluster-kafka-listener1-bootstrap-myproject</code> (<em>CLUSTER-NAME</em>-kafka-<em>LISTENER-NAME</em>-bootstrap-<em>NAMESPACE</em>).
If you are using a <code>route</code> listener type, be careful that the whole length of the address does not exceed a maximum limit of 63 characters.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create or update the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>KAFKA-CONFIG-FILE</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kafka cluster is configured with a Kafka broker listener using TLS authentication.</p>
</div>
<div class="paragraph">
<p>A service is created for each Kafka broker pod.</p>
</div>
<div class="paragraph">
<p>A service is created to serve as the <em>bootstrap address</em> for connection to the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>A service is also created as the <em>external bootstrap address</em> for external connection to the Kafka cluster using <code>nodeport</code> listeners.</p>
</div>
<div class="paragraph">
<p>The cluster CA certificate to verify the identity of the kafka brokers is also created with the same name as the <code>Kafka</code> resource.</p>
</div>
</li>
<li>
<p>Find the bootstrap address and port from the status of the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka <em>KAFKA-CLUSTER-NAME</em> -o jsonpath='{.status.listeners[?(@.type=="external")].bootstrapServers}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the bootstrap address in your Kafka client to connect to the Kafka cluster.</p>
</div>
</li>
<li>
<p>Create or modify a user representing the client that requires access to the Kafka cluster.</p>
<div class="ulist">
<ul>
<li>
<p>Specify the same authentication type as the <code>Kafka</code> listener.</p>
</li>
<li>
<p>Specify the authorization ACLs for simple authorization.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster <b class="conum">(1)</b>
spec:
  authentication:
    type: tls <b class="conum">(2)</b>
  authorization:
    type: simple
    acls: <b class="conum">(3)</b>
      - resource:
          type: topic
          name: my-topic
          patternType: literal
        operation: Read
      - resource:
          type: topic
          name: my-topic
          patternType: literal
        operation: Describe
      - resource:
          type: group
          name: my-group
          patternType: literal
        operation: Read</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The label must match the label of the Kafka cluster for the user to be created.</p>
</li>
<li>
<p>Authentication specified as <code>tls</code>.</p>
</li>
<li>
<p>Simple authorization requires an accompanying list of ACL rules to apply to the user.
The rules define the operations allowed on Kafka resources based on the <em>username</em> (<code>my-user</code>).</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create or modify the <code>KafkaUser</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>USER-CONFIG-FILE</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The user is created, as well as a Secret with the same name as the <code>KafkaUser</code> resource.
The Secret contains a private and public key for TLS client authentication.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-user
  labels:
    strimzi.io/kind: KafkaUser
    strimzi.io/cluster: my-cluster
type: Opaque
data:
  ca.crt: <em>PUBLIC-KEY-OF-THE-CLIENT-CA</em>
  user.crt: <em>USER-CERTIFICATE-CONTAINING-PUBLIC-KEY-OF-USER</em>
  user.key: <em>PRIVATE-KEY-OF-USER</em>
  user.p12: <em>P12-ARCHIVE-FILE-STORING-CERTIFICATES-AND-KEYS</em>
  user.password: <em>PASSWORD-PROTECTING-P12-ARCHIVE</em></code></pre>
</div>
</div>
</li>
<li>
<p>Extract the public cluster CA certificate to the desired certificate format:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>KAFKA-CLUSTER-NAME</em>-cluster-ca-cert -o jsonpath='{.data.ca\.p12}' | base64 -d &gt; ca.p12</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the password from the password file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>KAFKA-CLUSTER-NAME</em>-cluster-ca-cert -o jsonpath='{.data.ca\.password}' | base64 -d &gt; ca.password</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client with the authentication details for the public cluster certificates:</p>
<div class="listingblock">
<div class="title">Sample client code</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">properties.put("security.protocol","SSL"); <b class="conum">(1)</b>
properties.put(SslConfigs.SSL_TRUSTSTORE_LOCATION_CONFIG,"/path/to/ca.p12"); <b class="conum">(2)</b>
properties.put(SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG,<em>CA-PASSWORD</em>); <b class="conum">(3)</b>
properties.put(SslConfigs.SSL_TRUSTSTORE_TYPE_CONFIG,"PKCS12"); <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Enables TLS encryption (with or without TLS client authentication).</p>
</li>
<li>
<p>Specifies the truststore location where the certificates were imported.</p>
</li>
<li>
<p>Specifies the password for accessing the truststore. This property can be omitted if it is not needed by the truststore.</p>
</li>
<li>
<p>Identifies the truststore type.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Use <code>security.protocol: SASL_SSL</code> when using SCRAM-SHA authentication over TLS.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Extract the user CA certificate from the user Secret to the desired certificate format:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>USER-NAME</em> -o jsonpath='{.data.user\.p12}' | base64 -d &gt; user.p12</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the password from the password file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>USER-NAME</em> -o jsonpath='{.data.user\.password}' | base64 -d &gt; user.password</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client with the authentication details for the user CA certificate:</p>
<div class="listingblock">
<div class="title">Sample client code</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">properties.put(SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG,"/path/to/user.p12"); <b class="conum">(1)</b>
properties.put(SslConfigs.SSL_KEYSTORE_PASSWORD_CONFIG,"&lt;user.password&gt;"); <b class="conum">(2)</b>
properties.put(SslConfigs.SSL_KEYSTORE_TYPE_CONFIG,"PKCS12"); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specifies the keystore location where the certificates were imported.</p>
</li>
<li>
<p>Specifies the password for accessing the keystore. This property can be omitted if it is not needed by the keystore. The public user certificate is signed by the client CA when it is created.</p>
</li>
<li>
<p>Identifies the keystore type.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Add the bootstrap address and port for connecting to the Kafka cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">bootstrap.servers: <em>BOOTSTRAP-ADDRESS:PORT</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./using.html#con-securing-kafka-authentication-str" target="_blank" rel="noopener">Listener authentication options</a></p>
</li>
<li>
<p><a href="./using.html#con-securing-kafka-authorization-str" target="_blank" rel="noopener">Kafka authorization options</a></p>
</li>
<li>
<p>If you are using an authorization server, you can use token-based <a href="./using.html#assembly-oauth-authentication_str" target="_blank" rel="noopener">OAuth 2.0 authentication</a> and <a href="./using.html#assembly-oauth-authorization_str" target="_blank" rel="noopener">OAuth 2.0 authorization</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-metrics-str"><a class="link" href="#assembly-metrics-str">6. Introducing Metrics to Kafka</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to monitor your Strimzi deployment.</p>
</div>
<div class="paragraph">
<p>Depending on your requirements, you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#assembly-metrics-setup-str">Set up and deploy Prometheus and Grafana</a></p>
</li>
<li>
<p><a href="#assembly-kafka-exporter-str">Configure the <code>Kafka</code> resource to deploy Kafka Exporter with your Kafka cluster</a></p>
<div class="paragraph">
<p>Kafka Exporter provides additional monitoring related to consumer lag.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>With Prometheus and Grafana set up, you can use the example Grafana dashboards provided by Strimzi for monitoring.</p>
</div>
<div class="paragraph">
<p>Additionally, you can configure your deployment to track messages end-to-end by <a href="./using.html#assembly-distributed-tracing-str" target="_blank" rel="noopener">setting up distributed tracing</a>, as described in the <em>Using Strimzi</em> guide.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://prometheus.io/docs/introduction/overview/">Prometheus documentation</a></p>
</li>
<li>
<p><a href="https://grafana.com/docs/guides/getting_started/">Grafana documentation</a></p>
</li>
<li>
<p><a href="http://kafka.apache.org/documentation/#monitoring">Apache Kafka Monitoring</a> describes JMX metrics exposed by Apache Kafka</p>
</li>
<li>
<p><a href="https://zookeeper.apache.org/doc/current/zookeeperJMX.html">ZooKeeper JMX</a> describes JMX metrics exposed by Apache ZooKeeper</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="ref-metrics-config-files-str"><a class="link" href="#ref-metrics-config-files-str">6.1. Example metrics files</a></h3>
<div class="paragraph _abstract">
<p>You can find example Grafana dashboards and other metrics configuration files in the <a href="#deploy-examples-str">example configuration files</a> provided by Strimzi.</p>
</div>
<div class="listingblock">
<div class="title">Example metrics files provided with Strimzi</div>
<div class="content">
<pre class="highlightjs highlight"><code>metrics
 grafana-dashboards <b class="conum">(1)</b>
    strimzi-cruise-control.json
    strimzi-kafka-bridge.json
    strimzi-kafka-connect.json
    strimzi-kafka-exporter.json
    strimzi-kafka-mirror-maker-2.json
    strimzi-kafka.json
    strimzi-operators.json
    strimzi-zookeeper.json
 grafana-install
    grafana.yaml <b class="conum">(2)</b>
 prometheus-additional-properties
    prometheus-additional.yaml <b class="conum">(3)</b>
 prometheus-alertmanager-config
    alert-manager-config.yaml <b class="conum">(4)</b>
 prometheus-install
     alert-manager.yaml <b class="conum">(5)</b>
     prometheus-rules.yaml <b class="conum">(6)</b>
     prometheus.yaml <b class="conum">(7)</b>
     strimzi-pod-monitor.yaml <b class="conum">(8)</b>
 kafka-bridge-metrics.yaml <b class="conum">(9)</b>
 kafka-connect-metrics.yaml <b class="conum">(10)</b>
 kafka-cruise-control-metrics.yaml <b class="conum">(11)</b>
 kafka-metrics.yaml <b class="conum">(12)</b>
 kafka-mirror-maker-2-metrics.yaml <b class="conum">(13)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Example Grafana dashboards for the different Strimzi components.</p>
</li>
<li>
<p>Installation file for the Grafana image.</p>
</li>
<li>
<p>Additional configuration to scrape metrics for CPU, memory and disk volume usage, which comes directly from the Kubernetes cAdvisor agent and kubelet on the nodes.</p>
</li>
<li>
<p>Hook definitions for sending notifications through Alertmanager.</p>
</li>
<li>
<p>Resources for deploying and configuring Alertmanager.</p>
</li>
<li>
<p>Alerting rules examples for use with Prometheus Alertmanager (deployed with Prometheus).</p>
</li>
<li>
<p>Installation resource file for the Prometheus image.</p>
</li>
<li>
<p>PodMonitor definitions translated by the Prometheus Operator into jobs for the Prometheus server to be able to scrape metrics data directly from pods.</p>
</li>
<li>
<p>Kafka Bridge resource with metrics enabled.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Kafka Connect.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Cruise Control.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Kafka and ZooKeeper.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Kafka Mirror Maker 2.0.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="example_grafana_dashboards"><a class="link" href="#example_grafana_dashboards">6.1.1. Example Grafana dashboards</a></h4>
<div class="paragraph">
<p>Example Grafana dashboards are provided for monitoring:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Strimzi Operators</p>
</li>
<li>
<p>Kafka</p>
</li>
<li>
<p>Kafka ZooKeeper</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker 2.0</p>
</li>
<li>
<p><a href="#assembly-kafka-bridge-str">Kafka Bridge</a></p>
</li>
<li>
<p><a href="#assembly-cruise-control-str">Cruise Control</a></p>
</li>
<li>
<p><a href="#assembly-kafka-exporter-str">Kafka Exporter</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All dashboards provide JVM metrics, as well as metrics specific to the component.
For example, the Grafana dashboard for Strimzi Operators provides information on the number of reconciliations or custom resources they are processing.</p>
</div>
</div>
<div class="sect3">
<h4 id="ref-metrics-yaml-files-str"><a class="link" href="#ref-metrics-yaml-files-str">6.1.2. Example Prometheus metrics configuration</a></h4>
<div class="paragraph">
<p>Strimzi uses the <a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener">Prometheus JMX Exporter</a> to expose JMX metrics using an HTTP endpoint, which is then scraped by the Prometheus server.</p>
</div>
<div class="paragraph">
<p>Grafana dashboards are dependent on Prometheus JMX Exporter relabeling rules, which are defined for Strimzi components as custom resource configuration.</p>
</div>
<div class="paragraph">
<p>A label is a name-value pair.
Relabeling is the process of writing a label dynamically.
For example, the value of a label may be derived from the name of a Kafka server and client ID.</p>
</div>
<div class="paragraph">
<p>Strimzi provides example custom resource configuration YAML files with relabeling rules.
When deploying Prometheus metrics configuration, you can can deploy the example custom resource or copy the metrics configuration to your own custom resource definition.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Example custom resources with metrics configuration</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Custom resource</th>
<th class="tableblock halign-left valign-top">Example YAML file</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka and ZooKeeper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kafka</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaConnect</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-connect-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka MirrorMaker 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaMirrorMaker2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-mirror-maker-2-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaBridge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-bridge-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cruise Control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kafka</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-cruise-control-metrics.yaml</code></p></td>
</tr>
</tbody>
</table>
<div class="literalblock">
<div class="content">
<pre> [role="_additional-resources"]
.Additional resources</pre>
</div>
</div>
<div class="paragraph">
<p>For more information on the use of relabeling, see <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration" target="_blank" rel="noopener">Configuration</a> in the Prometheus documentation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-metrics-setup-str"><a class="link" href="#assembly-metrics-setup-str">6.2. Add Prometheus and Grafana</a></h3>
<div class="paragraph">
<p>You can use Prometheus to provide monitoring data for the example Grafana dashboards provided with Strimzi.</p>
</div>
<div class="paragraph">
<p>In order to run the example Grafana dashboards, you must:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Add metrics configuration to your Kafka cluster resource</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Deploy Prometheus and Prometheus Alertmanager</a></p>
</li>
<li>
<p><a href="#assembly-metrics-grafana-str">Deploy Grafana</a></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The resources referenced in this section are intended as a starting point for setting up monitoring, but they are provided as examples only.
If you require further support on configuring and running Prometheus or Grafana in production, try reaching out to their respective communities.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="proc-metrics-kafka-deploy-options-str"><a class="link" href="#proc-metrics-kafka-deploy-options-str">6.2.1. Deploying Prometheus metrics configuration</a></h4>
<div class="paragraph">
<p>Strimzi provides <a href="#ref-metrics-yaml-files-str">example custom resource configuration YAML files</a> with relabeling rules.</p>
</div>
<div class="paragraph">
<p>To apply metrics configuration of relabeling rules, do one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-metrics-kafka-str">Copy the example configuration to your own custom resource definition</a></p>
</li>
<li>
<p><a href="#proc-metrics-deploying-kafka-str">Deploy the custom resource with the metrics configuration</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="proc-metrics-kafka-str"><a class="link" href="#proc-metrics-kafka-str">Copying Prometheus metrics configuration to a custom resource</a></h5>
<div class="paragraph">
<p>To use Grafana dashboards for monitoring, copy <a href="#ref-metrics-yaml-files-str">the example metrics configuration to a custom resource</a>.</p>
</div>
<div class="paragraph">
<p>In this procedure, the <code>Kafka</code> resource is updated, but the procedure is the same for all components that support monitoring.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Perform the following steps for each <code>Kafka</code> resource in your deployment.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Update the <code>Kafka</code> resource in an editor.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka <em>KAFKA-CONFIG-FILE</em></code></pre>
</div>
</div>
</li>
<li>
<p>Copy the <a href="#ref-metrics-yaml-files-str">example configuration in <code>kafka-metrics.yaml</code></a> to your own <code>Kafka</code> resource definition.</p>
</li>
<li>
<p>Save the file, and wait for the updated resource to be reconciled.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-metrics-deploying-kafka-str"><a class="link" href="#proc-metrics-deploying-kafka-str">Deploying a Kafka cluster with Prometheus metrics configuration</a></h5>
<div class="paragraph">
<p>To use Grafana dashboards for monitoring, you can deploy <a href="#ref-metrics-config-files-str">an example Kafka cluster with metrics configuration</a>.</p>
</div>
<div class="paragraph">
<p>In this procedure, The <code>kafka-metrics.yaml</code> file is used for the <code>Kafka</code> resource.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Deploy the Kafka cluster with the <a href="#ref-metrics-yaml-files-str">example metrics configuration</a>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f kafka-metrics.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="assembly-metrics-prometheus-str"><a class="link" href="#assembly-metrics-prometheus-str">6.2.2. Setting up Prometheus</a></h4>
<div class="paragraph">
<p><a href="https://prometheus.io/" target="_blank" rel="noopener">Prometheus</a> provides an open source set of components for systems monitoring and alert notification.</p>
</div>
<div class="paragraph">
<p>We describe here how you can use the <a href="https://github.com/coreos/prometheus-operator" target="_blank" rel="noopener">CoreOS Prometheus Operator</a> to run and manage a Prometheus server that is suitable for use in production environments, but with the correct configuration you can run any Prometheus server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The Prometheus server configuration uses service discovery to discover the pods in the cluster from which it gets metrics.  For this feature to work correctly, the service account used for running the Prometheus service pod must have access to the API server so it can retrieve the pod list.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="https://kubernetes.io/docs/concepts/services-networking/service/#discovering-services" target="_blank" rel="noopener">Discovering services</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="con-metrics-prometheus-options-str"><a class="link" href="#con-metrics-prometheus-options-str">Prometheus configuration</a></h5>
<div class="paragraph">
<p>Strimzi provides <a href="#ref-metrics-config-files-str">example configuration files for the Prometheus server</a>.</p>
</div>
<div class="paragraph">
<p>A Prometheus image is provided for deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prometheus.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional Prometheus-related configuration is also provided in the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prometheus-additional.yaml</code></p>
</li>
<li>
<p><code>prometheus-rules.yaml</code></p>
</li>
<li>
<p><code>strimzi-pod-monitor.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For Prometheus to obtain monitoring data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-metrics-deploying-prometheus-operator-str">Deploy the Prometheus Operator</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then use the configuration files to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-metrics-deploying-prometheus-operator-str">Deploy Prometheus</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Alerting rules</div>
<p>The <code>prometheus-rules.yaml</code> file provides <a href="#ref-metrics-alertmanager-examples-str">example alerting rule examples for use with Alertmanager</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="con-metrics-prometheus-resources-str"><a class="link" href="#con-metrics-prometheus-resources-str">Prometheus resources</a></h5>
<div class="paragraph">
<p>When you apply the Prometheus configuration, the following resources are created in your Kubernetes cluster and managed by the Prometheus Operator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>ClusterRole</code> that grants permissions to Prometheus to read the health endpoints exposed by the Kafka and ZooKeeper pods, cAdvisor and the kubelet for container metrics.</p>
</li>
<li>
<p>A <code>ServiceAccount</code> for the Prometheus pods to run under.</p>
</li>
<li>
<p>A <code>ClusterRoleBinding</code> which binds the <code>ClusterRole</code> to the <code>ServiceAccount</code>.</p>
</li>
<li>
<p>A <code>Deployment</code> to manage the Prometheus Operator pod.</p>
</li>
<li>
<p>A <code>PodMonitor</code> to manage the configuration of the Prometheus pod.</p>
</li>
<li>
<p>A <code>Prometheus</code> to manage the configuration of the Prometheus pod.</p>
</li>
<li>
<p>A <code>PrometheusRule</code> to manage alerting rules for the Prometheus pod.</p>
</li>
<li>
<p>A <code>Secret</code> to manage additional Prometheus settings.</p>
</li>
<li>
<p>A <code>Service</code> to allow applications running in the cluster to connect to Prometheus (for example, Grafana using Prometheus as datasource).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="proc-metrics-deploying-prometheus-operator-str"><a class="link" href="#proc-metrics-deploying-prometheus-operator-str">Deploying the CoreOS Prometheus Operator</a></h5>
<div class="paragraph">
<p>To deploy the Prometheus Operator to your Kafka cluster, apply the YAML bundle resources file from the <a href="https://github.com/coreos/prometheus-operator">Prometheus CoreOS repository</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Download the <code>bundle.yaml</code> resources file from the repository.</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -s https://raw.githubusercontent.com/coreos/prometheus-operator/master/bundle.yaml | sed -e '/[[:space:]]*namespace: [a-zA-Z0-9-]*$/s/namespace:[[:space:]]*[a-zA-Z0-9-]*$/namespace: <em>my-namespace</em>/' &gt; prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -s https://raw.githubusercontent.com/coreos/prometheus-operator/master/bundle.yaml | sed -e '' '/[[:space:]]*namespace: [a-zA-Z0-9-]*$/s/namespace:[[:space:]]*[a-zA-Z0-9-]*$/namespace: <em>my-namespace</em>/' &gt; prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace the example <code>namespace</code> with your own.</p>
</li>
<li>
<p>Use the latest <code>master</code> release as shown, or choose a release that is compatible with your version of Kubernetes (see the <a href="https://github.com/coreos/kube-prometheus#kubernetes-compatibility-matrix">Kubernetes compatibility matrix</a>).
The <code>master</code> release of the Prometheus Operator works with Kubernetes 1.18+.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If using OpenShift, specify a release of the <a href="https://github.com/openshift/prometheus-operator" target="_blank" rel="noopener">OpenShift fork</a> of the Prometheus Operator repository.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>(Optional) If it is not required, you can manually remove the <code>spec.template.spec.securityContext</code> property from the <code>prometheus-operator-deployment.yaml</code> file.</p>
</li>
<li>
<p>Deploy the Prometheus Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-metrics-deploying-prometheus-str"><a class="link" href="#proc-metrics-deploying-prometheus-str">Deploying Prometheus</a></h5>
<div class="paragraph _abstract">
<p>Use Prometheus to obtain monitoring data in your Kafka cluster.</p>
</div>
<div class="paragraph">
<p>You can use your own Prometheus deployment or deploy Prometheus using the <a href="#ref-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi.
The example files include a configuration file for a Prometheus deployment and files for Prometheus-related resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/prometheus-install/prometheus.yaml</code></p>
</li>
<li>
<p><code>examples/metrics/prometheus-install/prometheus-rules.yaml</code></p>
</li>
<li>
<p><code>examples/metrics/prometheus-install/strimzi-pod-monitor.yaml</code></p>
</li>
<li>
<p><code>examples/metrics/prometheus-additional-properties/prometheus-additional.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The deployment process creates a <code>ClusterRoleBinding</code> and discovers an Alertmanager instance in the namespace specified for the deployment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
By default, the Prometheus Operator only supports jobs that include an <code>endpoints</code> role for service discovery. Targets are discovered and scraped for each endpoint port address. For endpoint discovery, the port address may be derived from service (<code>role: service</code>) or pod (<code>role: pod</code>) discovery.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Check the <a href="#ref-metrics-alertmanager-examples-str">example alerting rules provided</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Modify the Prometheus installation file (<code>prometheus.yaml</code>) according to the namespace Prometheus is going to be installed into:</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">sed -i 's/namespace: .*/namespace: <em>my-namespace</em>/' prometheus.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">sed -i '' 's/namespace: .*/namespace: <em>my-namespace</em>/' prometheus.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>PodMonitor</code> resource in <code>strimzi-pod-monitor.yaml</code> to define Prometheus jobs that will scrape the metrics data from pods.</p>
<div class="paragraph">
<p>Update the <code>namespaceSelector.matchNames</code> property with the namespace where the pods to scrape the metrics from are running.</p>
</div>
<div class="paragraph">
<p><code>PodMonitor</code> is used to scrape data directly from pods for Apache Kafka, ZooKeeper, Operators, the Kafka Bridge and Cruise Control.</p>
</div>
</li>
<li>
<p>Edit the <code>prometheus.yaml</code> installation file to include additional configuration for scraping metrics directly from nodes.</p>
<div class="paragraph">
<p>The Grafana dashboards provided show metrics for CPU, memory and disk volume usage, which come directly from the Kubernetes cAdvisor agent and kubelet on the nodes.</p>
</div>
<div class="paragraph">
<p>The Prometheus Operator does not have a monitoring resource like <code>PodMonitor</code> for scraping the nodes, so the <code>prometheus-additional.yaml</code> file contains the additional configuration needed.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a <code>Secret</code> resource from the configuration file (<code>prometheus-additional.yaml</code> in the <code>examples/metrics/prometheus-additional-properties</code> directory):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f prometheus-additional.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>additionalScrapeConfigs</code> property in the <code>prometheus.yaml</code> file to include the name of the <code>Secret</code> and the <code>prometheus-additional.yaml</code> file.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Deploy the Prometheus resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f strimzi-pod-monitor.yaml
kubectl apply -f prometheus-rules.yaml
kubectl apply -f prometheus.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="assembly-metrics-prometheus-alertmanager-str"><a class="link" href="#assembly-metrics-prometheus-alertmanager-str">6.2.3. Setting up Prometheus Alertmanager</a></h4>
<div class="paragraph">
<p><a href="https://prometheus.io/docs/alerting/alertmanager/" target="_blank" rel="noopener">Prometheus Alertmanager</a> is a plugin for handling alerts and routing them to a notification service.
Alertmanager supports an essential aspect of monitoring, which is to be notified of conditions that indicate potential issues based on alerting rules.</p>
</div>
<div class="sect4">
<h5 id="con-metrics-prometheus-alerts-str"><a class="link" href="#con-metrics-prometheus-alerts-str">Alerting rules</a></h5>
<div class="paragraph">
<p>Alerting rules provide notifications about specific conditions observed in the metrics. Rules are declared on the Prometheus server, but Prometheus Alertmanager is responsible for alert notifications.</p>
</div>
<div class="paragraph">
<p>Prometheus alerting rules describe conditions using <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">PromQL</a> expressions that are continuously evaluated.</p>
</div>
<div class="paragraph">
<p>When an alert expression becomes true, the condition is met and the Prometheus server sends alert data to the Alertmanager.
Alertmanager then sends out a notification using the communication method configured for its deployment.</p>
</div>
<div class="paragraph">
<p>Alertmanager can be configured to use email, chat messages or other notification methods.</p>
</div>
<div class="paragraph">
<div class="title">Additional resources</div>
<p>For more information about setting up alerting rules, see <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration" target="_blank" rel="noopener">Configuration</a> in the Prometheus documentation.</p>
</div>
</div>
<div class="sect4">
<h5 id="ref-metrics-alertmanager-examples-str"><a class="link" href="#ref-metrics-alertmanager-examples-str">Alerting rule examples</a></h5>
<div class="paragraph">
<p>Example alerting rules for Kafka and ZooKeeper metrics are provided with Strimzi for use in a <a href="#proc-metrics-deploying-prometheus-str">Prometheus deployment</a>.</p>
</div>
<div class="paragraph">
<p>General points about the alerting rule definitions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>for</code> property is used with the rules to determine the period of time a condition must persist before an alert is triggered.</p>
</li>
<li>
<p>A tick is a basic ZooKeeper time unit, which is measured in milliseconds and configured using the <code>tickTime</code> parameter of <code>Kafka.spec.zookeeper.config</code>. For example, if ZooKeeper <code>tickTime=3000</code>, 3 ticks (3 x 3000) equals 9000 milliseconds.</p>
</li>
<li>
<p>The availability of the <code>ZookeeperRunningOutOfSpace</code> metric and alert is dependent on the Kubernetes configuration and storage implementation used. Storage implementations for certain platforms may not be able to supply the information on available space required for the metric to provide an alert.</p>
</li>
</ul>
</div>
<div class="dlist">
<div class="title">Kafka alerting rules</div>
<dl>
<dt class="hdlist1"><code>UnderReplicatedPartitions</code></dt>
<dd>
<p>Gives the number of partitions for which the current broker is the lead replica but which have fewer replicas than the <code>min.insync.replicas</code> configured for their topic.
This metric provides insights about brokers that host the follower replicas. Those followers are not keeping up with the leader.
Reasons for this could include being (or having been) offline, and over-throttled interbroker replication.
An alert is raised when this value is greater than zero, providing information on the under-replicated partitions for each broker.</p>
</dd>
<dt class="hdlist1"><code>AbnormalControllerState</code></dt>
<dd>
<p>Indicates whether the current broker is the controller for the cluster.
The metric can be 0 or 1.
During the life of a cluster, only one broker should be the controller and the cluster always needs to have an active controller.
Having two or more brokers saying that they are controllers indicates a problem.
If the condition persists, an alert is raised when the sum of all the values for this metric on all brokers is not equal to 1, meaning that there is no active controller (the sum is 0) or more than one controller (the sum is greater than 1).</p>
</dd>
<dt class="hdlist1"><code>UnderMinIsrPartitionCount</code></dt>
<dd>
<p>Indicates that the minimum number of in-sync replicas (ISRs) for a lead Kafka broker, specified using <code>min.insync.replicas</code>, that must acknowledge a write operation has not been reached.
The metric defines the number of partitions that the broker leads for which the in-sync replicas count is less than the minimum in-sync.
An alert is raised when this value is greater than zero, providing information on the partition count for each broker that did not achieve the minimum number of acknowledgments.</p>
</dd>
<dt class="hdlist1"><code>OfflineLogDirectoryCount</code></dt>
<dd>
<p>Indicates the number of log directories which are offline (for example, due to a hardware failure) so that the broker cannot store incoming messages anymore.
An alert is raised when this value is greater than zero, providing information on the number of offline log directories for each broker.</p>
</dd>
<dt class="hdlist1"><code>KafkaRunningOutOfSpace</code></dt>
<dd>
<p>Indicates the remaining amount of disk space that can be used for writing data.
An alert is raised when this value is lower than 5GiB, providing information on the disk that is running out of space for each persistent volume claim.
The threshold value may be changed in <code>prometheus-rules.yaml</code>.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">ZooKeeper alerting rules</div>
<dl>
<dt class="hdlist1"><code>AvgRequestLatency</code></dt>
<dd>
<p>Indicates the amount of time it takes for the server to respond to a client request.
An alert is raised when this value is greater than 10 (ticks), providing the actual value of the average request latency for each server.</p>
</dd>
<dt class="hdlist1"><code>OutstandingRequests</code></dt>
<dd>
<p>Indicates the number of queued requests in the server.
This value goes up when the server receives more requests than it can process.
An alert is raised when this value is greater than 10, providing the actual number of outstanding requests for each server.</p>
</dd>
<dt class="hdlist1"><code>ZookeeperRunningOutOfSpace</code></dt>
<dd>
<p>Indicates the remaining amount of disk space that can be used for writing data to ZooKeeper.
An alert is raised when this value is lower than 5GiB., providing information on the disk that is running out of space for each persistent volume claim.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="proc-metrics-deploying-prometheus-alertmanager-str"><a class="link" href="#proc-metrics-deploying-prometheus-alertmanager-str">Deploying Alertmanager</a></h5>
<div class="paragraph _abstract">
<p>Use Alertmanager to route alerts to a notification service.</p>
</div>
<div class="paragraph">
<p>You can use the <a href="#ref-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi to deploy Alertmanager to send notifications to a Slack channel.
A configuration file defines the resources for deploying Alertmanager:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/prometheus-install/alert-manager.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An additional configuration file provides the hook definitions for sending notifications from your Kafka cluster:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/prometheus-alertmanager-config/alert-manager-config.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following resources are defined on deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>Alertmanager</code> to manage the Alertmanager pod.</p>
</li>
<li>
<p>A <code>Secret</code> to manage the configuration of the Alertmanager.</p>
</li>
<li>
<p>A <code>Service</code> to provide an easy to reference hostname for other services to connect to Alertmanager (such as Prometheus).</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Metrics are configured for the Kafka cluster resource</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Prometheus is deployed</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Secret</code> resource from the Alertmanager configuration file (<code>alert-manager-config.yaml</code> in the <code>examples/metrics/prometheus-alertmanager-config</code> directory):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f alert-manager-config.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Update the <code>alert-manager-config.yaml</code> file to replace the:</p>
<div class="ulist">
<ul>
<li>
<p><code>slack_api_url</code> property with the actual value of the Slack API URL related to the application for the Slack workspace</p>
</li>
<li>
<p><code>channel</code> property with the actual Slack channel on which to send notifications</p>
</li>
</ul>
</div>
</li>
<li>
<p>Deploy Alertmanager:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f alert-manager.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="assembly-metrics-grafana-str"><a class="link" href="#assembly-metrics-grafana-str">6.2.4. Setting up Grafana</a></h4>
<div class="paragraph">
<p>Grafana provides visualizations of Prometheus metrics.</p>
</div>
<div class="paragraph">
<p>You can deploy and enable the example Grafana dashboards provided with Strimzi.</p>
</div>
<div class="sect4">
<h5 id="proc-metrics-deploying-grafana-str"><a class="link" href="#proc-metrics-deploying-grafana-str">Deploying Grafana</a></h5>
<div class="paragraph _abstract">
<p>Use Grafana to provide visualizations of Prometheus metrics.</p>
</div>
<div class="paragraph">
<p>You can use your own Grafana deployment or deploy Grafana using the <a href="#ref-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi.
The example files include a configuration file for a Grafana deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/grafana-install/grafana.yaml</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Metrics are configured for the Kafka cluster resource</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Prometheus and Prometheus Alertmanager are deployed</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Grafana:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f grafana.yaml</code></pre>
</div>
</div>
</li>
<li>
<p><a href="#proc-metrics-grafana-dashboard-str">Enable the Grafana dashboards</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-metrics-grafana-dashboard-str"><a class="link" href="#proc-metrics-grafana-dashboard-str">Enabling the example Grafana dashboards</a></h5>
<div class="paragraph _abstract">
<p>Use Grafana dashboards to visualize Strimzi data.
Add dashboards if you are using Prometheus and Grafana to extract metrics and monitor Strimzi.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#ref-metrics-config-files-str">example dashboard configuration files for Grafana</a>.
Example dashboards are provided in the <code>examples/metrics/grafana-dashboards</code> directory as JSON files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>strimzi-kafka.json</code></p>
</li>
<li>
<p><code>strimzi-zookeeper.json</code></p>
</li>
<li>
<p><code>strimzi-operators.json</code></p>
</li>
<li>
<p><code>strimzi-kafka-connect.json</code></p>
</li>
<li>
<p><code>strimzi-kafka-mirror-maker-2.json</code></p>
</li>
<li>
<p><code>strimzi-kafka-bridge.json</code></p>
</li>
<li>
<p><code>strimzi-cruise-control.json</code></p>
</li>
<li>
<p><code>strimzi-kafka-exporter.json</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The example dashboards are a good starting point for monitoring key metrics, but they do not represent all available metrics.
You can modify the example dashboards or add other metrics, depending on your infrastructure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
No alert notification rules are defined.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When accessing a dashboard, you can use the <code>port-forward</code> command to forward traffic from the Grafana pod to the host.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The name of the Grafana pod is different for each user.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Get the details of the Grafana service:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get service grafana</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">NAME</th>
<th class="tableblock halign-left valign-top">TYPE</th>
<th class="tableblock halign-left valign-top">CLUSTER-IP</th>
<th class="tableblock halign-left valign-top">PORT(S)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">grafana</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ClusterIP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">172.30.123.40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3000/TCP</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note the port number for port forwarding.</p>
</div>
</li>
<li>
<p>Use <code>port-forward</code> to redirect the Grafana user interface to <code>localhost:3000</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl port-forward svc/grafana 3000:3000</code></pre>
</div>
</div>
</li>
<li>
<p>Point a web browser to <code><a href="http://localhost:3000" class="bare">http://localhost:3000</a></code>.</p>
<div class="paragraph">
<p>The Grafana Log In page appears.</p>
</div>
</li>
<li>
<p>Enter your user name and password, and then click <b class="button">Log In</b>.</p>
<div class="paragraph">
<p>The default Grafana user name and password are both <code>admin</code>. After logging in for the first time, you can change the password.</p>
</div>
</li>
<li>
<p>Add Prometheus as a <em>data source</em>.</p>
<div class="ulist">
<ul>
<li>
<p>Specify a name</p>
</li>
<li>
<p>Add <em>Prometheus</em> as the type</p>
</li>
<li>
<p>Specify a Prometheus server URL (<a href="http://prometheus-operated:9090" class="bare">http://prometheus-operated:9090</a>)</p>
<div class="paragraph">
<p>Save and test the connection when you have added the details.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/grafana_prometheus_data_source.png" alt="Add Prometheus data source">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>From <span class="menuseq"><b class="menu">Dashboards</b>&#160;<b class="caret">&#8250;</b> <b class="menuitem">Import</b></span>, upload the example dashboards or paste the JSON directly.</p>
</li>
<li>
<p>On the top header, click the dashboard drop-down menu, and then select the dashboard you want to view.</p>
<div class="paragraph">
<p>When the Prometheus server has been collecting metrics for a Strimzi cluster for some time, the dashboards are populated.</p>
</div>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/grafana-dashboard-selection.png" alt="Strimzi dashboard selection">
</div>
<div class="title">Figure 1. Dashboard selection options</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Strimzi Kafka</dt>
<dd>
<p>Shows metrics for:</p>
<div class="ulist">
<ul>
<li>
<p>Brokers online count</p>
</li>
<li>
<p>Active controllers in the cluster count</p>
</li>
<li>
<p>Unclean leader election rate</p>
</li>
<li>
<p>Replicas that are online</p>
</li>
<li>
<p>Under-replicated partitions count</p>
</li>
<li>
<p>Partitions which are at their minimum in sync replica count</p>
</li>
<li>
<p>Partitions which are under their minimum in sync replica count</p>
</li>
<li>
<p>Partitions that do not have an active leader and are hence not writable or readable</p>
</li>
<li>
<p>Kafka broker pods memory usage</p>
</li>
<li>
<p>Aggregated Kafka broker pods CPU usage</p>
</li>
<li>
<p>Kafka broker pods disk usage</p>
</li>
<li>
<p>JVM memory used</p>
</li>
<li>
<p>JVM garbage collection time</p>
</li>
<li>
<p>JVM garbage collection count</p>
</li>
<li>
<p>Total incoming byte rate</p>
</li>
<li>
<p>Total outgoing byte rate</p>
</li>
<li>
<p>Incoming messages rate</p>
</li>
<li>
<p>Total produce request rate</p>
</li>
<li>
<p>Byte rate</p>
</li>
<li>
<p>Produce request rate</p>
</li>
<li>
<p>Fetch request rate</p>
</li>
<li>
<p>Network processor average time idle percentage</p>
</li>
<li>
<p>Request handler average time idle percentage</p>
</li>
<li>
<p>Log size</p>
<div class="imageblock">
<div class="content">
<img src="images/grafana_kafka_dashboard.png" alt="Kafka dashboard">
</div>
<div class="title">Figure 2. Strimzi Kafka dashboard</div>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Strimzi ZooKeeper</dt>
<dd>
<p>Shows metrics for:</p>
<div class="ulist">
<ul>
<li>
<p>Quorum Size of Zookeeper ensemble</p>
</li>
<li>
<p>Number of <em>alive</em> connections</p>
</li>
<li>
<p>Queued requests in the server count</p>
</li>
<li>
<p>Watchers count</p>
</li>
<li>
<p>ZooKeeper pods memory usage</p>
</li>
<li>
<p>Aggregated ZooKeeper pods CPU usage</p>
</li>
<li>
<p>ZooKeeper pods disk usage</p>
</li>
<li>
<p>JVM memory used</p>
</li>
<li>
<p>JVM garbage collection time</p>
</li>
<li>
<p>JVM garbage collection count</p>
</li>
<li>
<p>Amount of time it takes for the server to respond to a client request (maximum, minimum and average)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Strimzi Operators</dt>
<dd>
<p>Shows metrics for:</p>
<div class="ulist">
<ul>
<li>
<p>Custom resources</p>
</li>
<li>
<p>Successful custom resource reconciliations per hour</p>
</li>
<li>
<p>Failed custom resource reconciliations per hour</p>
</li>
<li>
<p>Reconciliations without locks per hour</p>
</li>
<li>
<p>Reconciliations started hour</p>
</li>
<li>
<p>Periodical reconciliations per hour</p>
</li>
<li>
<p>Maximum reconciliation time</p>
</li>
<li>
<p>Average reconciliation time</p>
</li>
<li>
<p>JVM memory used</p>
</li>
<li>
<p>JVM garbage collection time</p>
</li>
<li>
<p>JVM garbage collection count</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Strimzi Kafka Connect</dt>
<dd>
<p>Shows metrics for:</p>
<div class="ulist">
<ul>
<li>
<p>Total incoming byte rate</p>
</li>
<li>
<p>Total outgoing byte rate</p>
</li>
<li>
<p>Disk usage</p>
</li>
<li>
<p>JVM memory used</p>
</li>
<li>
<p>JVM garbage collection time</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Strimzi Kafka MirrorMaker 2</dt>
<dd>
<p>Shows metrics for:</p>
<div class="ulist">
<ul>
<li>
<p>Number of connectors</p>
</li>
<li>
<p>Number of tasks</p>
</li>
<li>
<p>Total incoming byte rate</p>
</li>
<li>
<p>Total outgoing byte rate</p>
</li>
<li>
<p>Disk usage</p>
</li>
<li>
<p>JVM memory used</p>
</li>
<li>
<p>JVM garbage collection time</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Strimzi Kafka Bridge</dt>
<dd>
<p>See <a href="#assembly-kafka-bridge-str">Monitor Kafka Bridge</a>.</p>
</dd>
<dt class="hdlist1">Strimzi Cruise Control</dt>
<dd>
<p>See <a href="#assembly-cruise-control-str">Monitor Cruise Control</a>.</p>
</dd>
<dt class="hdlist1">Strimzi Kafka Exporter</dt>
<dd>
<p>See <a href="#proc-kafka-exporter-enabling-str">Enabling the Kafka Exporter Grafana dashboard</a>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-metrics-kafka-mini-kube-str"><a class="link" href="#con-metrics-kafka-mini-kube-str">6.2.5. Using metrics with Minikube</a></h4>
<div class="paragraph">
<p>When adding Prometheus and Grafana servers to an Apache Kafka deployment using Minikube, the memory available to the virtual machine should be increased (to 4 GB of RAM, for example, instead of the default 2 GB).</p>
</div>
<div class="paragraph">
<p>For information on how to increase the default amount of memory, see <a href="#deploy-kubernetes-str">Installing a local Kubernetes cluster with Minikube</a></p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/debug-application-cluster/resource-usage-monitoring/">Prometheus - Monitoring Docker Container Metrics using cAdvisor</a> describes how to use cAdvisor (short for container Advisor) metrics with Prometheus to analyze and expose resource usage (CPU, Memory, and Disk) and performance data from running containers within pods on Kubernetes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-kafka-exporter-str"><a class="link" href="#assembly-kafka-exporter-str">6.3. Add Kafka Exporter</a></h3>
<div class="paragraph">
<p><a href="https://github.com/danielqsj/kafka_exporter" target="_blank" rel="noopener">Kafka Exporter</a> is an open source project to enhance monitoring of Apache Kafka brokers and clients.
Kafka Exporter is provided with Strimzi for deployment with a Kafka cluster to extract additional metrics data from Kafka brokers related to offsets, consumer groups, consumer lag, and topics.</p>
</div>
<div class="paragraph">
<p>The metrics data is used, for example, to help identify slow consumers.</p>
</div>
<div class="paragraph">
<p>Lag data is exposed as Prometheus metrics, which can then be presented in Grafana for analysis.</p>
</div>
<div class="paragraph">
<p>If you are already using Prometheus and Grafana for monitoring of built-in Kafka metrics, you can configure Prometheus to also scrape the Kafka Exporter Prometheus endpoint.</p>
</div>
<div class="paragraph">
<p>Strimzi includes an example Kafka Exporter dashboard in <code>examples/metrics/grafana-dashboards/strimzi-kafka-exporter.json</code>.</p>
</div>
<div class="sect3">
<h4 id="con-metrics-kafka-exporter-lag-str"><a class="link" href="#con-metrics-kafka-exporter-lag-str">6.3.1. Monitoring Consumer lag</a></h4>
<div class="paragraph">
<p>Consumer lag indicates the difference in the rate of production and consumption of messages.
Specifically, consumer lag for a given consumer group indicates the delay between the last message in the partition and the message being currently picked up by that consumer.</p>
</div>
<div class="paragraph">
<p>The lag reflects the position of the consumer offset in relation to the end of the partition log.</p>
</div>
<div class="paragraph">
<div class="title">Consumer lag between the producer and consumer offset</div>
<p><span class="image"><img src="images/consumer-lag.png" alt="Consumer lag"></span></p>
</div>
<div class="paragraph">
<p>This difference is sometimes referred to as the <em>delta</em> between the producer offset and consumer offset: the read and write positions in the Kafka broker topic partitions.</p>
</div>
<div class="paragraph">
<p>Suppose a topic streams 100 messages a second. A lag of 1000 messages between the producer offset (the topic partition head) and the last offset the consumer has read means a 10-second delay.</p>
</div>
<h5 id="the_importance_of_monitoring_consumer_lag" class="discrete">The importance of monitoring consumer lag</h5>
<div class="paragraph">
<p>For applications that rely on the processing of (near) real-time data, it is critical to monitor consumer lag to check that it does not become too big.
The greater the lag becomes, the further the process moves from the real-time processing objective.</p>
</div>
<div class="paragraph">
<p>Consumer lag, for example, might be a result of consuming too much old data that has not been purged, or through unplanned shutdowns.</p>
</div>
<h5 id="reducing_consumer_lag" class="discrete">Reducing consumer lag</h5>
<div class="paragraph">
<p>Typical actions to reduce lag include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scaling-up consumer groups by adding new consumers</p>
</li>
<li>
<p>Increasing the retention time for a message to remain in a topic</p>
</li>
<li>
<p>Adding more disk capacity to increase the message buffer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Actions to reduce consumer lag depend on the underlying infrastructure and the use cases Strimzi is supporting.
For instance, a lagging consumer is less likely to benefit from the broker being able to service a fetch request from its disk cache.
And in certain cases, it might be acceptable to automatically drop messages until a consumer has caught up.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-metrics-kafka-exporter-alerts-str"><a class="link" href="#con-metrics-kafka-exporter-alerts-str">6.3.2. Example Kafka Exporter alerting rules</a></h4>
<div class="paragraph">
<p>If you performed the steps to introduce metrics to your deployment, you will already have your Kafka cluster configured to use the alert notification rules that support Kafka Exporter.</p>
</div>
<div class="paragraph">
<p>The rules for Kafka Exporter are defined in <code>prometheus-rules.yaml</code>, and are deployed with Prometheus.
For more information, see  <a href="#assembly-metrics-prometheus-str">Prometheus</a>.</p>
</div>
<div class="paragraph">
<p>The sample alert notification rules specific to Kafka Exporter are as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>UnderReplicatedPartition</code></dt>
<dd>
<p>An alert to warn that a topic is under-replicated and the broker is not replicating to enough partitions.
The default configuration is for an alert if there are one or more under-replicated partitions for a topic.
The alert might signify that a Kafka instance is down or the Kafka cluster is overloaded.
A planned restart of the Kafka broker may be required to restart the replication process.</p>
</dd>
<dt class="hdlist1"><code>TooLargeConsumerGroupLag</code></dt>
<dd>
<p>An alert to warn that the lag on a consumer group is too large for a specific topic partition.
The default configuration is 1000 records.
A large lag might indicate that consumers are too slow and are falling behind the producers.</p>
</dd>
<dt class="hdlist1"><code>NoMessageForTooLong</code></dt>
<dd>
<p>An alert to warn that a topic has not received messages for a period of time.
The default configuration for the time period is 10 minutes.
The delay might be a result of a configuration issue preventing a producer from publishing messages to the topic.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Adapt the default configuration of these rules according to your specific needs.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#assembly-metrics-setup-str">Add Prometheus and Grafana</a></p>
</li>
<li>
<p><a href="#ref-metrics-config-files-str">Example metrics files</a></p>
</li>
<li>
<p><a href="#con-metrics-prometheus-alerts-str">Alerting rules</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ref-metrics-kafka-exporter-str"><a class="link" href="#ref-metrics-kafka-exporter-str">6.3.3. Exposing Kafka Exporter metrics</a></h4>
<div class="paragraph">
<p>Lag information is exposed by Kafka Exporter as Prometheus metrics for presentation in Grafana.</p>
</div>
<div class="paragraph">
<p>Kafka Exporter exposes metrics data for brokers, topics and consumer groups.
These metrics are displayed on the example <code>strimzi-kafka-exporter</code> dashboard.</p>
</div>
<div class="paragraph">
<p>The data extracted is described here.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. Broker metrics output</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Information</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_brokers</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of brokers in the Kafka cluster</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. Topic metrics output</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Information</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_topic_partitions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of partitions for a topic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_topic_partition_current_offset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current topic partition offset for a broker</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_topic_partition_oldest_offset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oldest topic partition offset for a broker</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_topic_partition_in_sync_replica</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of in-sync replicas for a topic partition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_topic_partition_leader</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Leader broker ID of a topic partition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_topic_partition_leader_is_preferred</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shows <code>1</code> if a topic partition is using the preferred broker</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_topic_partition_replicas</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of replicas for this topic partition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_topic_partition_under_replicated_partition</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shows <code>1</code> if a topic partition is under-replicated</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. Consumer group metrics output</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Information</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_consumergroup_current_offset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current topic partition offset for a consumer group</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka_consumergroup_lag</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current approximate lag for a consumer group at a topic partition</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Consumer group metrics are only displayed on the Kafka Exporter dashboard if at least one consumer group has a lag greater than zero.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-kafka-exporter-configuring-str"><a class="link" href="#proc-kafka-exporter-configuring-str">6.3.4. Configuring Kafka Exporter</a></h4>
<div class="paragraph">
<p>This procedure shows how to configure Kafka Exporter in the <code>Kafka</code> resource through <code>KafkaExporter</code> properties.</p>
</div>
<div class="paragraph">
<p>For more information about configuring the <code>Kafka</code> resource, see <a href="./using.html#assembly-config-kafka-str" target="_blank" rel="noopener">Kafka cluster configuration</a> in the <em>Using Strimzi</em> guide.</p>
</div>
<div class="paragraph">
<p>The properties relevant to the Kafka Exporter configuration are shown in this procedure.</p>
</div>
<div class="paragraph">
<p>You can configure these properties as part of a deployment or redeployment of the Kafka cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>KafkaExporter</code> properties for the <code>Kafka</code> resource.</p>
<div class="paragraph">
<p>The properties you can configure are shown in this example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  kafkaExporter:
    image: my-registry.io/my-org/my-exporter-cluster:latest <b class="conum">(1)</b>
    groupRegex: ".*" <b class="conum">(2)</b>
    topicRegex: ".*" <b class="conum">(3)</b>
    resources: <b class="conum">(4)</b>
      requests:
        cpu: 200m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 128Mi
    logging: debug <b class="conum">(5)</b>
    enableSaramaLogging: true <b class="conum">(6)</b>
    template: <b class="conum">(7)</b>
      pod:
        metadata:
          labels:
            label1: value1
        imagePullSecrets:
          - name: my-docker-credentials
        securityContext:
          runAsUser: 1000001
          fsGroup: 0
        terminationGracePeriodSeconds: 120
    readinessProbe: <b class="conum">(8)</b>
      initialDelaySeconds: 15
      timeoutSeconds: 5
    livenessProbe: <b class="conum">(9)</b>
      initialDelaySeconds: 15
      timeoutSeconds: 5
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>ADVANCED OPTION: Container image configuration, which is <a href="./using.html#con-common-configuration-images-reference">recommended only in special situations</a>.</p>
</li>
<li>
<p>A regular expression to specify the consumer groups to include in the metrics.</p>
</li>
<li>
<p>A regular expression to specify the topics to include in the metrics.</p>
</li>
<li>
<p><a href="./using.html#con-common-configuration-resources-reference">CPU and memory resources to reserve</a>.</p>
</li>
<li>
<p>Logging configuration, to log messages with a given severity (info, debug, trace) or above.</p>
</li>
<li>
<p>Boolean to enable Sarama logging, a Go client library used by Kafka Exporter.</p>
</li>
<li>
<p><a href="./using.html#assembly-customizing-kubernetes-resources-str">Customization of deployment templates and pods</a>.</p>
</li>
<li>
<p><a href="./using.html#con-common-configuration-healthchecks-reference">Healthcheck readiness probes</a>.</p>
</li>
<li>
<p><a href="./using.html#con-common-configuration-healthchecks-reference">Healthcheck liveness probes</a>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>kafka.yaml</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">What to do next</div>
<p>After configuring and deploying Kafka Exporter, you can <a href="#proc-kafka-exporter-enabling-str">enable Grafana to present the Kafka Exporter dashboards</a>.</p>
</div>
<div class="paragraph">
<div class="title">Additional resources</div>
<p><a href="./using.html#type-KafkaExporterTemplate-reference"><code>KafkaExporterTemplate</code> schema reference</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-kafka-exporter-enabling-str"><a class="link" href="#proc-kafka-exporter-enabling-str">6.3.5. Enabling the Kafka Exporter Grafana dashboard</a></h4>
<div class="paragraph">
<p>Strimzi provides <a href="#ref-metrics-config-files-str">example dashboard configuration files for Grafana</a>.
The Kafka Exporter dashboard is provided in the <a href="https://github.com/strimzi/strimzi-kafka-operator/tree/main/examples/metrics">examples/metrics</a> directory as a JSON file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>strimzi-kafka-exporter.json</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you deployed Kafka Exporter with your Kafka cluster, you can visualize the metrics data it exposes on the Grafana dashboard.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Kafka is deployed with <a href="#proc-kafka-exporter-configuring-str">Kafka Exporter metrics configuration</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Prometheus and Prometheus Alertmanager are deployed to the Kafka cluster</a></p>
</li>
<li>
<p><a href="#proc-metrics-deploying-grafana-str">Grafana is deployed to the Kafka cluster</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This procedure assumes you already have access to the Grafana user interface and Prometheus has been added as a data source.
If you are accessing the user interface for the first time, see <a href="#assembly-metrics-grafana-str">Grafana</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p><a href="#proc-metrics-grafana-dashboard-str">Access the Grafana user interface</a>.</p>
</li>
<li>
<p>Select the <em>Strimzi Kafka Exporter</em> dashboard.</p>
<div class="paragraph">
<p>When metrics data has been collected for some time, the Kafka Exporter charts are populated.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Strimzi Kafka Exporter</dt>
<dd>
<p>Shows metrics for:</p>
<div class="ulist">
<ul>
<li>
<p>Topic count</p>
</li>
<li>
<p>Partition count</p>
</li>
<li>
<p>Replicas count</p>
</li>
<li>
<p>In-sync replicas count</p>
</li>
<li>
<p>Under-replicated partitions count</p>
</li>
<li>
<p>Partitions which are at their minimum in sync replica count</p>
</li>
<li>
<p>Partitions which are under their minimum in sync replica count</p>
</li>
<li>
<p>Partitions not on a preferred node</p>
</li>
<li>
<p>Messages in per second from topics</p>
</li>
<li>
<p>Messages consumed per second from topics</p>
</li>
<li>
<p>Messages consumed per minute by consumer groups</p>
</li>
<li>
<p>Lag by consumer group</p>
</li>
<li>
<p>Number of partitions</p>
</li>
<li>
<p>Latest offsets</p>
</li>
<li>
<p>Oldest offsets</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Use the Grafana charts to analyze lag and to check if actions to reduce lag are having an impact on an affected consumer group.
If, for example, Kafka brokers are adjusted to reduce lag, the dashboard will show the  <em>Lag by consumer group</em> chart going down and the <em>Messages consumed per minute</em> chart going up.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-kafka-bridge-str"><a class="link" href="#assembly-kafka-bridge-str">6.4. Monitor Kafka Bridge</a></h3>
<div class="paragraph">
<p>If you are already using Prometheus and Grafana for monitoring of built-in Kafka metrics, you can configure Prometheus to also scrape the Kafka Bridge Prometheus endpoint.</p>
</div>
<div class="paragraph">
<p>The example Grafana dashboard for the Kafka Bridge provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Information about HTTP connections and related requests to the different endpoints</p>
</li>
<li>
<p>Information about the Kafka consumers and producers used by the bridge</p>
</li>
<li>
<p>JVM metrics from the bridge itself</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="configuring_kafka_bridge"><a class="link" href="#configuring_kafka_bridge">6.4.1. Configuring Kafka Bridge</a></h4>
<div class="paragraph">
<p>You can enable the Kafka Bridge metrics in the <code>KafkaBridge</code> resource using the <code>enableMetrics</code> property.</p>
</div>
<div class="paragraph">
<p>You can configure this property as part of a deployment or redeployment of the Kafka Bridge.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaBridge
metadata:
  name: my-bridge
spec:
  # ...
  bootstrapServers: my-cluster-kafka:9092
  http:
    # ...
  enableMetrics: true
  # ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enabling_the_kafka_bridge_grafana_dashboard"><a class="link" href="#enabling_the_kafka_bridge_grafana_dashboard">6.4.2. Enabling the Kafka Bridge Grafana dashboard</a></h4>
<div class="paragraph _abstract">
<p>Use a Grafana dashboard to visualize Kafka Bridge data.
If you deployed Kafka Bridge with your Kafka cluster, you can enable Grafana to present the metrics data it exposes.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#ref-metrics-config-files-str">example dashboard configuration files for Kafka Bridge</a>.
The following Kafka Bridge dashboard is provided as a JSON file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>strimzi-kafka-bridge.json</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When metrics data has been collected for some time, the Kafka Bridge charts are populated.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Kafka Bridge</dt>
<dd>
<p>Shows metrics for:</p>
<div class="ulist">
<ul>
<li>
<p>HTTP connections to the Kafka Bridge count</p>
</li>
<li>
<p>HTTP requests being processed count</p>
</li>
<li>
<p>Requests processed per second grouped by HTTP method</p>
</li>
<li>
<p>The total request rate grouped by response codes (2XX, 4XX, 5XX)</p>
</li>
<li>
<p>Bytes received and sent per second</p>
</li>
<li>
<p>Requests for each Kafka Bridge endpoint</p>
</li>
<li>
<p>Number of Kafka consumers, producers, and related opened connections used by the Kafka Bridge itself</p>
</li>
<li>
<p>Kafka producer:</p>
<div class="ulist">
<ul>
<li>
<p>The average number of records sent per second (grouped by topic)</p>
</li>
<li>
<p>The number of outgoing bytes sent to all brokers per second (grouped by topic)</p>
</li>
<li>
<p>The average number of records per second that resulted in errors (grouped by topic)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Kafka consumer:</p>
<div class="ulist">
<ul>
<li>
<p>The average number of records consumed per second (grouped by clientId-topic)</p>
</li>
<li>
<p>The average number of bytes consumed per second (grouped by clientId-topic)</p>
</li>
<li>
<p>Partitions assigned (grouped by clientId)</p>
</li>
</ul>
</div>
</li>
<li>
<p>JVM memory used</p>
</li>
<li>
<p>JVM garbage collection time</p>
</li>
<li>
<p>JVM garbage collection count</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-cruise-control-str"><a class="link" href="#assembly-cruise-control-str">6.5. Monitor Cruise Control</a></h3>
<div class="paragraph _abstract">
<p>If you are already using Prometheus and Grafana for monitoring of built-in Kafka metrics, you can configure Prometheus to also scrape the Cruise Control Prometheus endpoint.</p>
</div>
<div class="paragraph">
<p>The example Grafana dashboard for Cruise Control provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Information about optimization proposals computation, goals violation, cluster balancedness, and more</p>
</li>
<li>
<p>Information about REST API calls for rebalance proposals and actual rebalance operations</p>
</li>
<li>
<p>JVM metrics from Cruise Control itself</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="configuring_cruise_control"><a class="link" href="#configuring_cruise_control">6.5.1. Configuring Cruise Control</a></h4>
<div class="paragraph">
<p>Enable Cruise Control metrics using the <code>cruiseControl.metricsConfig</code> property in the <code>Kafka</code> resource to provide a reference to a ConfigMap that contains JMX exporter configuration for the metrics to expose.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  kafka:
    # ...
  zookeeper:
    # ...
  cruiseControl:
    metricsConfig:
       type: jmxPrometheusExporter
       valueFrom:
         configMapKeyRef:
           name: my-config-map
           key: my-key</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enabling_the_cruise_control_grafana_dashboard"><a class="link" href="#enabling_the_cruise_control_grafana_dashboard">6.5.2. Enabling the Cruise Control Grafana dashboard</a></h4>
<div class="paragraph">
<p>If you deployed Cruise Control with your Kafka cluster with the metrics enabled, you can enable Grafana to present the metrics data it exposes.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#ref-metrics-config-files-str">example dashboard configuration files for Cruise Control</a>.
The following Cruise Control dashboard is provided as a JSON file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>strimzi-cruise-control.json</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When metrics data has been collected for some time, the Cruise Control charts are populated.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cruise Control</dt>
<dd>
<p>Shows metrics for:</p>
<div class="ulist">
<ul>
<li>
<p>Number of snapshot windows that are monitored by Cruise Control</p>
</li>
<li>
<p>Number of time windows considered valid because they contain enough samples to compute an optimization proposal</p>
</li>
<li>
<p>Number of ongoing executions running for proposals or rebalances</p>
</li>
<li>
<p>Current balancedness score of the Kafka cluster as calculated by the anomaly detector component of Cruise Control (every 5 minutes by default)</p>
</li>
<li>
<p>Percentage of monitored partitions</p>
</li>
<li>
<p>Number of goal violations reported by the anomaly detector (every 5 minutes by default)</p>
</li>
<li>
<p>How often a disk read failure happens on the brokers</p>
</li>
<li>
<p>Rate of metric sample fetch failures</p>
</li>
<li>
<p>Time needed to compute an optimization proposal</p>
</li>
<li>
<p>Time needed to create the cluster model</p>
</li>
<li>
<p>How often a proposal request or an actual rebalance request is made through the Cruise Control REST API</p>
</li>
<li>
<p>How often the overall cluster state and the user tasks state are requested through the Cruise Control REST API</p>
</li>
<li>
<p>JVM memory used</p>
</li>
<li>
<p>JVM garbage collection time</p>
</li>
<li>
<p>JVM garbage collection count</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-upgrade-str"><a class="link" href="#assembly-upgrade-str">7. Upgrading Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Strimzi can be upgraded to version 0.26.0 to take advantage of new features and enhancements, performance improvements, and security options.</p>
</div>
<div class="paragraph">
<p>As part of the upgrade, you upgrade Kafka to the latest supported version.
Each Kafka release introduces new features, improvements, and bug fixes to your Strimzi deployment.</p>
</div>
<div class="paragraph">
<p>Strimzi can be <a href="#assembly-downgrade-str">downgraded</a> to the previous version if you encounter issues with the newer version.</p>
</div>
<div class="paragraph">
<div class="title">Upgrade paths</div>
<p>Two upgrade paths are possible:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Incremental</dt>
<dd>
<p>Upgrading Strimzi from the previous minor version to version 0.26.0.</p>
</dd>
<dt class="hdlist1">Multi-version</dt>
<dd>
<p>Upgrading Strimzi from an old version to version 0.26.0 within a single upgrade (skipping one or more intermediate versions).</p>
<div class="paragraph">
<p>For example, upgrading from Strimzi 0.20.0 directly to Strimzi 0.22.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Upgrading from a version earlier than 0.22</div>
<p>The <code>v1beta2</code> API version for all custom resources was introduced with Strimzi 0.22.
For Strimzi 0.23 and newer, the <code>v1alpha1</code> and <code>v1beta1</code> API versions were removed from all Strimzi custom resources apart from <code>KafkaTopic</code> and <code>KafkaUser</code>.</p>
</div>
<div class="paragraph">
<p>If you are upgrading from a Strimzi version prior to version 0.22:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Upgrade Strimzi to 0.22</p>
</li>
<li>
<p>Convert the custom resources to <code>v1beta2</code></p>
</li>
<li>
<p>Upgrade Strimzi to 0.23 or newer</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As an alternative, you can install the custom resources from version 0.22, convert the resources, and then upgrade to 0.23 or newer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Kafka version support</div>
<p>You can review supported Kafka versions in the <a href="https://strimzi.io/downloads/" target="_blank" rel="noopener">Supported versions</a> table.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>Operators</strong> column lists all released Strimzi versions (the Strimzi version is often called the "Operator version").</p>
</li>
<li>
<p>The <strong>Kafka versions</strong> column lists the supported Kafka versions for each Strimzi version.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Decide which Kafka version to upgrade to before beginning the Strimzi upgrade process.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can upgrade to a higher Kafka version as long as it is supported by your version of Strimzi.
In some cases, you can also downgrade to a previous supported Kafka version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Downtime and availability</div>
<p>If topics are configured for high availability, upgrading Strimzi should not cause any downtime for consumers and producers that publish and read data from those topics.
Highly available topics have a replication factor of at least 3 and partitions distributed evenly among the brokers.</p>
</div>
<div class="paragraph">
<p>Upgrading Strimzi triggers rolling updates, where all brokers are restarted in turn, at different stages of the process.
During rolling updates, not all brokers are online, so overall <em>cluster availability</em> is temporarily reduced.
A reduction in cluster availability increases the chance that a broker failure will result in lost messages.</p>
</div>
<div class="sect2">
<h3 id="assembly-upgrade-kafka-str"><a class="link" href="#assembly-upgrade-kafka-str">7.1. Required upgrade sequence</a></h3>
<div class="paragraph">
<p>To upgrade brokers and clients without downtime, you <em>must</em> complete the Strimzi upgrade procedures in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure your Kubernetes cluster version is supported.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Strimzi 0.26.0 requires Kubernetes 1.16 and later.</p>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><a href="#con-upgrade-cluster-str">Upgrading Kubernetes</a></p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>When upgrading from 0.22 or earlier, update existing custom resources to support the <code>v1beta2</code> API version.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><a href="#assembly-upgrade-resources-str">Strimzi custom resource upgrades</a></p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Update your Cluster Operator to a new Strimzi version.</p>
<div class="paragraph">
<p>The approach you take depends on how you <a href="#cluster-operator-str">deployed the Cluster Operator</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you deployed the Cluster Operator using the installation YAML files, perform your upgrade by modifying the Operator installation files, as described in <a href="#proc-upgrading-the-co-str">Upgrading the Cluster Operator</a>.</p>
</li>
<li>
<p>If you deployed the Cluster Operator from <a href="https://operatorhub.io/" target="_blank" rel="noopener">OperatorHub.io</a>, use the Operator Lifecycle Manager (OLM) to change the update channel for the Strimzi Operators to a new Strimzi version.</p>
<div class="paragraph">
<p>Depending on your chosen upgrade strategy, after updating the channel, either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An automatic upgrade is initiated</p>
</li>
<li>
<p>A manual upgrade will require approval before the installation begins</p>
<div class="paragraph">
<p>For more information on using <a href="https://operatorhub.io/" target="_blank" rel="noopener">OperatorHub.io</a> to upgrade Operators, see the <a href="https://olm.operatorframework.io/docs/" target="_blank" rel="noopener">Operator Lifecycle Manager documentation</a>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If you deployed the Cluster Operator using a Helm chart, use <code>helm upgrade</code>.</p>
<div class="paragraph">
<p>The <code>helm upgrade</code> command does not upgrade the <a href="https://helm.sh/docs/chart_best_practices/custom_resource_definitions/" target="_blank" rel="noopener">Custom Resource Definitions for Helm</a>.
Install the new CRDs manually after upgrading the Cluster Operator.
You can access the CRDs from <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub</a> or find them in the <code>crd</code> subdirectory inside the Helm Chart.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Upgrade all Kafka brokers and client applications to the latest supported Kafka version.</p>
<div class="ulist">
<ul>
<li>
<p><a href="#assembly-upgrading-kafka-versions-str">Upgrading Kafka</a></p>
</li>
<li>
<p><a href="#con-strategies-for-upgrading-clients-str">Strategies for upgrading clients</a></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Optional: incremental cooperative rebalance upgrade</div>
<p>Consider upgrading consumers and Kafka Streams applications to use the <em>incremental cooperative rebalance</em> protocol for partition rebalances.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-upgrading-consumers-streams-cooperative-rebalancing_str">Upgrading consumers to cooperative rebalancing</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="con-upgrade-cluster-str"><a class="link" href="#con-upgrade-cluster-str">7.2. Upgrading Kubernetes</a></h3>
<div class="paragraph _abstract">
<p>If you are upgrading Strimzi, you may also need to upgrade your Kubernetes cluster to a supported version.</p>
</div>
<div class="paragraph">
<p>Refer to your Kubernetes distribution upgrade documentation to check the upgrade path and the steps to upgrade your nodes correctly.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To check supported Kubernetes versions, see <a href="https://strimzi.io/downloads/" target="_blank" rel="noopener">Supported versions</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When performing your upgrade, you&#8217;ll want to keep your Strimzi clusters available.
You can employ the following strategies to do this.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuring pod disruption budgets</p>
</li>
<li>
<p>Rolling pods while keeping topics available</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="configuring_pod_disruption_budgets"><a class="link" href="#configuring_pod_disruption_budgets">7.2.1. Configuring pod disruption budgets</a></h4>
<div class="paragraph">
<p>A pod disruption budget allows only a specified number of pods to be unavailable at a given time.
During planned maintenance of Kafka broker pods, a pod disruption budget ensures Kafka continues to run in a highly available environment.</p>
</div>
<div class="paragraph">
<p>You specify a pod disruption budget using a <code>template</code> customization for a Kafka component.
Labels and annotations identify resources.
By default, pod disruption budgets allow only a single pod to be unavailable at a given time.
You can increase the number of unavailable pods allowed by changing the default value of the <code>maxUnavailable</code> property.</p>
</div>
<div class="paragraph">
<p>If you used the Cluster Operator to deploy Kafka, you can use the Strimzi Drain Cleaner tool to evict nodes during an upgrade.
To do this, you set <code>maxUnavailable</code> to 0. This prevents voluntary disruptions, so pods must be evicted manually.</p>
</div>
<div class="listingblock">
<div class="title">Specifying a pod discruption budget</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
template:
  podDisruptionBudget:
    metadata:
      labels:
        key1: label1
        key2: label2
      annotations:
        key1: label1
        key2: label2
    maxUnavailable: 1
# ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rolling_pods_while_keeping_topics_available"><a class="link" href="#rolling_pods_while_keeping_topics_available">7.2.2. Rolling pods while keeping topics available</a></h4>
<div class="paragraph">
<p>During an upgrade, you can trigger a rolling update of pods through the Cluster Operator.
Using <code>Pod</code> resources, rolling updates restart the pods of resources with new pods.</p>
</div>
<div class="paragraph">
<p>You add a pod annotation to make the update.
Here, the annotation updates a Kafka broker.</p>
</div>
<div class="listingblock">
<div class="title">Performing a manual rolling update on a Kafka broker pod</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate pod <em>&lt;cluster_name&gt;</em>-kafka-<em>&lt;index&gt;</em> strimzi.io/manual-rolling-update=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You replace <em>&lt;cluster_name&gt;</em> with the name of the cluster.
Kafka broker pods are named <em>&lt;cluster-name&gt;</em>-kafka-<em>&lt;index&gt;</em>, where <em>&lt;index&gt;</em> starts at zero and ends at the total number of replicas.
For example, <code>my-cluster-kafka-0</code>.</p>
</div>
<div class="paragraph">
<p>For Kafka to stay operational, topics must be replicated for high availability.
This requires topic configuration that specifies a replication factor of at least 3 and a minimum number of in-sync replicas to 1 less than the replication factor.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic replicated for high availability</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 1
  replicas: 1
  config:
    # ...
    default.replication.factor: 3
    min.insync.replicas: 2
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a highly available environment, the Cluster Operator maintains a minimum number of in-sync replicas for topics during the upgrade process so that there is no downtime.</p>
</div>
<div class="paragraph">
<p>You can use the Strimzi Drain Cleaner to evict pods during an upgrade.
The Drain Cleaner annotates the pods with the same rolling update pod annotation.
This informs the Cluster Operator to perform a rolling update of the evicted pod.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/home/" target="_blank" rel="noopener">Kubernetes documentation</a></p>
</li>
<li>
<p><a href="https://olm.operatorframework.io/docs/" target="_blank" rel="noopener">Operator Lifecycle Manager documentation</a></p>
</li>
<li>
<p><a href="./using.html#replicating_topics_for_high_availability" target="_blank" rel="noopener">Replicating topics for high availability</a></p>
</li>
<li>
<p><a href="./using.html#type-PodDisruptionBudgetTemplate-reference" target="_blank" rel="noopener">PodDisruptionBudgetTemplate schema reference</a></p>
</li>
<li>
<p><a href="./using.html#proc-manual-rolling-update-pods-str" target="_blank" rel="noopener">Performing a rolling update using a pod annotation</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-upgrade-resources-str"><a class="link" href="#assembly-upgrade-resources-str">7.3. Strimzi custom resource upgrades</a></h3>
<div class="paragraph">
<p>When upgrading Strimzi to 0.26.0 from 0.22 or earlier, you must ensure that your custom resources are using API version <code>v1beta2</code>.
You must upgrade the Custom Resource Definitions and the custom resources <strong>before</strong> upgrading to Strimzi 0.23 or newer.
To perform the upgrade, you can use the <em>API conversion tool</em> provided with Strimzi 0.24.
For more information, see the <a href="https://strimzi.io/docs/operators/0.24.0/deploying.html#assembly-upgrade-resources-str" target="_blank" rel="noopener">Strimzi 0.24.0 upgrade documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="proc-upgrading-the-co-str"><a class="link" href="#proc-upgrading-the-co-str">7.4. Upgrading the Cluster Operator</a></h3>
<div class="paragraph">
<p>This procedure describes how to upgrade a Cluster Operator deployment to use Strimzi 0.26.0.</p>
</div>
<div class="paragraph">
<p>Follow this procedure if you deployed the Cluster Operator using the installation YAML files rather than <a href="https://operatorhub.io/" target="_blank" rel="noopener">OperatorHub.io</a>.</p>
</div>
<div class="paragraph">
<p>The availability of Kafka clusters managed by the Cluster Operator is not affected by the upgrade operation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Refer to the documentation supporting a specific version of Strimzi for information on how to upgrade to that version.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An existing Cluster Operator deployment is available.</p>
</li>
<li>
<p>You have <a href="#downloads-str">downloaded the release artifacts for Strimzi 0.26.0</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Take note of any configuration changes made to the existing Cluster Operator resources (in the <code>/install/cluster-operator</code> directory).
Any changes will be <strong>overwritten</strong> by the new version of the Cluster Operator.</p>
</li>
<li>
<p>Update your custom resources to reflect the supported configuration options available for Strimzi version 0.26.0.</p>
</li>
<li>
<p>Update the Cluster Operator.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Modify the installation files for the new Cluster Operator version according to the namespace the Cluster Operator is running in.</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i '' 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>If you modified one or more environment variables in your existing Cluster Operator <code>Deployment</code>, edit the
<code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to use those environment variables.</p>
</li>
</ol>
</div>
</li>
<li>
<p>When you have an updated configuration, deploy it along with the rest of the installation resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl replace -f install/cluster-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the rolling updates to complete.</p>
</div>
</li>
<li>
<p>If the new Operator version no longer supports the Kafka version you are upgrading from, the Cluster Operator returns a "Version not found" error message.
Otherwise, no error message is returned.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">"Version 2.4.0 is not supported. Supported versions are: 2.6.0, 2.6.1, 2.7.0."</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If the error message is returned, upgrade to a Kafka version that is supported by the new Cluster Operator version:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Edit the <code>Kafka</code> custom resource.</p>
</li>
<li>
<p>Change the <code>spec.kafka.version</code> property to a supported Kafka version.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If the error message is <em>not</em> returned, go to the next step.
You will upgrade the Kafka version later.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Get the image for the Kafka pod to ensure the upgrade was successful:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image tag shows the new Operator version. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">quay.io/strimzi/kafka:0.26.0-kafka-2.8.0</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Your Cluster Operator was upgraded to version 0.26.0 but the version of Kafka running in the cluster it manages is unchanged.</p>
</div>
<div class="paragraph">
<p>Following the Cluster Operator upgrade, you must perform a <a href="#assembly-upgrading-kafka-versions-str">Kafka upgrade</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="assembly-upgrading-kafka-versions-str"><a class="link" href="#assembly-upgrading-kafka-versions-str">7.5. Upgrading Kafka</a></h3>
<div class="paragraph">
<p>After you have upgraded your Cluster Operator to 0.26.0, the next step is to upgrade all Kafka brokers to the latest supported version of Kafka.</p>
</div>
<div class="paragraph">
<p>Kafka upgrades are performed by the Cluster Operator through rolling updates of the Kafka brokers.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator initiates rolling updates based on the Kafka cluster configuration.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">If <code>Kafka.spec.kafka.config</code> contains&#8230;&#8203;</th>
<th class="tableblock halign-left valign-top">The Cluster Operator initiates&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both the <code>inter.broker.protocol.version</code> and the <code>log.message.format.version</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A single rolling update. After the update, the <code>inter.broker.protocol.version</code> must be updated manually, followed by <code>log.message.format.version</code>.
Changing each will trigger a further rolling update.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either the <code>inter.broker.protocol.version</code> or the <code>log.message.format.version</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Two rolling updates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No configuration for the <code>inter.broker.protocol.version</code> or the <code>log.message.format.version</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Two rolling updates.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As part of the Kafka upgrade, the Cluster Operator initiates rolling updates for ZooKeeper.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single rolling update occurs even if the ZooKeeper version is unchanged.</p>
</li>
<li>
<p>Additional rolling updates occur if the new version of Kafka requires a new ZooKeeper version.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#proc-upgrading-the-co-str">Upgrading the Cluster Operator</a></p>
</li>
<li>
<p><a href="#ref-kafka-versions-str">Kafka versions</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="ref-kafka-versions-str"><a class="link" href="#ref-kafka-versions-str">7.5.1. Kafka versions</a></h4>
<div class="paragraph">
<p>Kafka&#8217;s log message format version and inter-broker protocol version specify, respectively, the log format version appended to messages and the version of the Kafka protocol used in a cluster.
To ensure the correct versions are used, the upgrade process involves making configuration changes to existing Kafka brokers and code changes to client applications (consumers and producers).</p>
</div>
<div class="paragraph">
<p>The following table shows the differences between Kafka versions:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kafka version</th>
<th class="tableblock halign-left valign-top">Interbroker protocol version</th>
<th class="tableblock halign-left valign-top">Log message format version</th>
<th class="tableblock halign-left valign-top">ZooKeeper version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.7.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5.9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.8.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5.9</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Inter-broker protocol version</div>
<p>In Kafka, the network protocol used for inter-broker communication is called the <em>inter-broker protocol</em>.
Each version of Kafka has a compatible version of the inter-broker protocol.
The minor version of the protocol typically increases to match the minor version of Kafka, as shown in the preceding table.</p>
</div>
<div class="paragraph">
<p>The inter-broker protocol version is set cluster wide in the <code>Kafka</code> resource.
To change it, you edit the <code>inter.broker.protocol.version</code> property in <code>Kafka.spec.kafka.config</code>.</p>
</div>
<div class="paragraph">
<div class="title">Log message format version</div>
<p>When a producer sends a message to a Kafka broker, the message is encoded using a specific format.
The format can change between Kafka releases, so messages specify which version of the format they were encoded with. You can configure a Kafka broker to convert messages from newer format versions to a given older format version before the broker appends the message to the log.</p>
</div>
<div class="paragraph">
<p>In Kafka, there are two different methods for setting the message format version:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>message.format.version</code> property is set on topics.</p>
</li>
<li>
<p>The <code>log.message.format.version</code> property is set on Kafka brokers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The default value of <code>message.format.version</code> for a topic is defined by the <code>log.message.format.version</code> that is set on the Kafka broker. You can manually set the <code>message.format.version</code> of a topic by modifying its topic configuration.</p>
</div>
<div class="paragraph">
<p>The upgrade tasks in this section assume that the message format version is defined by the <code>log.message.format.version</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-strategies-for-upgrading-clients-str"><a class="link" href="#con-strategies-for-upgrading-clients-str">7.5.2. Strategies for upgrading clients</a></h4>
<div class="paragraph">
<p>The right approach to upgrading your client applications (including Kafka Connect connectors) depends on your particular circumstances.</p>
</div>
<div class="paragraph">
<p>Consuming applications need to receive messages in a message format that they understand. You can ensure that this is the case in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By upgrading all the consumers for a topic <em>before</em> upgrading any of the producers.</p>
</li>
<li>
<p>By having the brokers down-convert messages to an older format.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using broker down-conversion puts extra load on the brokers, so it is not ideal to rely on down-conversion for all topics for a prolonged period of time.
For brokers to perform optimally they should not be down converting messages at all.</p>
</div>
<div class="paragraph">
<p>Broker down-conversion is configured in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The topic-level <code>message.format.version</code> configures it for a single topic.</p>
</li>
<li>
<p>The broker-level <code>log.message.format.version</code> is the default for topics that do not have the topic-level <code>message.format.version</code> configured.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Messages published to a topic in a new-version format will be visible to consumers, because brokers perform down-conversion when they receive messages from producers, not when they are sent to consumers.</p>
</div>
<div class="paragraph">
<p>There are a number of strategies you can use to upgrade your clients:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Consumers first</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Upgrade all the consuming applications.</p>
</li>
<li>
<p>Change the broker-level <code>log.message.format.version</code> to the new version.</p>
</li>
<li>
<p>Upgrade all the producing applications.</p>
<div class="paragraph">
<p>This strategy is straightforward, and avoids any broker down-conversion.
However, it assumes that all consumers in your organization can be upgraded in a coordinated way, and it does not work for applications that are both consumers and producers.
There is also a risk that, if there is a problem with the upgraded clients, new-format messages might get added to the message log so that you cannot revert to the previous consumer version.</p>
</div>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Per-topic consumers first</dt>
<dd>
<p>For each topic:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Upgrade all the consuming applications.</p>
</li>
<li>
<p>Change the topic-level <code>message.format.version</code> to the new version.</p>
</li>
<li>
<p>Upgrade all the producing applications.</p>
<div class="paragraph">
<p>This strategy avoids any broker down-conversion, and means you can proceed on a topic-by-topic basis. It does not work for applications that are both consumers and producers of the same topic. Again, it has the risk that, if there is a problem with the upgraded clients, new-format messages might get added to the message log.</p>
</div>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Per-topic consumers first, with down conversion</dt>
<dd>
<p>For each topic:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change the topic-level <code>message.format.version</code> to the old version
(or rely on the topic defaulting to the broker-level <code>log.message.format.version</code>).</p>
</li>
<li>
<p>Upgrade all the consuming and producing applications.</p>
</li>
<li>
<p>Verify that the upgraded applications function correctly.</p>
</li>
<li>
<p>Change the topic-level <code>message.format.version</code> to the new version.</p>
<div class="paragraph">
<p>This strategy requires broker down-conversion, but the load on the brokers is minimized because it is only required for a single topic (or small group of topics) at a time. It also works for applications that are both consumers and producers of the same topic. This approach ensures that the upgraded producers and consumers are working correctly before you commit to using the new message format version.</p>
</div>
<div class="paragraph">
<p>The main drawback of this approach is that it can be complicated to manage in a cluster with many topics and applications.</p>
</div>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Other strategies for upgrading client applications are also possible.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It is also possible to apply multiple strategies.
For example, for the first few applications and topics the
"per-topic consumers first, with down conversion" strategy can be used.
When this has proved successful another, more efficient strategy can be considered acceptable to use instead.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="con-versions-and-images-str"><a class="link" href="#con-versions-and-images-str">7.5.3. Kafka version and image mappings</a></h4>
<div class="paragraph">
<p>When upgrading Kafka, consider your settings for the <code>STRIMZI_KAFKA_IMAGES</code> environment variable and the <code>Kafka.spec.kafka.version</code> property.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each <code>Kafka</code> resource can be configured with a <code>Kafka.spec.kafka.version</code>.</p>
</li>
<li>
<p>The Cluster Operator&#8217;s <code>STRIMZI_KAFKA_IMAGES</code> environment variable provides a mapping between the Kafka version and the image to be used when that version is requested in a given <code>Kafka</code> resource.</p>
<div class="ulist">
<ul>
<li>
<p>If <code>Kafka.spec.kafka.image</code> is not configured, the default image for the given version is used.</p>
</li>
<li>
<p>If <code>Kafka.spec.kafka.image</code> is configured, the default image is overridden.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The Cluster Operator cannot validate that an image actually contains a Kafka broker of the expected version.
Take care to ensure that the given image corresponds to the given Kafka version.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-upgrading-brokers-newer-kafka-str"><a class="link" href="#proc-upgrading-brokers-newer-kafka-str">7.5.4. Upgrading Kafka brokers and client applications</a></h4>
<div class="paragraph">
<p>This procedure describes how to upgrade a Strimzi Kafka cluster to the latest supported Kafka version.</p>
</div>
<div class="paragraph">
<p>Compared to your current Kafka version, the new version might support a higher <em>log message format version</em> or <em>inter-broker protocol version</em>, or both.
Follow the steps to upgrade these versions, if required.
For more information, see <a href="#ref-kafka-versions-str">Kafka versions</a>.</p>
</div>
<div class="paragraph">
<p>You should also choose a <a href="#con-strategies-for-upgrading-clients-str">strategy for upgrading clients</a>.
Kafka clients are upgraded in step 6 of this procedure.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>For the <code>Kafka</code> resource to be upgraded, check that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Cluster Operator, which supports both versions of Kafka, is up and running.</p>
</li>
<li>
<p>The <code>Kafka.spec.kafka.config</code> does <em>not</em> contain options that are not supported in the new Kafka version.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka cluster configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka <em>my-cluster</em></code></pre>
</div>
</div>
</li>
<li>
<p>If configured, ensure that <code>Kafka.spec.kafka.config</code> has the <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> set to the defaults for the <em>current</em> Kafka version.</p>
<div class="paragraph">
<p>For example, if upgrading from Kafka version 2.7.0 to 2.8.0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Kafka
spec:
  # ...
  kafka:
    version: 2.7.0
    config:
      log.message.format.version: "2.7"
      inter.broker.protocol.version: "2.7"
      # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> are not configured,
Strimzi automatically updates these versions to the current defaults after the update to the Kafka version in the next step.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The value of <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> must be strings to prevent them from being interpreted as floating point numbers.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Change the <code>Kafka.spec.kafka.version</code> to specify the new Kafka version; leave the <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> at the defaults for the <em>current</em> Kafka version.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Changing the <code>kafka.version</code> ensures that all brokers in the cluster will be upgraded to start using the new broker binaries.
During this process, some brokers are using the old binaries while others have already upgraded to the new ones.
Leaving the <code>inter.broker.protocol.version</code> unchanged ensures that the brokers can continue to communicate with each other throughout the upgrade.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, if upgrading from Kafka 2.7.0 to 2.8.0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 2.8.0 <b class="conum">(1)</b>
    config:
      log.message.format.version: "2.7" <b class="conum">(2)</b>
      inter.broker.protocol.version: "2.7" <b class="conum">(3)</b>
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Kafka version is changed to the new version.</p>
</li>
<li>
<p>Message format version is unchanged.</p>
</li>
<li>
<p>Inter-broker protocol version is unchanged.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
You cannot downgrade Kafka if the <code>inter.broker.protocol.version</code> for the new Kafka version changes. The inter-broker protocol version determines the schemas used for persistent metadata stored by the broker, including messages written to <code>__consumer_offsets</code>. The downgraded cluster will not understand the messages.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If the image for the Kafka cluster is defined in the Kafka custom resource, in <code>Kafka.spec.kafka.image</code>, update the <code>image</code> to point to a container image with the new Kafka version.</p>
<div class="paragraph">
<p>See <a href="#con-versions-and-images-str">Kafka version and image mappings</a></p>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
<div class="paragraph">
<p>Check the progress of the rolling updates by watching the pod state transitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling updates ensure that each pod is using the broker binaries for the new version of Kafka.</p>
</div>
</li>
<li>
<p>Depending on your chosen <a href="#con-strategies-for-upgrading-clients-str">strategy for upgrading clients</a>, upgrade all client applications to use the new version of the client binaries.</p>
<div class="paragraph">
<p>If required, set the <code>version</code> property for Kafka Connect and MirrorMaker as the new version of Kafka:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>For Kafka Connect, update <code>KafkaConnect.spec.version</code>.</p>
</li>
<li>
<p>For MirrorMaker, update <code>KafkaMirrorMaker.spec.version</code>.</p>
</li>
<li>
<p>For MirrorMaker 2.0, update <code>KafkaMirrorMaker2.spec.version</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If configured, update the Kafka resource to use the new <code>inter.broker.protocol.version</code> version. Otherwise, go to step 9.</p>
<div class="paragraph">
<p>For example, if upgrading to Kafka 2.8.0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 2.8.0
    config:
      log.message.format.version: "2.7"
      inter.broker.protocol.version: "2.8"
      # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to update the cluster.</p>
</li>
<li>
<p>If configured, update the Kafka resource to use the new <code>log.message.format.version</code> version. Otherwise, go to step 10.</p>
<div class="paragraph">
<p>For example, if upgrading to Kafka 2.8.0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 2.8.0
    config:
      log.message.format.version: "2.8"
      inter.broker.protocol.version: "2.8"
      # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to update the cluster.</p>
<div class="ulist">
<ul>
<li>
<p>The Kafka cluster and clients are now using the new Kafka version.</p>
</li>
<li>
<p>The brokers are configured to send messages using the inter-broker protocol version and message format version of the new version of Kafka.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Following the Kafka upgrade, if required, you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-upgrading-consumers-streams-cooperative-rebalancing_str">Upgrade consumers to use the incremental cooperative rebalance protocol</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-upgrading-consumers-streams-cooperative-rebalancing_str"><a class="link" href="#proc-upgrading-consumers-streams-cooperative-rebalancing_str">7.6. Upgrading consumers to cooperative rebalancing</a></h3>
<div class="paragraph">
<p>You can upgrade Kafka consumers and Kafka Streams applications to use the <em>incremental cooperative rebalance</em> protocol for partition rebalances instead of the default <em>eager rebalance</em> protocol. The new protocol was added in Kafka 2.4.0.</p>
</div>
<div class="paragraph">
<p>Consumers keep their partition assignments in a cooperative rebalance and only revoke them at the end of the process, if needed to achieve a balanced cluster. This reduces the unavailability of the consumer group or Kafka Streams application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Upgrading to the incremental cooperative rebalance protocol is optional. The eager rebalance protocol is still supported.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-upgrading-brokers-newer-kafka-str">upgraded Kafka brokers and client applications</a> to Kafka 2.8.0.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p><strong>To upgrade a Kafka consumer to use the incremental cooperative rebalance protocol:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Replace the Kafka clients <code>.jar</code> file with the new version.</p>
</li>
<li>
<p>In the consumer configuration, append <code>cooperative-sticky</code> to the <code>partition.assignment.strategy</code>. For example, if the <code>range</code> strategy is set, change the configuration to <code>range, cooperative-sticky</code>.</p>
</li>
<li>
<p>Restart each consumer in the group in turn, waiting for the consumer to rejoin the group after each restart.</p>
</li>
<li>
<p>Reconfigure each consumer in the group by removing the earlier <code>partition.assignment.strategy</code> from the consumer configuration, leaving only the <code>cooperative-sticky</code> strategy.</p>
</li>
<li>
<p>Restart each consumer in the group in turn, waiting for the consumer to rejoin the group after each restart.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>To upgrade a Kafka Streams application to use the incremental cooperative rebalance protocol:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Replace the Kafka Streams <code>.jar</code> file with the new version.</p>
</li>
<li>
<p>In the Kafka Streams configuration, set the <code>upgrade.from</code> configuration parameter to the Kafka version you are upgrading from (for example, 2.3).</p>
</li>
<li>
<p>Restart each of the stream processors (nodes) in turn.</p>
</li>
<li>
<p>Remove the <code>upgrade.from</code> configuration parameter from the Kafka Streams configuration.</p>
</li>
<li>
<p>Restart each consumer in the group in turn.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kafka.apache.org/documentation/#upgrade_240_notable" target="_blank" rel="noopener">Notable changes in 2.4.0</a> in the Apache Kafka documentation.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-downgrade-str"><a class="link" href="#assembly-downgrade-str">8. Downgrading Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are encountering issues with the version of Strimzi you upgraded to,
you can revert your installation to the previous version.</p>
</div>
<div class="paragraph">
<p>You can perform a downgrade to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Revert your Cluster Operator to the previous Strimzi version.</p>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-downgrade-cluster-operator-str">Downgrading the Cluster Operator to a previous version</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Downgrade all Kafka brokers and client applications to the previous Kafka version.</p>
<div class="ulist">
<ul>
<li>
<p><a href="#assembly-downgrade-kafka-versions-str">Downgrading Kafka</a></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the previous version of Strimzi does not support the version of Kafka you are using,
you can also downgrade Kafka as long as the log message format versions appended to messages match.</p>
</div>
<div class="sect2">
<h3 id="proc-downgrade-cluster-operator-str"><a class="link" href="#proc-downgrade-cluster-operator-str">8.1. Downgrading the Cluster Operator to a previous version</a></h3>
<div class="paragraph">
<p>If you are encountering issues with Strimzi,
you can revert your installation.</p>
</div>
<div class="paragraph">
<p>This procedure describes how to downgrade a Cluster Operator deployment to a previous version.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An existing Cluster Operator deployment is available.</p>
</li>
<li>
<p>You have <a href="#downloads-str">downloaded the installation files for the previous version</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Take note of any configuration changes made to the existing Cluster Operator resources (in the <code>/install/cluster-operator</code> directory).
Any changes will be <strong>overwritten</strong> by the previous version of the Cluster Operator.</p>
</li>
<li>
<p>Revert your custom resources to reflect the supported configuration options available for the version of Strimzi you are downgrading to.</p>
</li>
<li>
<p>Update the Cluster Operator.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Modify the installation files for the previous version according to the namespace the Cluster Operator is running in.</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>sed -i '' 's/namespace: .*/namespace: <em>my-cluster-operator-namespace</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>If you modified one or more environment variables in your existing Cluster Operator <code>Deployment</code>, edit the
<code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to use those environment variables.</p>
</li>
</ol>
</div>
</li>
<li>
<p>When you have an updated configuration, deploy it along with the rest of the installation resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl replace -f install/cluster-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the rolling updates to complete.</p>
</div>
</li>
<li>
<p>Get the image for the Kafka pod to ensure the downgrade was successful:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pod my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image tag shows the new Strimzi version followed by the Kafka version. For example, <code><em>NEW-STRIMZI-VERSION</em>-kafka-<em>CURRENT-KAFKA-VERSION</em></code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Your Cluster Operator was downgraded to the previous version.</p>
</div>
</div>
<div class="sect2">
<h3 id="assembly-downgrade-kafka-versions-str"><a class="link" href="#assembly-downgrade-kafka-versions-str">8.2. Downgrading Kafka</a></h3>
<div class="paragraph">
<p>Kafka version downgrades are performed by the Cluster Operator.</p>
</div>
<div class="sect3">
<h4 id="con-target-downgrade-version-str"><a class="link" href="#con-target-downgrade-version-str">8.2.1. Kafka version compatibility for downgrades</a></h4>
<div class="paragraph">
<p>Kafka downgrades are dependent on compatible current and target <a href="#ref-kafka-versions-str">Kafka versions</a>,
and the state at which messages have been logged.</p>
</div>
<div class="paragraph">
<p>You cannot revert to the previous Kafka version if that version does not support any of the <code>inter.broker.protocol.version</code> settings which have <em>ever been used</em> in that cluster,
or messages have been added to message logs that use a newer <code>log.message.format.version</code>.</p>
</div>
<div class="paragraph">
<p>The <code>inter.broker.protocol.version</code> determines the schemas used for persistent metadata stored by the broker, such as the schema for messages written to <code>__consumer_offsets</code>.
If you downgrade to a version of Kafka that does not understand an <code>inter.broker.protocol.version</code> that has (ever) been previously used in the cluster the broker will encounter data it cannot understand.</p>
</div>
<div class="paragraph">
<p>If the target downgrade version of Kafka has:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>same</em> <code>log.message.format.version</code> as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.</p>
</li>
<li>
<p>A <em>different</em> <code>log.message.format.version</code>, downgrading is only possible if the running cluster has <em>always</em> had <code>log.message.format.version</code> set to the version used by the downgraded version.
This is typically only the case if the upgrade procedure was aborted before the <code>log.message.format.version</code> was changed.
In this case, the downgrade requires:</p>
<div class="ulist">
<ul>
<li>
<p>Two rolling restarts of the brokers if the interbroker protocol of the two versions is different</p>
</li>
<li>
<p>A single rolling restart if they are the same</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Downgrading is <em>not possible</em> if the new version has ever used a <code>log.message.format.version</code> that is not supported by the previous version, including when the default value for <code>log.message.format.version</code> is used. For example, this resource can be downgraded to Kafka version 2.7.0 because the <code>log.message.format.version</code> has not been changed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 2.8.0
    config:
      log.message.format.version: "2.7"
      # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The downgrade would not be possible if the <code>log.message.format.version</code> was set at <code>"2.8"</code> or a value was absent (so that the parameter took the default value for a 2.8.0 broker of 2.8).</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-downgrading-brokers-older-kafka-str"><a class="link" href="#proc-downgrading-brokers-older-kafka-str">8.2.2. Downgrading Kafka brokers and client applications</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how you can downgrade a Strimzi Kafka cluster to a lower (previous) version of Kafka, such as downgrading from 2.8.0 to 2.7.0.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>For the <code>Kafka</code> resource to be downgraded, check:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>IMPORTANT: <a href="#con-target-downgrade-version-str">Compatibility of Kafka versions</a>.</p>
</li>
<li>
<p>The Cluster Operator, which supports both versions of Kafka, is up and running.</p>
</li>
<li>
<p>The <code>Kafka.spec.kafka.config</code> does not contain options that are not supported by the Kafka version being downgraded to.</p>
</li>
<li>
<p>The <code>Kafka.spec.kafka.config</code> has a <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> that is supported by the Kafka version being downgraded to.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka cluster configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka <em>KAFKA-CONFIGURATION-FILE</em></code></pre>
</div>
</div>
</li>
<li>
<p>Change the <code>Kafka.spec.kafka.version</code> to specify the previous version.</p>
<div class="paragraph">
<p>For example, if downgrading from Kafka 2.8.0 to 2.7.0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 2.7.0 <b class="conum">(1)</b>
    config:
      log.message.format.version: "2.7" <b class="conum">(2)</b>
      inter.broker.protocol.version: "2.7" <b class="conum">(3)</b>
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Kafka version is changed to the previous version.</p>
</li>
<li>
<p>Message format version is unchanged.</p>
</li>
<li>
<p>Inter-broker protocol version is unchanged.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You must format the value of <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> as a string to prevent it from being interpreted as a floating point number.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If the image for the Kafka version is different from the image defined in <code>STRIMZI_KAFKA_IMAGES</code> for the Cluster Operator, update <code>Kafka.spec.kafka.image</code>.</p>
<div class="paragraph">
<p>See <a href="#con-versions-and-images-str">Kafka version and image mappings</a></p>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
<div class="paragraph">
<p>Check the update in the logs or by watching the pod state transitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl logs -f <em>CLUSTER-OPERATOR-POD-NAME</em> | grep -E "Kafka version downgrade from [0-9.]+ to [0-9.]+, phase ([0-9]+) of \1 completed"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pod -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the Cluster Operator logs for an <code>INFO</code> level message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Reconciliation #<em>NUM</em>(watch) Kafka(<em>NAMESPACE</em>/<em>NAME</em>): Kafka version downgrade from <em>FROM-VERSION</em> to <em>TO-VERSION</em>, phase 1 of 1 completed</code></pre>
</div>
</div>
</li>
<li>
<p>Downgrade all client applications (consumers) to use the previous version of the client binaries.</p>
<div class="paragraph">
<p>The Kafka cluster and clients are now using the previous Kafka version.</p>
</div>
</li>
<li>
<p>If you are reverting back to a version of Strimzi earlier than 0.22, which uses ZooKeeper for the storage of topic metadata, delete the internal topic store topics from the Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-admin -ti --image=quay.io/strimzi/kafka:0.26.0-kafka-2.8.0 --rm=true --restart=Never -- ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi-topic-operator-kstreams-topic-store-changelog --delete &amp;&amp; ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi_store_topic --delete</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./using.html#ref-topic-operator-store-str" target="_blank" rel="noopener">Topic Operator topic store</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-28 08:36:07 BST
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>