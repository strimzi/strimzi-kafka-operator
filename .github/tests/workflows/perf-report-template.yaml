name: Perf-report template

on:
  workflow_dispatch:
    inputs:
      performance_dir:
        description: "Path to performance results directory"
        required: false
        default: ".github/tests/inputs/perf-report/single-arch-both-operators"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      # Test the performance report generation step only (mocking download/upload steps)
      - id: perf-report
        uses: actions/github-script@v7
        env:
          PERF_DIR: ${{ github.event.inputs.performance_dir }}
        with:
          github-token: ${{ github.token }}
          script: |
            const { generatePerformanceReport } = require('./.github/actions/systemtests/run-perf-report/generate-report.js');
            const perfDir = process.env.PERF_DIR || 'systemtest/target/performance';
            const result = generatePerformanceReport(perfDir, core);
            core.setOutput('has_results', result.has_results);
            core.setOutput('summary', result.summary);
            core.setOutput('timestamp', result.timestamp);

      # Validate the generated report
      - name: Validate performance report
        shell: bash
        env:
          EXPECTED_OUTPUT_FILE: ${{ env.EXPECTED_OUTPUT_FILE }}
          EXPECTED_HAS_RESULTS: ${{ env.EXPECTED_HAS_RESULTS }}
        run: |
          SUMMARY='${{ steps.perf-report.outputs.summary }}'
          HAS_RESULTS='${{ steps.perf-report.outputs.has_results }}'

          echo "::group::Generated Summary"
          echo "$SUMMARY"
          echo "::endgroup::"

          echo "Has Results: $HAS_RESULTS"

          # Validate has_results flag if expectation is set
          if [[ -n "$EXPECTED_HAS_RESULTS" && "$HAS_RESULTS" != "$EXPECTED_HAS_RESULTS" ]]; then
            echo "❌ has_results mismatch: expected '$EXPECTED_HAS_RESULTS', got '$HAS_RESULTS'"
            exit 1
          fi

          # Compare with expected output file if provided
          if [[ -n "$EXPECTED_OUTPUT_FILE" ]]; then
            if [[ ! -f "$EXPECTED_OUTPUT_FILE" ]]; then
              echo "❌ Expected output file not found: $EXPECTED_OUTPUT_FILE"
              exit 1
            fi

            # Remove timestamp line (it varies between runs)
            ACTUAL_NO_TIMESTAMP=$(echo "$SUMMARY" | grep -v "^\*\*Test Run:\*\*")
            EXPECTED_NO_TIMESTAMP=$(grep -v "^\*\*Test Run:\*\*" "$EXPECTED_OUTPUT_FILE")

            if ! diff -u <(echo "$EXPECTED_NO_TIMESTAMP") <(echo "$ACTUAL_NO_TIMESTAMP"); then
              echo "❌ Output does not match expected file: $EXPECTED_OUTPUT_FILE"
              exit 1
            fi
          elif [[ "$HAS_RESULTS" == "true" && -z "$SUMMARY" ]]; then
            echo "❌ Summary is empty but has_results is true"
            exit 1
          fi

          echo "✅ Validation passed"
