name: "Setup Kind"
description: "Installs Kind and configures cluster"

inputs:
  architecture:
    description: "Architecture"
    required: false
    default: "amd64"
  registry:
    description: "Image used for Minikube Registry"
    required: false
    default: mirror.gcr.io/registry:2.8.3

runs:
  using: "composite"
  steps:
    - name: Cache registry Docker image
      id: cache-registry
      uses: actions/cache@v4
      with:
        path: /tmp/registry-image.tar
        key: registry-image

    - name: Load registry Docker image from cache
      if: steps.cache-registry.outputs.cache-hit == 'true'
      shell: bash
      run: |
        docker load -i /tmp/registry-image.tar

    - name: Pull and save registry Docker image if cache miss
      if: steps.cache-registry.outputs.cache-hit != 'true'
      shell: bash
      run: |
        docker pull ${{ inputs.registry }}
        docker save ${{ inputs.registry }} -o /tmp/registry-image.tar

    - name: Setup Kind
      shell: bash
      run: |
        ./.azure/scripts/setup-kind.sh "${{ inputs.architecture }}"
      env:
        REGISTRY_IMAGE: ${{ inputs.registry }}

    - name: Set DOCKER_REGISTRY
      shell: bash
      run: |
        echo "DOCKER_REGISTRY=$(hostname --ip-address | grep -oE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' | awk '$1 != "127.0.0.1" { print $1 }' | head -1):5001" >> $GITHUB_ENV
        echo "DOCKER_REGISTRY=localhost:5000" >> $GITHUB_ENV
