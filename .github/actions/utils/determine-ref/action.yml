name: "Determine checkout ref"
description: "Determines the correct ref to checkout based on event context"

outputs:
  ref:
    description: "The ref to checkout"
    value: ${{ steps.determine.outputs.ref }}
  sha:
    description: "The SHA to checkout"
    value: ${{ steps.determine.outputs.sha }}

runs:
  using: "composite"
  steps:
    - name: Determine ref and SHA
      id: determine
      uses: actions/github-script@v7
      with:
        script: |
          const {owner, repo} = context.repo;
          let ref, sha;

          if (context.eventName === 'pull_request') {
            // For PR events, use merge ref to test the merged state
            const prNumber = context.payload.pull_request.number;
            ref = `refs/pull/${prNumber}/merge`;
            sha = context.payload.pull_request.head.sha;
            core.info(`PR event detected: Using merge ref for PR #${prNumber}`);
            core.info(`Head SHA: ${sha}`);
          } else if (context.eventName === 'issue_comment' && context.payload.issue?.pull_request) {
            // For PR comments, fetch the PR to get head SHA
            const prNumber = context.payload.issue.number;
            ref = `refs/pull/${prNumber}/merge`;

            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });
            sha = pr.data.head.sha;

            core.info(`PR comment detected: Using merge ref for PR #${prNumber}`);
            core.info(`Head SHA: ${sha}`);
          } else {
            // For workflow_dispatch and other events, use the current branch
            ref = context.ref;
            sha = context.sha;
            core.info(`Standard event: Using current ref ${ref}`);
            core.info(`SHA: ${sha}`);
          }

          core.setOutput('ref', ref);
          core.setOutput('sha', sha);
          core.exportVariable('REF', ref);
          core.exportVariable('SHA', sha);