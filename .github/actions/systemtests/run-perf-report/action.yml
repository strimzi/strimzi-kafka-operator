name: Run Performance Report
description: Downloads artifacts, generates performance report, and posts results
inputs:
  ref:
    description: 'Git ref to checkout'
    required: true
  artifacts-pattern:
    description: 'Pattern for performance artifacts to download'
    required: false
    default: 'performance-results-*'
  artifacts-path:
    description: 'Path where artifacts should be downloaded'
    required: false
    default: 'systemtest/target/performance-artifacts'
runs:
  using: composite
  steps:
    - name: Download performance results
      uses: actions/download-artifact@v4
      with:
        pattern: ${{ inputs.artifacts-pattern }}
        path: ${{ inputs.artifacts-path }}
        # Each artifact gets its own subdirectory (not merged) to preserve arch-specific results

    - name: List downloaded artifacts
      shell: bash
      run: |
        echo "Downloaded artifacts:"
        find "${{ inputs.artifacts-path }}" -type f | head -n 20

    - name: Generate performance report
      id: generate_report
      uses: actions/github-script@v7
      env:
        PERF_DIR: ${{ inputs.artifacts-path }}
      with:
        github-token: ${{ github.token || 'dummy-token-for-local-testing' }}
        script: |
          const { generatePerformanceReport } = require('./.github/actions/systemtests/run-perf-report/generate-report.js');
          const perfDir = process.env.PERF_DIR || 'systemtest/target/performance';
          const result = generatePerformanceReport(perfDir, core);
          core.setOutput('has_results', result.has_results);
          core.setOutput('summary', result.summary);
          core.setOutput('timestamp', result.timestamp);

    - name: Add performance report comment
      if: ${{ steps.generate_report.outputs.has-results == 'true' }}
      uses: ./.github/actions/utils/add-comment
      with:
        commentMessage: |
          ${{ steps.generate_report.outputs.summary }}

    - name: Add performance report to job summary
      if: ${{ steps.generate_report.outputs.has-results == 'true' }}
      shell: bash
      env:
        SUMMARY_CONTENT: ${{ steps.generate_report.outputs.summary }}
      run: |
        echo "$SUMMARY_CONTENT" >> "$GITHUB_STEP_SUMMARY"

    - name: No results warning
      if: ${{ steps.generate_report.outputs.has-results == 'false' }}
      shell: bash
      env:
        WARNING_MESSAGE: "No performance results found in artifacts"
      run: |
        echo "::warning::$WARNING_MESSAGE"