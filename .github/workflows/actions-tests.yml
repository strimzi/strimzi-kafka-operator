name: Unit & Integration tests of Actions

on:
  pull_request:
    paths:
      - '.github/**'
  push:
    branches:
      - "main"

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: docker://rhysd/actionlint:latest
        with:
          args: -color

  test-parse-comment:
    needs:
      - lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      # Install dependencies
      - name: Install act
        run: |
          # Install act for workflow testing
          curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
          sudo install -m 0755 ./bin/act /usr/local/bin/act
          
      - name: Install yq
        uses: ./.github/actions/dependencies/install-yq

      # Test all parse-comment scenarios
      - name: Test parse-comment action scenarios
        run: |
          set -e
          
          SCENARIOS_FILE=".github/tests/scenarios/parse-comment.yaml"
          WORKFLOW=".github/tests/workflows/parse-comment-template.yaml"
          
          echo "ðŸ§ª Running parse-comment action tests..."
          echo "ðŸ“ Loading scenarios from: $SCENARIOS_FILE"
          
          # Get total number of scenarios
          TOTAL=$(yq eval '.scenarios | length' "$SCENARIOS_FILE")
          echo "ðŸ“Š Found $TOTAL test scenarios"
          echo
          
          # Initialize overall result tracker
          overall_result=true
          
          # Loop through each scenario
          for i in $(seq 0 $((TOTAL - 1))); do
            # Extract scenario details using yq
            id=$(yq eval ".scenarios[$i].id" "$SCENARIOS_FILE")
            description=$(yq eval ".scenarios[$i].description" "$SCENARIOS_FILE")
            event=$(yq eval ".scenarios[$i].event" "$SCENARIOS_FILE")
            fixture=$(yq eval ".scenarios[$i].fixture" "$SCENARIOS_FILE")
            
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ðŸ” Scenario $((i + 1))/$TOTAL: $id"
            echo "   Description: $description"
            echo "   Event: $event"
            echo "   Fixture: $fixture"
            
            # Build environment variables from expectations
            env_args=""
            
            # Get all expectation keys and build env vars
            expectation_keys=$(yq eval ".scenarios[$i].expectations | keys | .[]" "$SCENARIOS_FILE")
            for key in $expectation_keys; do
              value=$(yq eval ".scenarios[$i].expectations.$key" "$SCENARIOS_FILE")
              env_key="EXPECT_$(echo "$key" | tr '[:lower:]' '[:upper:]')"
              env_args="$env_args --env $env_key=\"$value\""
            done
            
            token_args="-s GITHUB_TOKEN=\"${{ secrets.GITHUB_TOKEN }}\""
            
            # Run act with the scenario
            echo "â–¶ï¸  Running test..."
            
            if eval "act '$event' -W '$WORKFLOW' -e '$fixture' -P ubuntu-latest=catthehacker/ubuntu:act-latest --pull=false $env_args $token_args"; then
              echo "âœ… $id passed"
            else
              echo "âŒ $id failed"
              overall_result=false
            fi
            # Print blank line for better readability
            echo
          done
          
          if [ "$overall_result" = "false" ]; then
            echo "There are some test âŒ. Please check the logs for more details." 
            exit 1
          fi
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸŽ‰ All $TOTAL parse-comment scenarios passed!"

  test-check-permissions:
    needs:
      - lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      # Install dependencies
      - name: Install act
        run: |
          # Install act for workflow testing
          curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
          sudo install -m 0755 ./bin/act /usr/local/bin/act
          
      - name: Install yq
        uses: ./.github/actions/dependencies/install-yq

      # Test all check-permissions scenarios
      - name: Test check-permissions action scenarios
        run: |
          set -e
          
          SCENARIOS_FILE=".github/tests/scenarios/check-permissions.yaml"
          WORKFLOW=".github/tests/workflows/check-permissions-template.yaml"
          
          echo "ðŸ” Running check-permissions action tests..."
          echo "ðŸ“ Loading scenarios from: $SCENARIOS_FILE"
          
          # Get total number of scenarios
          TOTAL=$(yq eval '.scenarios | length' "$SCENARIOS_FILE")
          echo "ðŸ“Š Found $TOTAL test scenarios"
          echo
          echo "âš ï¸  Note: These tests validate action structure and input handling."
          echo "   GitHub API permission checks depend on actual repository permissions."
          echo
          
          # Initialize overall result tracker
          overall_result=true
          
          # Loop through each scenario
          for i in $(seq 0 $((TOTAL - 1))); do
            # Extract scenario details using yq
            id=$(yq eval ".scenarios[$i].id" "$SCENARIOS_FILE")
            description=$(yq eval ".scenarios[$i].description" "$SCENARIOS_FILE")
            event=$(yq eval ".scenarios[$i].event" "$SCENARIOS_FILE")
            fixture=$(yq eval ".scenarios[$i].fixture" "$SCENARIOS_FILE")
            
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ðŸ” Scenario $((i + 1))/$TOTAL: $id"
            echo "   Description: $description"
            echo "   Event: $event"
            echo "   Fixture: $fixture"
            
            # Build environment variables from expectations
            env_args=""
            
            # Get all expectation keys and build env vars
            expectation_keys=$(yq eval ".scenarios[$i].expectations | keys | .[]" "$SCENARIOS_FILE")
            for key in $expectation_keys; do
              value=$(yq eval ".scenarios[$i].expectations.$key" "$SCENARIOS_FILE")
              env_key="EXPECT_$(echo "$key" | tr '[:lower:]' '[:upper:]')"
              env_args="$env_args --env $env_key=\"$value\""
            done
            
            # Extract actor from event fixture for proper GITHUB_ACTOR override
            actor=$(yq eval '.actor' "$fixture")
            echo "   ðŸ‘¤ Actor from fixture: $actor"
            
            # Run act with the scenario
            echo "â–¶ï¸  Running test..."
            
            # Override GITHUB_ACTOR to match the actor in the event fixture
            actor_args="--env GITHUB_ACTOR=\"$actor\""
            token_args="-s GITHUB_TOKEN=\"${{ secrets.GITHUB_TOKEN }}\""
            
            if eval "act '$event' -W '$WORKFLOW' -e '$fixture' -P ubuntu-latest=catthehacker/ubuntu:act-latest --pull=false $env_args $actor_args $token_args"; then
              echo "âœ… $id completed"
            else
              echo "âŒ $id failed"
              overall_result=false
            fi
            # Print blank line for better readability
            echo
          done
          
          if [ "$overall_result" = "false" ]; then
            echo "There are some test âŒ. Please check the logs for more details." 
            exit 1
          fi
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸŽ‰ All $TOTAL check-permissions scenarios completed!"
          echo "   Action structure and input handling validated âœ…"

  test-generate-matrix:
    needs:
      - lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      # Install dependencies
      - name: Install act
        run: |
          # Install act for workflow testing
          curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
          sudo install -m 0755 ./bin/act /usr/local/bin/act

      - name: Install yq
        uses: ./.github/actions/dependencies/install-yq

      # Test all generate-matrix scenarios
      - name: Test generate-matrix action scenarios
        run: |
          set -e
          
          SCENARIOS_FILE=".github/tests/scenarios/generate-matrix.yaml"
          WORKFLOW=".github/tests/workflows/generate-matrix-template.yaml"
          
          echo "ðŸ§® Running generate-matrix action tests..."
          echo "ðŸ“ Loading scenarios from: $SCENARIOS_FILE"
          
          # Get total number of scenarios
          TOTAL=$(yq eval '.scenarios | length' "$SCENARIOS_FILE")
          echo "ðŸ“Š Found $TOTAL test scenarios"
          echo
          
          # Initialize overall result tracker
          overall_result=true
          
          # Loop through each scenario
          for i in $(seq 0 $((TOTAL - 1))); do
            # Extract scenario details using yq
            id=$(yq eval ".scenarios[$i].id" "$SCENARIOS_FILE")
            description=$(yq eval ".scenarios[$i].description" "$SCENARIOS_FILE")
            event=$(yq eval ".scenarios[$i].event" "$SCENARIOS_FILE")
            fixture=$(yq eval ".scenarios[$i].fixture" "$SCENARIOS_FILE")
            
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ðŸ” Scenario $((i + 1))/$TOTAL: $id"
            echo "   Description: $description"
            echo "   Event: $event"
            echo "   Fixture: $fixture"
            
            # Build environment variables from expectations
            env_args=""
            
            # Get all expectation keys and build env vars
            expectation_keys=$(yq eval ".scenarios[$i].expectations | keys | .[]" "$SCENARIOS_FILE")
            for key in $expectation_keys; do
              value=$(yq eval ".scenarios[$i].expectations.$key" "$SCENARIOS_FILE")
              env_key="EXPECT_$(echo "$key" | tr '[:lower:]' '[:upper:]')"
              env_args="$env_args --env $env_key=\"$value\""
            done
            
            # Run act with the scenario
            echo "â–¶ï¸  Running test..."
            
            token_args="-s GITHUB_TOKEN=\"${{ secrets.GITHUB_TOKEN }}\""
            
            if eval "act '$event' -W '$WORKFLOW' -e '$fixture' -P ubuntu-latest=catthehacker/ubuntu:act-latest --pull=false $env_args $token_args"; then
              echo "âœ… $id completed"
            else
              echo "âŒ $id failed"
              overall_result=false
            fi
            # Print blank line for better readability
            echo
          done
          
          if [ "$overall_result" = "false" ]; then
            echo "There are some test âŒ. Please check the logs for more details." 
            exit 1
          fi
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸŽ‰ All $TOTAL generate-matrix scenarios passed!"
          echo "   Matrix generation logic validated âœ…"

  test-validate-matrix:
    needs:
      - lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      # Install dependencies
      - name: Install act
        run: |
          # Install act for workflow testing
          curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
          sudo install -m 0755 ./bin/act /usr/local/bin/act

      - name: Install yq
        uses: ./.github/actions/dependencies/install-yq

      # Test all validate-matrix scenarios
      - name: Test validate-matrix action scenarios
        run: |
          set -e
          
          SCENARIOS_FILE=".github/tests/scenarios/validate-matrix.yaml"
          WORKFLOW=".github/tests/workflows/validate-matrix-template.yaml"
          
          echo "âœ… Running validate-matrix action tests..."
          echo "ðŸ“ Loading scenarios from: $SCENARIOS_FILE"
          
          # Get total number of scenarios
          TOTAL=$(yq eval '.scenarios | length' "$SCENARIOS_FILE")
          echo "ðŸ“Š Found $TOTAL test scenarios"
          echo
          
          # Initialize overall result tracker
          overall_result=true
          
          # Loop through each scenario
          for i in $(seq 0 $((TOTAL - 1))); do
            # Extract scenario details using yq
            id=$(yq eval ".scenarios[$i].id" "$SCENARIOS_FILE")
            description=$(yq eval ".scenarios[$i].description" "$SCENARIOS_FILE")
            event=$(yq eval ".scenarios[$i].event" "$SCENARIOS_FILE")
            matrix_file=$(yq eval ".scenarios[$i].matrix_file" "$SCENARIOS_FILE")
            
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ðŸ” Scenario $((i + 1))/$TOTAL: $id"
            echo "   Description: $description"
            echo "   Event: $event"
            echo "   Matrix file: $matrix_file"
            
            # Load matrix content from file and compact to single line
            if [[ -f "$matrix_file" ]]; then
              TEST_MATRIX=$(jq -c . "$matrix_file")
              echo "   âœ… Matrix loaded and compacted from file"
            else
              echo "   âŒ Matrix file not found: $matrix_file"
              overall_result=false
              continue
            fi
            
            # Build environment variables from expectations
            env_args="--env TEST_MATRIX='$TEST_MATRIX'"
            
            # Get all expectation keys and build env vars
            expectation_keys=$(yq eval ".scenarios[$i].expectations | keys | .[]" "$SCENARIOS_FILE")
            for key in $expectation_keys; do
              value=$(yq eval ".scenarios[$i].expectations.$key" "$SCENARIOS_FILE")
              env_key="EXPECT_$(echo "$key" | tr '[:lower:]' '[:upper:]')"
              env_args="$env_args --env $env_key=\"$value\""
            done
            
            # Run act with the scenario
            echo "â–¶ï¸  Running test..."
            
            token_args="-s GITHUB_TOKEN=\"${{ secrets.GITHUB_TOKEN }}\""
            
            if eval "act '$event' -W '$WORKFLOW' -P ubuntu-latest=catthehacker/ubuntu:act-latest --pull=false $env_args $token_args"; then
              echo "âœ… $id completed"
            else
              echo "âŒ $id failed"
              overall_result=false
            fi
            # Print blank line for better readability
            echo
          done
          
          if [ "$overall_result" = "false" ]; then
            echo "There are some test âŒ. Please check the logs for more details." 
            exit 1
          fi
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸŽ‰ All $TOTAL validate-matrix scenarios passed!"
          echo "   Matrix validation logic validated âœ…"

  test-perf-report:
    needs:
      - lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      # Install dependencies
      - name: Install act
        run: |
          # Install act for workflow testing
          curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
          sudo install -m 0755 ./bin/act /usr/local/bin/act

      - name: Install yq
        uses: ./.github/actions/dependencies/install-yq

      # Test all perf-report scenarios
      - name: Test perf-report action scenarios
        run: |
          set -e

          SCENARIOS_FILE=".github/tests/scenarios/perf-report.yaml"
          WORKFLOW=".github/tests/workflows/perf-report-template.yaml"

          echo "ðŸ“Š Running perf-report action tests..."
          echo "ðŸ“ Loading scenarios from: $SCENARIOS_FILE"

          # Get total number of scenarios
          TOTAL=$(yq eval '.scenarios | length' "$SCENARIOS_FILE")
          echo "ðŸ“Š Found $TOTAL test scenarios"
          echo

          # Initialize overall result tracker
          overall_result=true

          # Loop through each scenario
          for i in $(seq 0 $((TOTAL - 1))); do
            # Extract scenario details using yq
            id=$(yq eval ".scenarios[$i].id" "$SCENARIOS_FILE")
            description=$(yq eval ".scenarios[$i].description" "$SCENARIOS_FILE")
            event=$(yq eval ".scenarios[$i].event" "$SCENARIOS_FILE")
            perf_dir=$(yq eval ".scenarios[$i].inputs.performance_dir" "$SCENARIOS_FILE")
            expected_file=$(yq eval ".scenarios[$i].expectations.expected_output_file" "$SCENARIOS_FILE")
            expected_has_results=$(yq eval ".scenarios[$i].expectations.has_results" "$SCENARIOS_FILE")

            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ðŸ” Scenario $((i + 1))/$TOTAL: $id"
            echo "   Description: $description"
            echo "   Event: $event"
            echo "   Performance dir: $perf_dir"

            # Create a temporary event file with the performance_dir input
            EVENT_FILE=$(mktemp)
            cat > "$EVENT_FILE" <<EOF
          {
            "inputs": {
              "performance_dir": "$perf_dir"
            }
          }
          EOF

            # Run act with the scenario
            # Mount docker socket into the container so nested act can work
            echo "â–¶ï¸  Running test..."

            if act "$event" -W "$WORKFLOW" -e "$EVENT_FILE" \
                -P ubuntu-latest=catthehacker/ubuntu:act-latest \
                --pull=false \
                --env EXPECTED_OUTPUT_FILE="$expected_file" \
                --env EXPECTED_HAS_RESULTS="$expected_has_results"; then
              echo "âœ… $id passed"
            else
              echo "âŒ $id failed"
              overall_result=false
            fi

            # Clean up temporary event file
            rm "$EVENT_FILE"

            # Print blank line for better readability
            echo
          done

          if [ "$overall_result" = "false" ]; then
            echo "There are some test âŒ. Please check the logs for more details."
            exit 1
          fi

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸŽ‰ All $TOTAL perf-report scenarios passed!"
